import{isFunctionNode as e,isTokenNode as t,gatherNodeAncestry as i}from"@csstools/css-parser-algorithms";import{TokenType as r,NumberType as a,stringify as n}from"@csstools/css-tokenizer";import{invertComparison as o,MediaFeatureEQ as s,MediaFeatureLT as u,MediaFeatureGT as l,newMediaFeaturePlain as c,matchesRatioExactly as d,matchesRatio as f,isMediaFeatureRange as v,isMediaFeature as m,isMediaFeatureRangeNameValue as p,isMediaFeatureRangeValueName as h,isMediaInParens as g,MediaInParens as w,MediaAnd as N,MediaConditionListWithAnd as W,MediaCondition as b,isMediaConditionListWithAnd as x,isMediaAnd as P,isMediaCondition as y,isMediaQuery as O,parse as S}from"@csstools/media-query-list-parser";import{calcFromComponentValues as A}from"@csstools/css-calc";const C=/[A-Z]/g;const I={width:"px",height:"px","device-width":"px","device-height":"px","aspect-ratio":"","device-aspect-ratio":"",color:"","color-index":"",monochrome:"",resolution:"dpi"},M={width:!1,height:!1,"device-width":!1,"device-height":!1,"aspect-ratio":!1,"device-aspect-ratio":!1,color:!0,"color-index":!0,monochrome:!0,resolution:"dpi"};function featureNamePrefix(e){return e===u.LT||e===u.LT_OR_EQ?"max-":e===l.GT||e===l.GT_OR_EQ?"min-":""}const T={">":1,"<":-1},_=.001,L=.02;function transformSingleNameValuePair(i,n,v,m){let p=v.before,h=v.after;if(m||(p=v.after,h=v.before),!m){const e=o(n);if(!1===e)return;n=e}if(n===s.EQ||n===u.LT_OR_EQ||n===l.GT_OR_EQ)return Array.isArray(v.value)?c(featureNamePrefix(n)+i,...p,...v.value.flatMap((e=>e.tokens())),...h):c(featureNamePrefix(n)+i,...p,...v.value.tokens(),...h);let g,w,N=!1;if(Array.isArray(v.value)){if(!d(v.value))return;if("aspect-ratio"!==i&&"device-aspect-ratio"!==i)return;const e=f(v.value);if(-1===e)return;N=!0,g=v.value[e[0]],w=v.value.slice(e[0]+1)}else g=v.value,w=[];const W=I[i.toLowerCase()];if(e(g)&&"calc"===g.getName().toLowerCase()){const[[e]]=A([[g]],{precision:5,toCanonicalUnits:!0});if(!e||!t(e)||e.value[0]!==r.Number&&e.value[0]!==r.Percentage&&e.value[0]!==r.Dimension||!Number.isInteger(e.value[4].value)){let e;if(void 0!==W){const t=T[n]*("px"===W?L:_);e=[r.Dimension,`${t.toString()}${W}`,-1,-1,{value:t,unit:W,type:a.Integer}]}else if(!0===M[i]){const t=T[n];e=[r.Number,t.toString(),-1,-1,{value:t,type:a.Integer}]}else if(N){const t=T[n]*_;e=[r.Number,t.toString(),-1,-1,{value:t,type:a.Integer}]}else{const t=T[n];e=[r.Number,t.toString(),-1,-1,{value:t,type:a.Integer}]}return N?c(featureNamePrefix(n)+i,...p,[r.Function,"calc(",-1,-1,{value:"calc("}],[r.OpenParen,"(",-1,-1,void 0],...g.tokens().slice(1),[r.Whitespace," ",-1,-1,void 0],[r.Delim,"+",-1,-1,{value:"+"}],[r.Whitespace," ",-1,-1,void 0],e,[r.CloseParen,")",-1,-1,void 0],[r.Whitespace," ",-1,-1,void 0],...w.flatMap((e=>e.tokens())),...h):c(featureNamePrefix(n)+i,...p,[r.Function,"calc(",-1,-1,{value:"calc("}],[r.OpenParen,"(",-1,-1,void 0],...g.tokens().slice(1),[r.Whitespace," ",-1,-1,void 0],[r.Delim,"+",-1,-1,{value:"+"}],[r.Whitespace," ",-1,-1,void 0],e,[r.CloseParen,")",-1,-1,void 0],...h)}g=e}if(t(g)){let e,t=g.value,o="";if(void 0!==W&&t[0]===r.Number&&0===t[4].value)e=T[n],o=W;else if(t[0]===r.Number&&0===t[4].value)e=T[n],o="";else if(t[0]===r.Dimension&&0===t[4].value)e=T[n],o=t[4].unit;else if(t[0]===r.Number&&!0===M[i])e=t[4].value+T[n];else if(t[0]===r.Dimension&&"px"===t[4].unit&&t[4].type===a.Integer)e=Number(Math.round(Number(t[4].value+L*T[n]+"e6"))+"e-6");else{if(t[0]!==r.Dimension&&t[0]!==r.Number)return;e=Number(Math.round(Number(t[4].value+_*T[n]+"e6"))+"e-6")}return o&&(t=[r.Dimension,t[1],t[2],t[3],{value:t[4].value,unit:o,type:t[4].type}]),t[4].value=e,t[0]===r.Dimension?t[1]=t[4].value.toString()+t[4].unit:t[1]=t[4].value.toString(),N?c(featureNamePrefix(n)+i,...p,t,[r.Whitespace," ",-1,-1,void 0],...w.flatMap((e=>e.tokens())),...h):c(featureNamePrefix(n)+i,...p,t,...h)}}const Q=new Set(["aspect-ratio","color","color-index","device-aspect-ratio","device-height","device-width","height","horizontal-viewport-segments","monochrome","resolution","vertical-viewport-segments","width"]);function transform(e){return e.map(((e,t)=>{const a=i(e);e.walk((t=>{const i=t.node;if(!v(i))return;const n=t.parent;if(!m(n))return;const o=i.name.getName().replace(C,(e=>String.fromCharCode(e.charCodeAt(0)+32)));if(!Q.has(o))return;if(p(i)||h(i)){const e=i.operatorKind();if(!1===e)return;const t=transformSingleNameValuePair(o,e,i.value,p(i));return void(t&&(n.feature=t.feature))}const s=a.get(n);if(!g(s))return;let l=null,c=null;{const e=i.valueOneOperatorKind();if(!1===e)return;const t=transformSingleNameValuePair(o,e,i.valueOne,!1);if(!t)return;e===u.LT||e===u.LT_OR_EQ?(l=t,l.before=n.before):(c=t,c.after=n.after)}{const e=i.valueTwoOperatorKind();if(!1===e)return;const t=transformSingleNameValuePair(o,e,i.valueTwo,!0);if(!t)return;e===u.LT||e===u.LT_OR_EQ?(c=t,c.before=n.before):(l=t,l.after=n.after)}if(!l||!c)return;const d=new w(l),f=new w(c),x=getMediaConditionListWithAndFromAncestry(s,a);if(x)return x.leading===s?(x.leading=d,void(x.list=[new N([[r.Whitespace," ",-1,-1,void 0],[r.Ident,"and",-1,-1,{value:"and"}],[r.Whitespace," ",-1,-1,void 0]],f),...x.list])):void x.list.splice(x.indexOf(a.get(s)),1,new N([[r.Whitespace," ",-1,-1,void 0],[r.Ident,"and",-1,-1,{value:"and"}],[r.Whitespace," ",-1,-1,void 0]],d),new N([[r.Whitespace," ",-1,-1,void 0],[r.Ident,"and",-1,-1,{value:"and"}],[r.Whitespace," ",-1,-1,void 0]],f));const P=new W(d,[new N([[r.Whitespace," ",-1,-1,void 0],[r.Ident,"and",-1,-1,{value:"and"}],[r.Whitespace," ",-1,-1,void 0]],f)],[[r.Whitespace," ",-1,-1,void 0]]),y=getMediaConditionInShallowMediaQueryFromAncestry(s,e,a);y?y.media=P:s.media=new b(new w(new b(P),[[r.Whitespace," ",-1,-1,void 0],[r.OpenParen,"(",-1,-1,void 0]],[[r.CloseParen,")",-1,-1,void 0]]))}));const o=e.tokens();return n(...o.filter(((e,i)=>(0!==i||0!==t||e[0]!==r.Whitespace)&&(e[0]!==r.Whitespace||!o[i+1]||o[i+1][0]!==r.Whitespace))))})).join(",")}function getMediaConditionListWithAndFromAncestry(e,t){let i=e;if(i){if(i=t.get(i),x(i))return i;if(P(i))return i=t.get(i),x(i)?i:void 0}}function getMediaConditionInShallowMediaQueryFromAncestry(e,t,i){let r=e;if(!r)return;if(r=i.get(r),!y(r))return;const a=r;return r=i.get(r),O(r)&&r===t?a:void 0}const creator=()=>({postcssPlugin:"postcss-media-minmax",AtRule:{media:e=>{if(!(e.params.includes("<")||e.params.includes(">")||e.params.includes("=")))return;const t=transform(S(e.params,{preserveInvalidMediaQueries:!0,onParseError:()=>{throw e.error(`Unable to parse media query "${e.params}"`)}}));e.params!==t&&(e.params=t)}}});creator.postcss=!0;export{creator as default};
