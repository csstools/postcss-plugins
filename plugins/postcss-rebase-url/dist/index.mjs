import{tokenize as e,TokenType as r}from"@csstools/css-tokenizer";import{parseCommaSeparatedListOfComponentValues as t,replaceComponentValues as i,isTokenNode as s,isFunctionNode as o,isWhitespaceNode as a,isCommentNode as n,stringify as u}from"@csstools/css-parser-algorithms";import l from"path";const c=/^([-_a-z0-9]+:)?\/\//i;function rebase(e,r,t){if(e.startsWith("data:"))return!1;if(c.test(e))return!1;if(e.startsWith("/"))return e;if(e.startsWith("#"))return e;try{const r=new URL(e);if(r.port||r.protocol)return!1}catch{}const i=l.posix.resolve(l.posix.join(r,e));return l.posix.relative(t,i)}function serializeString(e){let r="";for(const t of e){const e=t.codePointAt(0);if(void 0!==e)switch(e){case 0:r+=String.fromCodePoint(65533);break;case 127:r+=`\\${e.toString(16)}`;break;case 34:case 39:case 92:r+=`\\${t}`;break;default:if(1<=e&&e<=31){r+=`\\${e.toString(16)} `;break}r+=t}else r+=String.fromCodePoint(65533)}return r}function normalizedDir(e){return l.parse(l.resolve(e.trim())).dir.split(l.sep).join(l.posix.sep)}const f=/^initial-value$/i,p=/^property$/i,v=/^syntax$/i,m=/url\(/i,d=/^url$/i,g=/<url>/i,creator=()=>({postcssPlugin:"postcss-rebase-url",prepare(){const l=new WeakSet,c=new Set;return{Once(e){e.walkAtRules(p,(e=>{if(!e.nodes)return;const r=e.nodes.find((e=>{if("decl"===e.type&&v.test(e.prop))return!0}));r&&g.test(r.value)&&c.add(e.params.trim())}))},Declaration(v,{result:g}){if(l.has(v))return;if(v.variable&&!c.has(v.prop))return;if(f.test(v.prop)&&"atrule"===v.parent?.type&&p.test(v.parent.name))return;const{from:b}=g.opts;if(!b)return;if(!v.source?.input.from)return;if(!m.test(v.value))return;const S=normalizedDir(b),h=v.source.input.from.trim();if(!h)return;const $=normalizedDir(h),k=t(e({css:v.value})),z=i(k,(e=>{if(s(e)&&e.value[0]===r.URL){const r=rebase(e.value[4].value.trim(),$,S);if(r)return e.value[4].value=r,e.value[1]=`url(${serializeString(r)})`,e}if(o(e)&&d.test(e.getName()))for(const t of e.value)if(!a(t)&&!n(t)&&s(t)&&t.value[0]===r.String){const r=rebase(t.value[4].value.trim(),$,S);if(r)return t.value[4].value=r,t.value[1]=`"${serializeString(r)}"`,e;break}})),x=u(z);x!==v.value&&(v.value=x,l.add(v))}}}});creator.postcss=!0;export{creator as default};
