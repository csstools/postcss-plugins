"use strict";var e=require("@csstools/cascade-layer-name-parser"),t=require("@csstools/custom-function-parser"),n=require("@csstools/css-parser-algorithms"),r=require("@csstools/css-tokenizer");const s=e.parse("csstools-implicit-layer")[0];function collectCascadeLayerOrder(t){const n=new Map,r=new Map,o=[];t.walkAtRules((t=>{if("layer"!==t.name.toLowerCase())return;{let e=t.parent;for(;e;){if("atrule"!==e.type||"layer"!==e.name.toLowerCase()){if(e===t.root())break;return}e=e.parent}}let a;if(t.nodes)a=normalizeLayerName(t.params,1);else{if(!t.params.trim())return;a=t.params}let i=e.parse(a);if(i?.length){{let e=t.parent;for(;e&&"atrule"===e.type&&"layer"===e.name.toLowerCase();){const t=r.get(e);t?(i=i.map((e=>t.concat(e))),e=e.parent):e=e.parent}}if(e.addLayerToModel(o,i),t.nodes){const e=i[0].concat(s);n.set(t,e),r.set(t,i[0])}}}));for(const t of n.values())e.addLayerToModel(o,[t]);const a=new WeakMap;for(const[e,t]of n)a.set(e,o.findIndex((e=>t.equal(e))));return a}function normalizeLayerName(e,t){return e.trim()?e:"csstools-anon-layer--"+t++}const o=new Set(["scope","container","layer"]),a=/^function$/i;function isProcessableRule(e){if(!a.test(e.name))return!1;if(!e.params||!e.params.includes("--"))return!1;if(!e.nodes?.length)return!1;let t=e.parent;for(;t;){if("atrule"===t.type&&!o.has(t.name.toLowerCase()))return!1;t=t.parent}return!0}function getCustomFunctions(e,n,r){const s=new Map,o=new Map,a=collectCascadeLayerOrder(e);return e.walkAtRules((e=>{if(!isProcessableRule(e))return;const i=e.params.trim(),u=t.parse(i,{onParseError:t=>{e.warn(n,`Failed to parse custom function : "${e.params}" with message: "${t instanceof Error?t.message:t}"`)}});if(!u)return;const c=u.getName(),l=(m=a,(p=e).parent&&"atrule"===p.parent.type&&"layer"===p.parent.name.toLowerCase()?m.has(p.parent)?m.get(p.parent)+1:0:1e7);var p,m;const d=o.get(c)??-1;if(l&&l>=d&&(o.set(c,l),s.set(c,{node:e,function:u})),!r.preserve){const t=e.parent;e.remove(),removeEmptyAncestorBlocks(t)}})),s}function removeEmptyAncestorBlocks(e){if(!e)return;let t=e;for(;t;){if(t.nodes&&t.nodes.length>0)return;const e=t.parent;t.remove(),t=e}}const i=/--.*?\(/i,creator=e=>{const t=Object.assign({preserve:!1},e);return{postcssPlugin:"postcss-custom-functions",prepare(){let e=new Map;const s=[];return{postcssPlugin:"postcss-custom-functions",Once(n,{result:r}){e=getCustomFunctions(n,r,{preserve:t.preserve})},OnceExit(e){s.forEach((t=>{t.registrations.forEach((t=>{e.append(t)}))}))},Declaration(o,{atRule:a}){if(!i.test(o.value))return;const u=o.parent;if(!u)return;const c=r.tokenize({css:o.value});if(!c.some((e=>r.isTokenFunction(e)&&e[4].value.startsWith("--"))))return;const l=n.replaceComponentValues([n.parseListOfComponentValues(c)],(t=>{if(!n.isFunctionNode(t))return;const i=t.getName();if(!i.startsWith("--"))return;const c=e.get(i);if(!c)return;const l=new CallingContext(u,u,o,t,c.function,c.node,a);return l.invalid?new n.FunctionNode([r.TokenType.Function,"var(",-1,-1,{value:"var"}],[r.TokenType.CloseParen,")",-1,-1,void 0],[]):(u.before(l.argumentRule),u.before(l.bodyRule),s.push(l),new n.FunctionNode([r.TokenType.Function,"var(",-1,-1,{value:"var"}],[r.TokenType.CloseParen,")",-1,-1,void 0],[new n.TokenNode([r.TokenType.Ident,l.resultIdent,-1,-1,{value:l.resultIdent}])]))})),p=n.stringify(l);p!==o.value&&(o.cloneBefore({value:p}),t?.preserve||o.remove())}}}}};function generateDashedIdent(e,t,n){return`--csstools-${[e,n,t].filter((e=>!!e)).join("-")}`}creator.postcss=!0;class CallingContext{static counter=0;id;rootElement;element;property;parent=null;function;customFunction;customFunctionBody;registrations=[];argumentRule;bodyRule;resultIdent;varCounter=0;invalid=!1;constructor(e,t,r,s,o,a,i,u=null){this.id=(CallingContext.counter++).toString(36),this.rootElement=e,this.element=t,this.property=r,this.function=s,this.customFunction=o,this.customFunctionBody=a,this.parent=u;{const e=(++this.varCounter).toString(36);this.resultIdent=generateDashedIdent("custom-function-call",e,this.id);const t=n.parseCommaSeparatedListOfComponentValues(this.function.value.flatMap((e=>e.tokens())));t.length>this.customFunction.parameters.length&&(this.invalid=!0),this.customFunction.parameters.forEach((e=>{const t=e.getName(),n=e.getArgumentType()||"*",r=i({name:"property",params:generateDashedIdent("function-argument",t,this.id),nodes:[this.property.clone({prop:"syntax",value:`"${n}"`}),this.property.clone({prop:"inherit",value:"false"})],source:this.property.source});this.registrations.push(r);const s=i({name:"property",params:generateDashedIdent("function-body",t,this.id),nodes:[this.property.clone({prop:"syntax",value:'"*"'}),this.property.clone({prop:"inherit",value:"false"})],source:this.property.source});this.registrations.push(s)}));const r=this.customFunction.getReturnType();if(r){const e=i({name:"property",params:generateDashedIdent("return-value","",this.id),nodes:[this.property.clone({prop:"syntax",value:`"${r}"`}),this.property.clone({prop:"inherit",value:"false"})],source:this.property.source});this.registrations.push(e)}this.argumentRule=this.element.clone({nodes:[]}),this.customFunction.parameters.forEach(((e,r)=>{const s=e.getName();e.getDefaultValue()&&this.argumentRule.append(this.property.clone({prop:generateDashedIdent("function-argument",s,this.id),value:e.getDefaultValue()}));const o=t[r];o&&this.argumentRule.append(this.property.clone({prop:generateDashedIdent("function-argument",s,this.id),value:n.stringify([o])}))})),this.bodyRule=this.element.clone({nodes:[...this.customFunctionBody.nodes?.map((e=>e.clone()))??[]]}),this.bodyRule.walkDecls(/^result$/i,(e=>{e.prop=this.resultIdent}))}}}module.exports=creator;
