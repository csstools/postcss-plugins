"use strict";var e=require("@csstools/css-tokenizer"),o=require("@csstools/css-parser-algorithms"),a=require("@csstools/css-color-parser");const t=/\bcolor-gamut\b/i;function hasConditionalAncestor(e){let o=e.parent;for(;o;)if("atrule"===o.type){if("media"===o.name.toLowerCase()&&t.test(o.params))return!0;o=o.parent}else o=o.parent;return!1}function hasOverrideOrFallback(e){var o;const a=e.prop.toLowerCase();let t=!1,r=!1;const s=(null==(o=e.parent)?void 0:o.nodes)??[],n=s.indexOf(e);for(let e=0;e<s.length;e++){if(e===n)continue;const o=s[e];if("decl"===o.type&&o.prop.toLowerCase()===a){if(!(e<n)){t=!0;break}r=!0,e=n}}return{hasOverride:t,hasFallback:r}}const r=/\b(?:color|lab|lch|oklab|oklch)\(/i,s=/^(?:color|lab|lch|oklab|oklch)$/i,creator=()=>({postcssPlugin:"postcss-gamut-mapping",prepare(){const t=new WeakMap;return{OnceExit:(n,{postcss:l})=>{n.walkDecls((n=>{const i=n.value;if(!r.test(i))return;if(!n.parent||hasConditionalAncestor(n))return;const{hasOverride:c,hasFallback:u}=hasOverrideOrFallback(n);if(c)return;const p=t.get(n.parent)||{conditionalRules:[],propNames:new Set,lastConditionParams:{media:void 0},lastConditionalRule:void 0};t.set(n.parent,p);let d=!1;const m=o.replaceComponentValues(o.parseCommaSeparatedListOfComponentValues(e.tokenize({css:i})),(e=>{if(o.isFunctionNode(e)&&s.test(e.getName())){const o=a.color(e);if(!o)return;if(o.syntaxFlags.has(a.SyntaxFlag.HasNoneKeywords))return;if(a.colorDataFitsRGB_Gamut(o))return;return d||a.colorDataFitsDisplayP3_Gamut(o)||(d=!0),a.serializeRGB(o,!0)}})),f=o.stringify(m);if(f===i)return;const h=`(color-gamut: ${d?"rec2020":"p3"})`;if(p.lastConditionParams.media!==h&&(p.lastConditionalRule=void 0),p.lastConditionalRule)return u||n.cloneBefore({value:f}),p.lastConditionalRule.append(n.clone()),void n.remove();u||n.cloneBefore({value:f});const v=l.atRule({name:"media",params:h,source:n.parent.source,raws:{before:"\n\n",after:"\n"}}),C=n.parent.clone();C.removeAll(),C.raws.before="\n",C.append(n.clone()),n.remove(),p.lastConditionParams.media=v.params,p.lastConditionalRule=C,v.append(C),p.conditionalRules.push(v)})),n.walk((e=>{const o=t.get(e);o&&0!==o.conditionalRules.length&&o.conditionalRules.reverse().forEach((o=>{e.after(o)}))}))}}}});creator.postcss=!0,module.exports=creator;
