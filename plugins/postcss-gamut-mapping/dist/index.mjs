import{tokenize as e}from"@csstools/css-tokenizer";import{replaceComponentValues as o,parseCommaSeparatedListOfComponentValues as t,isFunctionNode as a,stringify as r}from"@csstools/css-parser-algorithms";import{color as n,SyntaxFlag as s,colorDataFitsRGB_Gamut as l,colorDataFitsDisplayP3_Gamut as i,serializeRGB as c}from"@csstools/css-color-parser";const p=/\bcolor-gamut\b/i;function hasConditionalAncestor(e){let o=e.parent;for(;o;)if("atrule"===o.type){if("media"===o.name.toLowerCase()&&p.test(o.params))return!0;o=o.parent}else o=o.parent;return!1}function hasOverrideOrFallback(e){var o;const t=e.prop.toLowerCase();let a=!1,r=!1;const n=(null==(o=e.parent)?void 0:o.nodes)??[],s=n.indexOf(e);for(let e=0;e<n.length;e++){if(e===s)continue;const o=n[e];if("decl"===o.type&&o.prop.toLowerCase()===t){if(!(e<s)){a=!0;break}r=!0,e=s}}return{hasOverride:a,hasFallback:r}}const u=/\b(?:color|lab|lch|oklab|oklch)\(/i,d=/^(?:color|lab|lch|oklab|oklch)$/i,creator=()=>({postcssPlugin:"postcss-gamut-mapping",prepare(){const p=new WeakMap;return{OnceExit:(f,{postcss:m})=>{f.walkDecls((f=>{const h=f.value;if(!u.test(h))return;if(!f.parent||hasConditionalAncestor(f))return;const{hasOverride:v,hasFallback:b}=hasOverrideOrFallback(f);if(v)return;const k=p.get(f.parent)||{conditionalRules:[],propNames:new Set,lastConditionParams:{media:void 0},lastConditionalRule:void 0};p.set(f.parent,k);let C=!1;const g=o(t(e({css:h})),(e=>{if(a(e)&&d.test(e.getName())){const o=n(e);if(!o)return;if(o.syntaxFlags.has(s.HasNoneKeywords))return;if(l(o))return;return C||i(o)||(C=!0),c(o,!0)}})),w=r(g);if(w===h)return;const R=`(color-gamut: ${C?"rec2020":"p3"})`;if(k.lastConditionParams.media!==R&&(k.lastConditionalRule=void 0),k.lastConditionalRule)return b||f.cloneBefore({value:w}),k.lastConditionalRule.append(f.clone()),void f.remove();b||f.cloneBefore({value:w});const O=m.atRule({name:"media",params:R,source:f.parent.source,raws:{before:"\n\n",after:"\n"}}),F=f.parent.clone();F.removeAll(),F.raws.before="\n",F.append(f.clone()),f.remove(),k.lastConditionParams.media=O.params,k.lastConditionalRule=F,O.append(F),k.conditionalRules.push(O)})),f.walk((e=>{const o=p.get(e);o&&0!==o.conditionalRules.length&&o.conditionalRules.reverse().forEach((o=>{e.after(o)}))}))}}}});creator.postcss=!0;export{creator as default};
