import o from"@csstools/postcss-progressive-custom-properties";import{WhitespaceNode as e,TokenNode as t,FunctionNode as r,isCommentNode as s,isWhitespaceNode as n,isTokenNode as i,stringify as l,replaceComponentValues as a,parseCommaSeparatedListOfComponentValues as c,isFunctionNode as u}from"@csstools/css-parser-algorithms";import{serializeP3 as p,color as v,colorDataFitsRGB_Gamut as f,serializeRGB as h}from"@csstools/css-color-parser";import{TokenType as d,tokenize as g}from"@csstools/css-tokenizer";const m=/(repeating-)?(linear|radial|conic)-gradient\(/i,w=/^(repeating-)?(linear|radial|conic)-gradient$/i;function hasFallback(o){const e=o.parent;if(!e)return!1;const t=o.prop.toLowerCase(),r=e.index(o);for(let o=0;o<r;o++){const r=e.nodes[o];if("decl"===r.type&&r.prop.toLowerCase()===t)return!0}return!1}function hasSupportsAtRuleAncestor(o){let e=o.parent;for(;e;)if("atrule"===e.type){if("supports"===e.name&&m.test(e.params))return!0;e=e.parent}else e=e.parent;return!1}function interpolateColorsInColorStopsList(o,s,n){const i=[],l=[];for(let i=0;i<o.length-1;i++){const a=o[i],c=o[i+1];if(l.push(a),p(a.colorData).toString()!==p(c.colorData).toString()&&a.position.toString()!==c.position.toString())for(let o=1;o<=9;o++){const i=10*o;let u=[];n&&(u=[new e([[d.Whitespace," ",-1,-1,void 0]]),n,new e([[d.Whitespace," ",-1,-1,void 0]]),new t([d.Ident,"hue",-1,-1,{value:"hue"}])]);const p=new r([d.Function,"color-mix(",-1,-1,{value:"color-mix"}],[d.CloseParen,")",-1,-1,void 0],[new t([d.Ident,"in",-1,-1,{value:"in"}]),new e([[d.Whitespace," ",-1,-1,void 0]]),s,...u,new t([d.Comma,",",-1,-1,void 0]),new e([[d.Whitespace," ",-1,-1,void 0]]),a.color,new e([[d.Whitespace," ",-1,-1,void 0]]),new t([d.Percentage,100-i+"%",-1,-1,{value:100-i}]),new t([d.Comma,",",-1,-1,void 0]),new e([[d.Whitespace," ",-1,-1,void 0]]),c.color,new e([[d.Whitespace," ",-1,-1,void 0]]),new t([d.Percentage,`${i}%`,-1,-1,{value:i}])]),f=v(p);if(!f)return!1;l.push({colorData:f})}i===o.length-2&&l.push(c)}for(let o=0;o<l.length;o++)f(l[o].colorData)?l[o].color=h(l[o].colorData):l[o].color=p(l[o].colorData);for(let o=0;o<l.length;o++){const r=l[o];r.position?i.push(r.color,new e([[d.Whitespace," ",-1,-1,void 0]]),r.position):i.push(r.color),o!==l.length-1&&i.push(new t([d.Comma,",",-1,-1,void 0]),new e([[d.Whitespace," ",-1,-1,void 0]]))}return i}function parseColorStops(o){const e=[];let t={};for(let r=0;r<o.length;r++){const l=o[r];if(s(l)||n(l))continue;if(i(l)&&l.value[0]===d.Comma){if(t.color&&t.colorData&&t.positionA){e.push({color:t.color,colorData:t.colorData,position:t.positionA}),t.positionB&&e.push({color:t.color,colorData:t.colorData,position:t.positionB}),t={};continue}return!1}const a=v(l);if(a&&t.color)return!1;if(a)t.color=l,t.colorData=a;else if(t.positionA){if(!t.positionA||t.positionB)return!1;t.positionB=l}else t.positionA=l}return!(!t.color||!t.positionA)&&(t.color&&t.colorData&&t.positionA&&(e.push({color:t.color,colorData:t.colorData,position:t.positionA}),t.positionB&&e.push({color:t.color,colorData:t.colorData,position:t.positionB})),!(e.length<2)&&e)}const C=/^(srgb|srgb-linear|lab|oklab|xyz|xyz-d50|xyz-d65|hsl|hwb|lch|oklch)$/i,D=/^(hsl|hwb|lch|oklch)$/i,b=/^(shorter|longer|increasing|decreasing)$/i,A=/^in$/i,x=/^hue$/i,basePlugin=o=>({postcssPlugin:"postcss-gradients-interpolation-method",Declaration(r){if(!m.test(r.value))return;if(hasFallback(r))return;if(hasSupportsAtRuleAncestor(r))return;const p=g({css:r.value}),v=l(a(c(p),(o=>{if(!u(o))return;const r=o.getName();if(!w.test(r))return;let l="srgb",a=null,c=null,p=null,v=null,f=null,h=[];{let e=0,t=o.value[e];for(;!i(t)||t.value[0]!==d.Ident||!A.test(t.value[4].value);){if(i(t)&&t.value[0]===d.Comma)return;e++,t=o.value[e]}for(a=t,e++,t=o.value[e];s(t)||n(t);)e++,t=o.value[e];if(i(t)&&t.value[0]===d.Ident&&C.test(t.value[4].value)){if(c)return;c=t,l=t.value[4].value,e++,t=o.value[e]}for(;s(t)||n(t);)e++,t=o.value[e];if(i(t)&&t.value[0]===d.Ident&&b.test(t.value[4].value)&&D.test(l)){if(p||!c)return;p=t,e++,t=o.value[e]}for(;s(t)||n(t);)e++,t=o.value[e];if(i(t)&&t.value[0]===d.Ident&&x.test(t.value[4].value)){if(v||!c||!p)return;v=t,e++,t=o.value[e]}for(;!i(t)||t.value[0]!==d.Comma;)e++,t=o.value[e];f=t,h=o.value.slice(e+1)}if(!c)return;if(p&&!v)return;if(v&&!p)return;const g=parseColorStops(h);if(!g)return;const m=interpolateColorsInColorStopsList(g,c,p);if(!m)return;const S=[...o.value.slice(0,o.value.indexOf(a)),...o.value.slice(o.value.indexOf(v||c)+1,o.value.indexOf(f))];S.length>0&&S.some((o=>!s(o)&&!n(o)))&&S.push(new t([d.Comma,",",-1,-1,void 0]),new e([[d.Whitespace," ",-1,-1,void 0]])),o.value=[...S,...m]})));v!==r.value&&(r.cloneBefore({value:v}),null!=o&&o.preserve||r.remove())}});basePlugin.postcss=!0;const postcssPlugin=e=>{const t=Object.assign({enableProgressiveCustomProperties:!0,preserve:!0},e);return t.enableProgressiveCustomProperties&&t.preserve?{postcssPlugin:"postcss-gradients-interpolation-method",plugins:[o(),basePlugin(t)]}:basePlugin(t)};postcssPlugin.postcss=!0;export{postcssPlugin as default};
