"use strict";var e=require("browserslist"),t=require("@csstools/css-tokenizer"),n=require("@csstools/css-parser-algorithms"),o=require("https"),r=require("path");function died(e){return"string"==typeof e}function matchBeforeDateCondition(e,t,n){const o=new Date;o.setUTCFullYear(e),o.setUTCMonth(t),o.setUTCDate(n);return(new Date).getTime()<o.getTime()||`Died because ${e}-${t}-${n} is in the past`}function matchBrowserslistCondition(t,n){const o=e(t);for(let e=0;e<o.length;e++){const t=o[e];if(n.has(t))return!0}return`Died because the browsers matching "${t}" do not have any overlap with your project browserslist`}function matchIfCondition(e){const n=e.a,o=e.b;if(n[0]===o[0]&&(n[0]!==t.TokenType.Dimension||o[0]!==t.TokenType.Dimension||n[4].unit.toLowerCase()===o[4].unit.toLowerCase())){switch(e.operator){case"<":if(n[4].value>=o[4].value)return`Died because A (${n[1]}) is no longer less than B (${o[1]})`;break;case">":if(n[4].value<=o[4].value)return`Died because A (${n[1]}) is no longer greater than B (${o[1]})`;break;case"=":if(n[4].value!==o[4].value)return`Died because A (${n[1]}) is no longer equal to B (${o[1]})`}return!0}}async function matchIssueOpenCondition(e,t,n){const o=`github-issue-open:${e}:${t}`;let r;if(!n.has(o))try{r=await fetch(e,t)}catch(e){return}return"closed"===r?(n.set(o,r),`Died because issue ${t} in ${e} was closed`):"open"===r?(n.set(o,r),!0):void 0}function fetch(e,t){return new Promise(((n,s)=>{let i=!1;const a=new URL(r.join("repos",e,"issues",t.toString()),"https://api.github.com/"),u={headers:{"User-Agent":"PostCSS TODO or Die"},timeout:15e3};process.env.GITHUB_TOKEN&&(u.headers.Authorization=`Bearer ${process.env.GITHUB_TOKEN}`);const c=o.request(a,u,(e=>{if(i)return;if(200!==e.statusCode)return i=!0,void s(new Error("Failed to fetch issue status"));let t="";e.on("data",(e=>{i||(t+=e.toString())})),e.on("end",(()=>{if(!i)try{const e=JSON.parse(t);return void n(e.state)}catch(e){return i=!0,void s(e)}}))}));c.on("timeout",(()=>{c.destroy()})),c.on("error",(e=>{i||(i=!0,s(e))})),c.end()}))}function matchNotCondition(e){const n=e.a,o=e.b;if(n[0]===o[0]&&(n[0]!==t.TokenType.Dimension||o[0]!==t.TokenType.Dimension||n[4].unit.toLowerCase()===o[4].unit.toLowerCase())){switch(e.operator){case"<":if(n[4].value<o[4].value)return`Died because A (${n[1]}) is less than B (${o[1]})`;break;case">":if(n[4].value>o[4].value)return`Died because A (${n[1]}) is greater than B (${o[1]})`;break;case"=":if(n[4].value===o[4].value)return`Died because A (${n[1]}) equals B (${o[1]})`}return!0}}function parseBeforeDateCondition(e){const o=e.value.filter((e=>!n.isWhitespaceNode(e)&&!n.isCommentNode(e)));if(o.length>3)return!1;const r=o[0],s=o[1],i=o[2];if(!r||!s||!i)return!1;if(!n.isTokenNode(r)||!n.isTokenNode(s)||!n.isTokenNode(i))return!1;const a=r.value,u=s.value,c=i.value;return a[0]===t.TokenType.Number&&a[4].type===t.NumberType.Integer&&(u[0]===t.TokenType.Number&&u[4].type===t.NumberType.Integer&&(c[0]===t.TokenType.Number&&c[4].type===t.NumberType.Integer&&{year:a[4].value,month:u[4].value,day:c[4].value}))}function parseBrowserslistCondition(e){const o=e.value.filter((e=>!n.isWhitespaceNode(e)&&!n.isCommentNode(e)));if(o.length>1)return!1;const r=o[0];if(!r)return!1;if(!n.isTokenNode(r))return!1;const s=r.value;return s[0]===t.TokenType.String&&s[4].value}const s=[t.TokenType.Ident,t.TokenType.Number,t.TokenType.Percentage,t.TokenType.Dimension],i=["<",">","="];function parseIfCondition(e){const o=e.value.filter((e=>!n.isWhitespaceNode(e)&&!n.isCommentNode(e)));if(o.length>3)return!1;const r=o[0],a=o[1],u=o[2];if(!r||!a||!u)return!1;if(!n.isTokenNode(r)||!n.isTokenNode(a)||!n.isTokenNode(u))return!1;const c=r.value,d=a.value,l=u.value;return d[0]===t.TokenType.Delim&&(!!i.includes(d[4].value)&&(!!s.includes(c[0])&&(!!s.includes(l[0])&&{a:c,b:l,operator:d[4].value})))}function parseIssueOpenCondition(e){const o=e.value.filter((e=>!n.isWhitespaceNode(e)&&!n.isCommentNode(e)));if(o.length>2)return!1;const r=o[0],s=o[1];if(!r||!s)return!1;if(!n.isTokenNode(r)||!n.isTokenNode(s))return!1;const i=r.value,a=s.value;return i[0]===t.TokenType.String&&(a[0]===t.TokenType.Number&&a[4].type===t.NumberType.Integer&&{repository:i[4].value,issue:a[4].value})}function parseNotCondition(e){const t=parseIfCondition(e);return!!t&&{a:t.a,b:t.b,operator:t.operator}}const creator=()=>{const o=new Set(e()),r=new Map;return{postcssPlugin:"postcss-todo-or-die",async Once(e,{result:s}){const i=[];e.walkAtRules((e=>{if("todo-or-die"===e.name.toLowerCase()){if(!e.params.trim())throw e.error("Rule must have valid params");i.push(e)}}));for(const e of i){const errorHandler=t=>{throw e.error(t.message)},i=t.tokenizer({css:e.params},{onParseError:errorHandler}),a=[];for(;!i.endOfFile();)a.push(i.nextToken());a.push(i.nextToken());const u=n.parseCommaSeparatedListOfComponentValues(a,{onParseError:errorHandler});if(!u.length)return void e.warn(s,"Rule must have some valid params.");for(let t=0;t<u.length;t++){const i=u[t].filter((e=>!n.isWhitespaceNode(e)&&!n.isCommentNode(e)));if(1!==i.length)return void e.warn(s,"Conditions must be split by commas when adding multiple in a list.");if(!n.isFunctionNode(i[0]))return void e.warn(s,"Conditions must be one of the supported functions.");switch(i[0].name[4].value.toLowerCase()){case"if":{const t=parseIfCondition(i[0]);if(!t)return void e.warn(s,"Incorrect arguments in `if()` function.");const n=matchIfCondition(t);if(died(n))throw e.error(n);break}case"not":{const t=parseNotCondition(i[0]);if(!t)return void e.warn(s,"Incorrect arguments in `not()` function.");const n=matchNotCondition(t);if(died(n))throw e.error(n);break}case"browserslist":{const t=parseBrowserslistCondition(i[0]);if(!t)return void e.warn(s,"Incorrect arguments in `browserslist()` function.");const n=matchBrowserslistCondition(t,o);if(died(n))throw e.error(n);break}case"before-date":{const t=parseBeforeDateCondition(i[0]);if(!t)return void e.warn(s,"Incorrect arguments in `before-date()` function.");const n=matchBeforeDateCondition(t.year,t.month,t.day);if(died(n))throw e.error(n);break}case"issue-open":{const t=parseIssueOpenCondition(i[0]);if(!t)return void e.warn(s,"Incorrect arguments in `issue-open()` function.");const n=await matchIssueOpenCondition(t.repository,t.issue,r);if(died(n))throw e.error(n);break}}}e.nodes&&e.nodes.length?e.replaceWith(e.nodes):e.remove()}}}};creator.postcss=!0,module.exports=creator;
