"use strict";var e=require("@csstools/postcss-progressive-custom-properties"),n=require("postcss-value-parser"),r=require("@csstools/color-helpers");function hasFallback(e){const n=e.parent;if(!n)return!1;const r=n.index(e);for(let t=0;t<r;t++){const r=n.nodes[t];if("decl"===r.type&&r.prop.toLowerCase()===e.prop.toLowerCase())return!0}return!1}function hasSupportsAtRuleAncestor(e){let n=e.parent;for(;n;)if("atrule"===n.type){if("supports"===n.name.toLowerCase()){if(-1!==n.params.toLowerCase().indexOf("oklab("))return!0;if(-1!==n.params.toLowerCase().indexOf("oklch("))return!0}n=n.parent}else n=n.parent;return!1}function onCSSFunctionSRgb(e){const n=e.value.toLowerCase(),t=e.nodes.slice().filter((e=>"comment"!==e.type&&"space"!==e.type));let o=null;if("oklab"===n?o=oklabFunctionContents(t):"oklch"===n&&(o=oklchFunctionContents(t)),!o)return;e.value="rgb",transformAlpha(e,o.slash,o.alpha);const[s,u,a]=channelNodes(o),[i,l,c]=channelDimensions(o),d=("oklab"===n?r.conversions.OKLab_to_sRGB:r.conversions.OKLCH_to_sRGB)([i.number,l.number,c.number].map((e=>parseFloat(e))));e.nodes.splice(e.nodes.indexOf(s)+1,0,{sourceIndex:0,sourceEndIndex:1,value:",",type:"div",before:"",after:""}),e.nodes.splice(e.nodes.indexOf(u)+1,0,{sourceIndex:0,sourceEndIndex:1,value:",",type:"div",before:"",after:""}),replaceWith(e.nodes,s,{...s,value:String(d[0])}),replaceWith(e.nodes,u,{...u,value:String(d[1])}),replaceWith(e.nodes,a,{...a,value:String(d[2])})}function onCSSFunctionDisplayP3(e,t,o,s){const u=n.stringify(e),a=e.value.toLowerCase(),i=e.nodes.slice().filter((e=>"comment"!==e.type&&"space"!==e.type));let l=null;if("oklab"===a?l=oklabFunctionContents(i):"oklch"===a&&(l=oklchFunctionContents(i)),!l)return;if(i.length>3&&(!l.slash||!l.alpha))return;e.value="color";const[c,d,p]=channelNodes(l),[b,f,m]=channelDimensions(l),v="oklab"===a?r.conversions.OKLab_to_P3:r.conversions.OKLCH_to_P3,h=[b.number,f.number,m.number].map((e=>parseFloat(e))),[N,g]=v(h);!g&&s&&t.warn(o,`"${u}" is out of gamut for "display-p3". Given "preserve: true" is set, this will lead to unexpected results in some browsers.`),e.nodes.splice(0,0,{sourceIndex:0,sourceEndIndex:10,value:"display-p3",type:"word"}),e.nodes.splice(1,0,{sourceIndex:0,sourceEndIndex:1,value:" ",type:"space"}),replaceWith(e.nodes,c,{...c,value:N[0].toFixed(5)}),replaceWith(e.nodes,d,{...d,value:N[1].toFixed(5)}),replaceWith(e.nodes,p,{...p,value:N[2].toFixed(5)})}function isNumericNode(e){if(!e||"word"!==e.type)return!1;if(!canParseAsUnit(e))return!1;const r=n.unit(e.value);return!!r&&!!r.number}function isNumericNodeHueLike(e){if(!e||"word"!==e.type)return!1;if(!canParseAsUnit(e))return!1;const r=n.unit(e.value);if(!r)return!1;const t=r.unit.toLowerCase();return!!r.number&&("deg"===t||"grad"===t||"rad"===t||"turn"===t||""===t)}function isNumericNodePercentageOrNumber(e){if(!e||"word"!==e.type)return!1;if(!canParseAsUnit(e))return!1;const r=n.unit(e.value);return!!r&&("%"===r.unit||""===r.unit)}function isCalcNode(e){return e&&"function"===e.type&&"calc"===e.value.toLowerCase()}function isVarNode(e){return e&&"function"===e.type&&"var"===e.value.toLowerCase()}function isSlashNode(e){return e&&"div"===e.type&&"/"===e.value}function oklchFunctionContents(e){if(!isNumericNodePercentageOrNumber(e[0]))return null;if(!isNumericNodePercentageOrNumber(e[1]))return null;if(!isNumericNodeHueLike(e[2]))return null;const r={l:n.unit(e[0].value),lNode:e[0],c:n.unit(e[1].value),cNode:e[1],h:n.unit(e[2].value),hNode:e[2]};return normalizeHueNode(r.h),""!==r.h.unit?null:(isSlashNode(e[3])&&(r.slash=e[3]),(isNumericNodePercentageOrNumber(e[4])||isCalcNode(e[4])||isVarNode(e[4]))&&(r.alpha=e[4]),!(e.length>3)||r.slash&&r.alpha?("%"===r.l.unit&&(r.l.unit="",r.l.number=(parseFloat(r.l.number)/100).toFixed(10)),"%"===r.c.unit&&(r.c.unit="",r.c.number=(parseFloat(r.c.number)/100*.4).toFixed(10)),r):null)}function oklabFunctionContents(e){if(!isNumericNodePercentageOrNumber(e[0]))return null;if(!isNumericNodePercentageOrNumber(e[1]))return null;if(!isNumericNodePercentageOrNumber(e[2]))return null;const r={l:n.unit(e[0].value),lNode:e[0],a:n.unit(e[1].value),aNode:e[1],b:n.unit(e[2].value),bNode:e[2]};return isSlashNode(e[3])&&(r.slash=e[3]),(isNumericNodePercentageOrNumber(e[4])||isCalcNode(e[4])||isVarNode(e[4]))&&(r.alpha=e[4]),!(e.length>3)||r.slash&&r.alpha?("%"===r.l.unit&&(r.l.unit="",r.l.number=(parseFloat(r.l.number)/100).toFixed(10)),"%"===r.a.unit&&(r.a.unit="",r.a.number=(parseFloat(r.a.number)/100*.4).toFixed(10)),"%"===r.b.unit&&(r.b.unit="",r.b.number=(parseFloat(r.b.number)/100*.4).toFixed(10)),r):null}function isLab(e){return void 0!==e.a}function channelNodes(e){return isLab(e)?[e.lNode,e.aNode,e.bNode]:[e.lNode,e.cNode,e.hNode]}function channelDimensions(e){return isLab(e)?[e.l,e.a,e.b]:[e.l,e.c,e.h]}function transformAlpha(e,r,t){if(!r||!t)return;if(e.value="rgba",r.value=",",r.before="",!isNumericNode(t))return;const o=n.unit(t.value);o&&"%"===o.unit&&(o.number=String(parseFloat(o.number)/100),t.value=String(o.number))}function replaceWith(e,n,r){const t=e.indexOf(n);e[t]=r}function normalizeHueNode(e){switch(e.unit.toLowerCase()){case"deg":return void(e.unit="");case"rad":return e.unit="",void(e.number=(180*parseFloat(e.number)/Math.PI).toString());case"grad":return e.unit="",void(e.number=(.9*parseFloat(e.number)).toString());case"turn":return e.unit="",void(e.number=(360*parseFloat(e.number)).toString())}}function canParseAsUnit(e){if(!e||!e.value)return!1;try{return!1!==n.unit(e.value)}catch(e){return!1}}function modifiedValues(e,r,t,o){let s;try{s=n(e)}catch(n){r.warn(t,`Failed to parse value '${e}' as an oklab or oklch function. Leaving the original value intact.`)}if(void 0===s)return;s.walk((e=>{e.type&&"function"===e.type&&("oklab"!==e.value.toLowerCase()&&"oklch"!==e.value.toLowerCase()||onCSSFunctionSRgb(e))}));const u=String(s);if(u===e)return;const a=n(e);a.walk((e=>{e.type&&"function"===e.type&&("oklab"!==e.value.toLowerCase()&&"oklch"!==e.value.toLowerCase()||onCSSFunctionDisplayP3(e,r,t,o))}));return{rgb:u,displayP3:String(a)}}const basePlugin=e=>({postcssPlugin:"postcss-oklab-function",Declaration:(n,{result:r})=>{if(hasFallback(n))return;if(hasSupportsAtRuleAncestor(n))return;const t=n.value;if(!/(^|[^\w-])(oklab|oklch)\(/i.test(t.toLowerCase()))return;const o=modifiedValues(t,n,r,e.preserve);void 0!==o&&(e.preserve?(n.cloneBefore({value:o.rgb}),e.subFeatures.displayP3&&n.cloneBefore({value:o.displayP3})):(n.cloneBefore({value:o.rgb}),e.subFeatures.displayP3&&n.cloneBefore({value:o.displayP3}),n.remove()))}});basePlugin.postcss=!0;const postcssPlugin=n=>{const r=Object.assign({enableProgressiveCustomProperties:!0,preserve:!1,subFeatures:{displayP3:!0}},n);return r.subFeatures=Object.assign({displayP3:!0},r.subFeatures),r.enableProgressiveCustomProperties&&(r.preserve||r.subFeatures.displayP3)?{postcssPlugin:"postcss-oklab-function",plugins:[e(),basePlugin(r)]}:basePlugin(r)};postcssPlugin.postcss=!0,module.exports=postcssPlugin;
