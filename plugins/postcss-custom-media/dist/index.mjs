import{parse as e}from"@csstools/cascade-layer-name-parser";import{tokenizer as r,TokenType as t,NumberType as n,cloneTokens as o,stringify as a}from"@csstools/css-tokenizer";import{parseFromTokens as s,parse as i,isMediaFeatureBoolean as l,isMediaFeature as u,newMediaFeaturePlain as c,isMediaQueryInvalid as f,isMediaQueryWithType as p,isMediaAnd as m,isMediaOr as d,isMediaNot as h,isMediaConditionList as g,isGeneralEnclosed as y}from"@csstools/media-query-list-parser";function collectCascadeLayerOrder(r){const t=new Map,n=new Map,o=[];r.walkAtRules((r=>{if("layer"!==r.name.toLowerCase())return;{let e=r.parent;for(;e;){if("atrule"!==e.type||"layer"!==e.name.toLowerCase()){if(e===r.root())break;return}e=e.parent}}let a;if(r.nodes)s=r.params,i=1,a=s.trim()||"csstools-anon-layer--"+i++;else{if(!r.params.trim())return;a=r.params}var s,i;let l=e(a,{onParseError(e){throw r.error(e.message)}});{let t=r.parent;for(;t&&"atrule"===t.type&&"layer"===t.name.toLowerCase();){const o=n.get(t);o?(l=l.map((t=>e(o.toString().trim()+"."+t.toString().trim(),{onParseError(e){throw r.error(e.message)}})[0])),t=t.parent):t=t.parent}}if(addLayerToModel(o,l),r.nodes){const o=e(l[0].toString().trim()+".csstools-implicit-layer")[0];t.set(r,o),n.set(r,l[0])}}));for(const e of t.values())addLayerToModel(o,[e]);const a=new WeakMap;for(const[e,r]of t){const t=r.segments();a.set(e,o.findIndex((e=>{const r=e.segments();if(r.length!==t.length)return!1;for(let e=0;e<r.length;e++){if(r[e]!==t[e])return!1}return!0})))}return a}function addLayerToModel(e,r){return r.forEach((r=>{const t=r.segments();e:for(let n=0;n<t.length;n++){const t=r.slice(0,n+1),o=t.segments();let a=-1,s=0;for(let r=0;r<e.length;r++){const t=e[r].segments();let n=0;r:for(let e=0;e<t.length;e++){const r=t[e],a=o[e];if(a===r&&e+1===o.length)continue e;if(a!==r){if(a!==r)break r}else n++}n>=s&&(a=r,s=n)}-1===a?e.push(t):e.splice(a+1,0,t)}})),e}const w=new Set(["scope","container","layer"]);function isProcessableCustomMediaRule(e){if("custom-media"!==e.name.toLowerCase())return!1;if(!e.params||!e.params.includes("--"))return!1;if(e.nodes&&e.nodes.length>0)return!1;let r=e.parent;for(;r;){if("atrule"===r.type&&!w.has(r.name.toLowerCase()))return!1;r=r.parent}return!0}function removeCyclicReferences(e,r){const t=new Set;let n=r;for(;e.size>0;)try{toposort(Array.from(e.keys()),n);break}catch(r){if(!r._graphNode)throw r;e.delete(r._graphNode),t.add(r._graphNode),n=n.filter((e=>-1===e.indexOf(r._graphNode)))}return t}function toposort(e,r){let t=e.length;const n=new Array(t),o={};let a=t;const s=makeOutgoingEdges(r),i=makeNodesHash(e);for(r.forEach((function(e){if(!i.has(e[0])||!i.has(e[1]))throw new Error("Unknown token. Make sure to provide all tokens used in aliases.")}));a--;)o[a]||visit(e[a],a,new Set);return n;function visit(e,r,a){if(a.has(e)){const r=new Error("Cyclic dependency"+JSON.stringify(e));throw r._graphNode=e,r}if(!i.has(e))throw new Error("Found unknown token. Make sure to provided all involved tokens. Unknown token: "+JSON.stringify(e));if(o[r])return;o[r]=!0;let l=s.get(e)||new Set;if(l=Array.from(l),r=l.length){a.add(e);do{const e=l[--r];visit(e,i.get(e),a)}while(r);a.delete(e)}n[--t]=e}}function makeOutgoingEdges(e){const r=new Map;for(let t=0,n=e.length;t<n;t++){const n=e[t];r.has(n[0])||r.set(n[0],new Set),r.has(n[1])||r.set(n[1],new Set),r.get(n[0]).add(n[1])}return r}function makeNodesHash(e){const r=new Map;for(let t=0,n=e.length;t<n;t++)r.set(e[t],t);return r}function atMediaParamsTokens(e){const t=r({css:e},{commentsAreTokens:!0,onParseError:()=>{throw new Error(`Unable to parse media query "${e}"`)}}),n=[];for(;!t.endOfFile();)n.push(t.nextToken());return n}const v=[[t.Ident,"max-color",0,0,{value:"max-color"}],[t.Colon,":",0,0,void 0],[t.Number,"2147477350",0,0,{value:2147477350,type:n.Integer}]],k=[[t.Ident,"color",0,0,{value:"color"}],[t.Colon,":",0,0,void 0],[t.Number,"2147477350",0,0,{value:2147477350,type:n.Integer}]];function replaceTrueAndFalseTokens(e){let r,n;for(let o=0;o<e.length;o++)if(e[o][0]!==t.Comment&&e[o][0]!==t.Whitespace){if(e[o][0]===t.Ident){const t=e[o];if("true"===t[4].value.toLowerCase()){r="true",n=e.slice(o+1);break}if("false"===t[4].value.toLowerCase()){r="false",n=e.slice(o+1);break}}return e}if(!r)return e;for(let r=0;r<n.length;r++)if(n[r][0]!==t.Comment&&n[r][0]!==t.Whitespace)return e;return"true"===r?[[t.Whitespace," ",0,0,void 0],[t.OpenParen,"(",0,0,void 0],...v,[t.CloseParen,")",0,0,void 0]]:[[t.Whitespace," ",0,0,void 0],[t.OpenParen,"(",0,0,void 0],...k,[t.CloseParen,")",0,0,void 0]]}function parseCustomMedia(e){const r=atMediaParamsTokens(e),n=new Set;let i="",l=r;for(let e=0;e<r.length;e++)if(r[e][0]!==t.Comment&&r[e][0]!==t.Whitespace){if(r[e][0]===t.Ident){const t=r[e];if(t[4].value.startsWith("--")){i=t[4].value,l=r.slice(e+1);break}}return!1}for(let e=0;e<l.length;e++)if(l[e][0]===t.Ident){const r=l[e];r[4].value.startsWith("--")&&n.add(r[4].value)}l=replaceTrueAndFalseTokens(l);const u=s(o(l),{preserveInvalidMediaQueries:!0,onParseError:()=>{throw new Error(`Unable to parse media query "${a(...l)}"`)}}),c=s(o(l),{preserveInvalidMediaQueries:!0,onParseError:()=>{throw new Error(`Unable to parse media query "${a(...l)}"`)}});for(let e=0;e<c.length;e++)c[e]=c[e].negateQuery();return{name:i,truthy:u,falsy:c,dependsOn:Array.from(n).map((e=>[e,i]))}}function getCustomMedia(e,r,t){const n=new Map,o=new Map,a=[],s=collectCascadeLayerOrder(e);e.walkAtRules((e=>{if(!isProcessableCustomMediaRule(e))return;const r=parseCustomMedia(e.params);if(!r)return;if(0===r.truthy.length)return;const i=(u=s,(l=e).parent&&"atrule"===l.parent.type&&"layer"===l.parent.name.toLowerCase()?u.has(l.parent)?u.get(l.parent):-1:1/0);var l,u;if(i>=(o.get(r.name)??-1)&&(o.set(r.name,i),n.set(r.name,{truthy:r.truthy,falsy:r.falsy}),a.push(...r.dependsOn)),!t.preserve){const r=e.parent;e.remove(),removeEmptyAncestorBlocks(r)}}));const i=removeCyclicReferences(n,a);for(const t of i.values())e.warn(r,`@custom-media rules have cyclic dependencies for "${t}"`);return n}function removeEmptyAncestorBlocks(e){let r=e;for(;r;){if(r.nodes&&r.nodes.length>0)return;const e=r.parent;r.remove(),r=e}}function transformAtMediaListTokens(e,r){const t=i(e,{preserveInvalidMediaQueries:!0,onParseError:()=>{throw new Error(`Unable to parse media query "${e}"`)}}),n=t.map((e=>e.toString()));for(let e=0;e<t.length;e++){const o=t[e],a=n[e];{const t=transformSimpleMediaQuery(o,r);if(t&&t.replaceWith!==a)return n.map(((r,n)=>n===e?t:{replaceWith:r}))}const s=transformComplexMediaQuery(o,r);if(s&&0!==s.length&&s[0].replaceWith!==a)return n.flatMap(((r,t)=>t===e?s:[{replaceWith:r}]))}return[]}function transformSimpleMediaQuery(e,r){if(!mediaQueryIsSimple(e))return null;let t=null;return e.walk((e=>{const n=e.node;if(!l(n))return;const o=n.getName();if(!o.startsWith("--"))return!1;const a=r.get(o);return a?(t={replaceWith:a.truthy.map((e=>e.toString().trim())).join(",")},!1):void 0})),t}function transformComplexMediaQuery(e,r){let t=[];return e.walk((n=>{const o=n.node;if(!l(o))return;const a=n.parent;if(!u(a))return;const s=o.getName();if(!s.startsWith("--"))return!1;const i=r.get(s);if(i){if(1===i.truthy.length&&mediaQueryIsSimple(i.truthy[0])){let r=null;if(i.truthy[0].walk((e=>{if(u(e.node))return r=e.node,!1})),r&&r.feature)return a.feature=r.feature,t=[{replaceWith:e.toString()}],!1}const r=c(v[0][4].value,v[2]);a.feature=r.feature;const n=e.toString(),o=c(k[0][4].value,k[2]);a.feature=o.feature;const s=e.toString();return t=[{replaceWith:n,encapsulateWith:i.truthy.map((e=>e.toString().trim())).join(",")},{replaceWith:s,encapsulateWith:i.falsy.map((e=>e.toString().trim())).join(",")}],!1}})),t}function mediaQueryIsSimple(e){if(f(e))return!1;if(p(e))return!1;let r=!0;return e.walk((e=>{if(m(e.node)||d(e.node)||h(e.node)||g(e.node)||y(e.node))return r=!1,!1})),r}const creator=e=>{const r=Boolean(Object(e).preserve);if("importFrom"in Object(e))throw new Error('[postcss-custom-media] "importFrom" is no longer supported');if("exportTo"in Object(e))throw new Error('[postcss-custom-media] "exportTo" is no longer supported');return{postcssPlugin:"postcss-custom-media",prepare(){let e=new Map;return{Once:(t,{result:n})=>{e=getCustomMedia(t,n,{preserve:r})},AtRule:(t,{result:n})=>{if("media"!==t.name.toLowerCase())return;if(!t.params)return;if(!t.params.includes("--"))return;let o=[];try{o=transformAtMediaListTokens(t.params,e)}catch(e){return void t.warn(n,`Failed to parse @custom-media params with error message: "${e.message}"`)}if(!o||0===o.length)return;if(1===o.length){if(t.params.trim()===o[0].replaceWith.trim())return;return t.cloneBefore({params:o[0].replaceWith.trim()}),r?void 0:void t.remove()}if(!!!o.find((e=>!!e.encapsulateWith)))return t.cloneBefore({params:o.map((e=>e.replaceWith)).join(",").trim()}),void(r||t.remove());o.forEach((e=>{if(!e.encapsulateWith)return void t.cloneBefore({params:e.replaceWith.trim()});const r=t.clone({params:e.replaceWith}),n=t.clone({params:e.encapsulateWith.trim(),nodes:[]});r.parent=null,n.parent=null,n.append(r),t.before(n)})),r||t.remove()}}}}};creator.postcss=!0;export{creator as default};
