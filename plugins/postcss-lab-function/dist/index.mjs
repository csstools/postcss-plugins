import e from"@csstools/postcss-progressive-custom-properties";import n from"postcss-value-parser";import{conversions as t}from"@csstools/color-helpers";function hasFallback(e){const n=e.parent;if(!n)return!1;const t=n.index(e);for(let r=0;r<t;r++){const t=n.nodes[r];if("decl"===t.type&&t.prop.toLowerCase()===e.prop.toLowerCase())return!0}return!1}function hasSupportsAtRuleAncestor(e){let n=e.parent;for(;n;)if("atrule"===n.type){if("supports"===n.name.toLowerCase()){if(-1!==n.params.toLowerCase().indexOf("lab("))return!0;if(-1!==n.params.toLowerCase().indexOf("lch("))return!0}n=n.parent}else n=n.parent;return!1}function onCSSFunctionSRgb(e){const n=e.value.toLowerCase(),r=e.nodes.slice().filter((e=>"comment"!==e.type&&"space"!==e.type));let o=null;if("lab"===n?o=labFunctionContents(r):"lch"===n&&(o=lchFunctionContents(r)),!o)return;e.value="rgb",transformAlpha(e,o.slash,o.alpha);const[u,s,a]=channelNodes(o),[i,l,c]=channelDimensions(o),d=("lab"===n?t.Lab_to_sRGB:t.LCH_to_sRGB)([i.number,l.number,c.number].map((e=>parseFloat(e))));e.nodes.splice(e.nodes.indexOf(u)+1,0,{sourceIndex:0,sourceEndIndex:1,value:",",type:"div",before:"",after:""}),e.nodes.splice(e.nodes.indexOf(s)+1,0,{sourceIndex:0,sourceEndIndex:1,value:",",type:"div",before:"",after:""}),replaceWith(e.nodes,u,{...u,value:String(d[0])}),replaceWith(e.nodes,s,{...s,value:String(d[1])}),replaceWith(e.nodes,a,{...a,value:String(d[2])})}function onCSSFunctionDisplayP3(e,r,o,u){const s=n.stringify(e),a=e.value.toLowerCase(),i=e.nodes.slice().filter((e=>"comment"!==e.type&&"space"!==e.type));let l=null;if("lab"===a?l=labFunctionContents(i):"lch"===a&&(l=lchFunctionContents(i)),!l)return;if(i.length>3&&(!l.slash||!l.alpha))return;e.value="color";const[c,d,p]=channelNodes(l),[f,b,m]=channelDimensions(l),v="lab"===a?t.Lab_to_P3:t.LCH_to_P3,h=[f.number,b.number,m.number].map((e=>parseFloat(e))),[N,g]=v(h);!g&&u&&r.warn(o,`"${s}" is out of gamut for "display-p3". Given "preserve: true" is set, this will lead to unexpected results in some browsers.`),e.nodes.splice(0,0,{sourceIndex:0,sourceEndIndex:10,value:"display-p3",type:"word"}),e.nodes.splice(1,0,{sourceIndex:0,sourceEndIndex:1,value:" ",type:"space"}),replaceWith(e.nodes,c,{...c,value:N[0].toFixed(5)}),replaceWith(e.nodes,d,{...d,value:N[1].toFixed(5)}),replaceWith(e.nodes,p,{...p,value:N[2].toFixed(5)})}function isNumericNode(e){if(!e||"word"!==e.type)return!1;if(!canParseAsUnit(e))return!1;const t=n.unit(e.value);return!!t&&!!t.number}function isNumericNodeHueLike(e){if(!e||"word"!==e.type)return!1;if(!canParseAsUnit(e))return!1;const t=n.unit(e.value);if(!t)return!1;const r=t.unit.toLowerCase();return!!t.number&&("deg"===r||"grad"===r||"rad"===r||"turn"===r||""===r)}function isNumericNodePercentageOrNumber(e){if(!e||"word"!==e.type)return!1;if(!canParseAsUnit(e))return!1;const t=n.unit(e.value);return!!t&&("%"===t.unit||""===t.unit)}function isCalcNode(e){return e&&"function"===e.type&&"calc"===e.value.toLowerCase()}function isVarNode(e){return e&&"function"===e.type&&"var"===e.value.toLowerCase()}function isSlashNode(e){return e&&"div"===e.type&&"/"===e.value}function lchFunctionContents(e){if(!isNumericNodePercentageOrNumber(e[0]))return null;if(!isNumericNodePercentageOrNumber(e[1]))return null;if(!isNumericNodeHueLike(e[2]))return null;const t={l:n.unit(e[0].value),lNode:e[0],c:n.unit(e[1].value),cNode:e[1],h:n.unit(e[2].value),hNode:e[2]};return normalizeHueNode(t.h),""!==t.h.unit?null:(isSlashNode(e[3])&&(t.slash=e[3]),(isNumericNodePercentageOrNumber(e[4])||isCalcNode(e[4])||isVarNode(e[4]))&&(t.alpha=e[4]),!(e.length>3)||t.slash&&t.alpha?("%"===t.l.unit&&(t.l.unit=""),"%"===t.c.unit&&(t.c.unit="",t.c.number=(parseFloat(t.c.number)/100*150).toFixed(10)),t):null)}function labFunctionContents(e){if(!isNumericNodePercentageOrNumber(e[0]))return null;if(!isNumericNodePercentageOrNumber(e[1]))return null;if(!isNumericNodePercentageOrNumber(e[2]))return null;const t={l:n.unit(e[0].value),lNode:e[0],a:n.unit(e[1].value),aNode:e[1],b:n.unit(e[2].value),bNode:e[2]};return isSlashNode(e[3])&&(t.slash=e[3]),(isNumericNodePercentageOrNumber(e[4])||isCalcNode(e[4])||isVarNode(e[4]))&&(t.alpha=e[4]),!(e.length>3)||t.slash&&t.alpha?("%"===t.l.unit&&(t.l.unit=""),"%"===t.a.unit&&(t.a.unit="",t.a.number=(parseFloat(t.a.number)/100*125).toFixed(10)),"%"===t.b.unit&&(t.b.unit="",t.b.number=(parseFloat(t.b.number)/100*125).toFixed(10)),t):null}function isLab(e){return void 0!==e.a}function channelNodes(e){return isLab(e)?[e.lNode,e.aNode,e.bNode]:[e.lNode,e.cNode,e.hNode]}function channelDimensions(e){return isLab(e)?[e.l,e.a,e.b]:[e.l,e.c,e.h]}function transformAlpha(e,t,r){if(!t||!r)return;if(e.value="rgba",t.value=",",t.before="",!isNumericNode(r))return;const o=n.unit(r.value);o&&"%"===o.unit&&(o.number=String(parseFloat(o.number)/100),r.value=String(o.number))}function replaceWith(e,n,t){const r=e.indexOf(n);e[r]=t}function normalizeHueNode(e){switch(e.unit.toLowerCase()){case"deg":return void(e.unit="");case"rad":return e.unit="",void(e.number=(180*parseFloat(e.number)/Math.PI).toString());case"grad":return e.unit="",void(e.number=(.9*parseFloat(e.number)).toString());case"turn":return e.unit="",void(e.number=(360*parseFloat(e.number)).toString())}}function canParseAsUnit(e){if(!e||!e.value)return!1;try{return!1!==n.unit(e.value)}catch(e){return!1}}function modifiedValues(e,t,r,o){let u;try{u=n(e)}catch(n){t.warn(r,`Failed to parse value '${e}' as a lab or lch function. Leaving the original value intact.`)}if(void 0===u)return;u.walk((e=>{e.type&&"function"===e.type&&("lab"!==e.value.toLowerCase()&&"lch"!==e.value.toLowerCase()||onCSSFunctionSRgb(e))}));const s=String(u);if(s===e)return;const a=n(e);a.walk((e=>{e.type&&"function"===e.type&&("lab"!==e.value.toLowerCase()&&"lch"!==e.value.toLowerCase()||onCSSFunctionDisplayP3(e,t,r,o))}));return{rgb:s,displayP3:String(a)}}const basePlugin=e=>({postcssPlugin:"postcss-lab-function",Declaration:(n,{result:t})=>{if(hasFallback(n))return;if(hasSupportsAtRuleAncestor(n))return;const r=n.value;if(!/(^|[^\w-])(lab|lch)\(/i.test(r.toLowerCase()))return;const o=modifiedValues(r,n,t,e.preserve);void 0!==o&&(e.preserve?(n.cloneBefore({value:o.rgb}),e.subFeatures.displayP3&&n.cloneBefore({value:o.displayP3})):(n.cloneBefore({value:o.rgb}),e.subFeatures.displayP3&&n.cloneBefore({value:o.displayP3}),n.remove()))}});basePlugin.postcss=!0;const postcssPlugin=n=>{const t=Object.assign({enableProgressiveCustomProperties:!0,preserve:!1,subFeatures:{displayP3:!0}},n);return t.subFeatures=Object.assign({displayP3:!0},t.subFeatures),t.enableProgressiveCustomProperties&&(t.preserve||t.subFeatures.displayP3)?{postcssPlugin:"postcss-lab-function",plugins:[e(),basePlugin(t)]}:basePlugin(t)};postcssPlugin.postcss=!0;export{postcssPlugin as default};
