import e from"@csstools/postcss-progressive-custom-properties";import t from"postcss-value-parser";import{conversions as n,utils as o,calculations as a}from"@csstools/color-helpers";function hasFallback(e){const t=e.parent;if(!t)return!1;const n=t.index(e);for(let o=0;o<n;o++){const n=t.nodes[o];if("decl"===n.type&&n.prop.toLowerCase()===e.prop.toLowerCase())return!0}return!1}function hasSupportsAtRuleAncestor(e){let t=e.parent;for(;t;)if("atrule"===t.type){if("supports"===t.name.toLowerCase()){if(-1!==t.params.toLowerCase().indexOf("lab("))return!0;if(-1!==t.params.toLowerCase().indexOf("lch("))return!0}t=t.parent}else t=t.parent;return!1}function labToDisplayP3(e){const[t,r,u]=e;let i=[Math.max(t,0),Math.min(Math.max(r,-160),160),Math.min(Math.max(u,-160),160)];i=n.Lab_to_XYZ(i);let s=i.slice();return s=n.D50_to_D65(s),s=n.XYZ_to_OKLab(s),s=n.OKLab_to_OKLCH(s),s[0]<1e-6&&(s=[0,0,0]),s[0]>.999999&&(s=[1,0,0]),i=n.D50_to_D65(i),i=n.XYZ_to_lin_P3(i),i=n.gam_P3(i),o.inGamut(i)?[o.clip(i),!0]:[a.mapGamut(s,(e=>(e=n.OKLCH_to_OKLab(e),e=n.OKLab_to_XYZ(e),e=n.XYZ_to_lin_P3(e),n.gam_P3(e))),(e=>(e=n.lin_P3(e),e=n.lin_P3_to_XYZ(e),e=n.XYZ_to_OKLab(e),n.OKLab_to_OKLCH(e)))),!1]}function labToSRgb(e){const[t,r,u]=e;let i=[Math.max(t,0),Math.min(Math.max(r,-160),160),Math.min(Math.max(u,-160),160)];i=n.Lab_to_XYZ(i);let s=i.slice();return s=n.D50_to_D65(s),s=n.XYZ_to_OKLab(s),s=n.OKLab_to_OKLCH(s),s[0]<1e-6&&(s=[0,0,0]),s[0]>.999999&&(s=[1,0,0]),i=n.D50_to_D65(i),i=n.XYZ_to_lin_sRGB(i),i=n.gam_sRGB(i),o.inGamut(i)?o.clip(i).map((e=>Math.round(255*e))):a.mapGamut(s,(e=>(e=n.OKLCH_to_OKLab(e),e=n.OKLab_to_XYZ(e),e=n.XYZ_to_lin_sRGB(e),n.gam_sRGB(e))),(e=>(e=n.lin_sRGB(e),e=n.lin_sRGB_to_XYZ(e),e=n.XYZ_to_OKLab(e),n.OKLab_to_OKLCH(e)))).map((e=>Math.round(255*e)))}function lchToDisplayP3(e){const[t,r,u]=e;let i=[Math.max(t,0),r,u%360];i=n.LCH_to_Lab(i),i=n.Lab_to_XYZ(i);let s=i.slice();return s=n.D50_to_D65(s),s=n.XYZ_to_OKLab(s),s=n.OKLab_to_OKLCH(s),s[0]<1e-6&&(s=[0,0,0]),s[0]>.999999&&(s=[1,0,0]),i=n.D50_to_D65(i),i=n.XYZ_to_lin_P3(i),i=n.gam_P3(i),o.inGamut(i)?[o.clip(i),!0]:[a.mapGamut(s,(e=>(e=n.OKLCH_to_OKLab(e),e=n.OKLab_to_XYZ(e),e=n.XYZ_to_lin_P3(e),n.gam_P3(e))),(e=>(e=n.lin_P3(e),e=n.lin_P3_to_XYZ(e),e=n.XYZ_to_OKLab(e),n.OKLab_to_OKLCH(e)))),!1]}function lchToSRgb(e){const[t,r,u]=e;let i=[Math.max(t,0),r,u%360];i=n.LCH_to_Lab(i),i=n.Lab_to_XYZ(i);let s=i.slice();return s=n.D50_to_D65(s),s=n.XYZ_to_OKLab(s),s=n.OKLab_to_OKLCH(s),s[0]<1e-6&&(s=[0,0,0]),s[0]>.999999&&(s=[1,0,0]),i=n.D50_to_D65(i),i=n.XYZ_to_lin_sRGB(i),i=n.gam_sRGB(i),o.inGamut(i)?o.clip(i).map((e=>Math.round(255*e))):a.mapGamut(s,(e=>(e=n.OKLCH_to_OKLab(e),e=n.OKLab_to_XYZ(e),e=n.XYZ_to_lin_sRGB(e),n.gam_sRGB(e))),(e=>(e=n.lin_sRGB(e),e=n.lin_sRGB_to_XYZ(e),e=n.XYZ_to_OKLab(e),n.OKLab_to_OKLCH(e)))).map((e=>Math.round(255*e)))}function onCSSFunctionSRgb(e){const t=e.value.toLowerCase(),n=e.nodes.slice().filter((e=>"comment"!==e.type&&"space"!==e.type));let o=null;if("lab"===t?o=labFunctionContents(n):"lch"===t&&(o=lchFunctionContents(n)),!o)return;e.value="rgb",transformAlpha(e,o.slash,o.alpha);const[a,r,u]=channelNodes(o),[i,s,l]=channelDimensions(o),c=("lab"===t?labToSRgb:lchToSRgb)([i.number,s.number,l.number].map((e=>parseFloat(e))));e.nodes.splice(e.nodes.indexOf(a)+1,0,{sourceIndex:0,sourceEndIndex:1,value:",",type:"div",before:"",after:""}),e.nodes.splice(e.nodes.indexOf(r)+1,0,{sourceIndex:0,sourceEndIndex:1,value:",",type:"div",before:"",after:""}),replaceWith(e.nodes,a,{...a,value:String(c[0])}),replaceWith(e.nodes,r,{...r,value:String(c[1])}),replaceWith(e.nodes,u,{...u,value:String(c[2])})}function onCSSFunctionDisplayP3(e,n,o,a){const r=t.stringify(e),u=e.value.toLowerCase(),i=e.nodes.slice().filter((e=>"comment"!==e.type&&"space"!==e.type));let s=null;if("lab"===u?s=labFunctionContents(i):"lch"===u&&(s=lchFunctionContents(i)),!s)return;if(i.length>3&&(!s.slash||!s.alpha))return;e.value="color";const[l,c,p]=channelNodes(s),[_,d,b]=channelDimensions(s),m="lab"===u?labToDisplayP3:lchToDisplayP3,f=[_.number,d.number,b.number].map((e=>parseFloat(e))),[h,v]=m(f);!v&&a&&n.warn(o,`"${r}" is out of gamut for "display-p3". Given "preserve: true" is set, this will lead to unexpected results in some browsers.`),e.nodes.splice(0,0,{sourceIndex:0,sourceEndIndex:10,value:"display-p3",type:"word"}),e.nodes.splice(1,0,{sourceIndex:0,sourceEndIndex:1,value:" ",type:"space"}),replaceWith(e.nodes,l,{...l,value:h[0].toFixed(5)}),replaceWith(e.nodes,c,{...c,value:h[1].toFixed(5)}),replaceWith(e.nodes,p,{...p,value:h[2].toFixed(5)})}function isNumericNode(e){if(!e||"word"!==e.type)return!1;if(!canParseAsUnit(e))return!1;const n=t.unit(e.value);return!!n&&!!n.number}function isNumericNodeHueLike(e){if(!e||"word"!==e.type)return!1;if(!canParseAsUnit(e))return!1;const n=t.unit(e.value);if(!n)return!1;const o=n.unit.toLowerCase();return!!n.number&&("deg"===o||"grad"===o||"rad"===o||"turn"===o||""===o)}function isNumericNodePercentageOrNumber(e){if(!e||"word"!==e.type)return!1;if(!canParseAsUnit(e))return!1;const n=t.unit(e.value);return!!n&&("%"===n.unit||""===n.unit)}function isCalcNode(e){return e&&"function"===e.type&&"calc"===e.value.toLowerCase()}function isVarNode(e){return e&&"function"===e.type&&"var"===e.value.toLowerCase()}function isSlashNode(e){return e&&"div"===e.type&&"/"===e.value}function lchFunctionContents(e){if(!isNumericNodePercentageOrNumber(e[0]))return null;if(!isNumericNodePercentageOrNumber(e[1]))return null;if(!isNumericNodeHueLike(e[2]))return null;const n={l:t.unit(e[0].value),lNode:e[0],c:t.unit(e[1].value),cNode:e[1],h:t.unit(e[2].value),hNode:e[2]};return normalizeHueNode(n.h),""!==n.h.unit?null:(isSlashNode(e[3])&&(n.slash=e[3]),(isNumericNodePercentageOrNumber(e[4])||isCalcNode(e[4])||isVarNode(e[4]))&&(n.alpha=e[4]),!(e.length>3)||n.slash&&n.alpha?("%"===n.l.unit&&(n.l.unit=""),"%"===n.c.unit&&(n.c.unit="",n.c.number=(parseFloat(n.c.number)/100*150).toFixed(10)),n):null)}function labFunctionContents(e){if(!isNumericNodePercentageOrNumber(e[0]))return null;if(!isNumericNodePercentageOrNumber(e[1]))return null;if(!isNumericNodePercentageOrNumber(e[2]))return null;const n={l:t.unit(e[0].value),lNode:e[0],a:t.unit(e[1].value),aNode:e[1],b:t.unit(e[2].value),bNode:e[2]};return isSlashNode(e[3])&&(n.slash=e[3]),(isNumericNodePercentageOrNumber(e[4])||isCalcNode(e[4])||isVarNode(e[4]))&&(n.alpha=e[4]),!(e.length>3)||n.slash&&n.alpha?("%"===n.l.unit&&(n.l.unit=""),"%"===n.a.unit&&(n.a.unit="",n.a.number=(parseFloat(n.a.number)/100*125).toFixed(10)),"%"===n.b.unit&&(n.b.unit="",n.b.number=(parseFloat(n.b.number)/100*125).toFixed(10)),n):null}function isLab(e){return void 0!==e.a}function channelNodes(e){return isLab(e)?[e.lNode,e.aNode,e.bNode]:[e.lNode,e.cNode,e.hNode]}function channelDimensions(e){return isLab(e)?[e.l,e.a,e.b]:[e.l,e.c,e.h]}function transformAlpha(e,n,o){if(!n||!o)return;if(e.value="rgba",n.value=",",n.before="",!isNumericNode(o))return;const a=t.unit(o.value);a&&"%"===a.unit&&(a.number=String(parseFloat(a.number)/100),o.value=String(a.number))}function replaceWith(e,t,n){const o=e.indexOf(t);e[o]=n}function normalizeHueNode(e){switch(e.unit.toLowerCase()){case"deg":return void(e.unit="");case"rad":return e.unit="",void(e.number=(180*parseFloat(e.number)/Math.PI).toString());case"grad":return e.unit="",void(e.number=(.9*parseFloat(e.number)).toString());case"turn":return e.unit="",void(e.number=(360*parseFloat(e.number)).toString())}}function canParseAsUnit(e){if(!e||!e.value)return!1;try{return!1!==t.unit(e.value)}catch(e){return!1}}function modifiedValues(e,n,o,a){let r;try{r=t(e)}catch(t){n.warn(o,`Failed to parse value '${e}' as a lab or lch function. Leaving the original value intact.`)}if(void 0===r)return;r.walk((e=>{e.type&&"function"===e.type&&("lab"!==e.value.toLowerCase()&&"lch"!==e.value.toLowerCase()||onCSSFunctionSRgb(e))}));const u=String(r);if(u===e)return;const i=t(e);i.walk((e=>{e.type&&"function"===e.type&&("lab"!==e.value.toLowerCase()&&"lch"!==e.value.toLowerCase()||onCSSFunctionDisplayP3(e,n,o,a))}));return{rgb:u,displayP3:String(i)}}const basePlugin=e=>({postcssPlugin:"postcss-lab-function",Declaration:(t,{result:n})=>{if(hasFallback(t))return;if(hasSupportsAtRuleAncestor(t))return;const o=t.value;if(!/(^|[^\w-])(lab|lch)\(/i.test(o.toLowerCase()))return;const a=modifiedValues(o,t,n,e.preserve);void 0!==a&&(e.preserve?(t.cloneBefore({value:a.rgb}),e.subFeatures.displayP3&&t.cloneBefore({value:a.displayP3})):(t.cloneBefore({value:a.rgb}),e.subFeatures.displayP3&&t.cloneBefore({value:a.displayP3}),t.remove()))}});basePlugin.postcss=!0;const postcssPlugin=t=>{const n=Object.assign({enableProgressiveCustomProperties:!0,preserve:!1,subFeatures:{displayP3:!0}},t);return n.subFeatures=Object.assign({displayP3:!0},n.subFeatures),n.enableProgressiveCustomProperties&&(n.preserve||n.subFeatures.displayP3)?{postcssPlugin:"postcss-lab-function",plugins:[e(),basePlugin(n)]}:basePlugin(n)};postcssPlugin.postcss=!0;export{postcssPlugin as default};
