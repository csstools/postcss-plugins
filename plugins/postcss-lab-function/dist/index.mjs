import e from"@csstools/postcss-progressive-custom-properties";import{tokenize as s,cloneTokens as r}from"@csstools/css-tokenizer";import{color as t,SyntaxFlag as o,serializeRGB as a,serializeP3 as n}from"@csstools/css-color-parser";import{replaceComponentValues as l,parseCommaSeparatedListOfComponentValues as u,isFunctionNode as i,stringify as p}from"@csstools/css-parser-algorithms";function hasFallback(e){const s=e.parent;if(!s)return!1;const r=e.prop.toLowerCase(),t=s.index(e);for(let e=0;e<t;e++){const t=s.nodes[e];if("decl"===t.type&&t.prop.toLowerCase()===r)return!0}return!1}function hasSupportsAtRuleAncestor(e){let s=e.parent;for(;s;)if("atrule"===s.type){if("supports"===s.name.toLowerCase()){if(-1!==s.params.toLowerCase().indexOf("lab("))return!0;if(-1!==s.params.toLowerCase().indexOf("lch("))return!0}s=s.parent}else s=s.parent;return!1}const c=/(^|[^\w-])(lab|lch)\(/i,f=/^(lab|lch)$/i,basePlugin=e=>({postcssPlugin:"postcss-lab-function",Declaration:b=>{if(hasFallback(b))return;if(hasSupportsAtRuleAncestor(b))return;const m=b.value;if(!c.test(m.toLowerCase()))return;const d=s({css:m}),g=l(u(d),(e=>{if(i(e)&&f.test(e.getName())){const s=t(e);if(!s)return;if(s.syntaxFlags.has(o.HasNoneKeywords))return;return a(s)}})),v=p(g);if(v===m)return;let y=v;null!=e&&e.subFeatures.displayP3&&(y=p(l(u(r(d)),(e=>{if(i(e)&&f.test(e.getName())){const s=t(e);if(!s)return;if(s.syntaxFlags.has(o.HasNoneKeywords))return;return n(s)}})))),null!=e&&e.preserve?(b.cloneBefore({value:v}),null!=e&&e.subFeatures.displayP3&&b.cloneBefore({value:y})):(b.cloneBefore({value:v}),null!=e&&e.subFeatures.displayP3&&b.cloneBefore({value:y}),b.remove())}});basePlugin.postcss=!0;const postcssPlugin=s=>{const r=Object.assign({enableProgressiveCustomProperties:!0,preserve:!1,subFeatures:{displayP3:!0}},s);return r.subFeatures=Object.assign({displayP3:!0},r.subFeatures),r.enableProgressiveCustomProperties&&(r.preserve||r.subFeatures.displayP3)?{postcssPlugin:"postcss-lab-function",plugins:[e(),basePlugin(r)]}:basePlugin(r)};postcssPlugin.postcss=!0;export{postcssPlugin as default};
