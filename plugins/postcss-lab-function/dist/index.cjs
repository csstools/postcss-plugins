"use strict";var e=require("@csstools/postcss-progressive-custom-properties"),n=require("postcss-value-parser"),o=require("@csstools/color-helpers");function hasFallback(e){const n=e.parent;if(!n)return!1;const o=n.index(e);for(let t=0;t<o;t++){const o=n.nodes[t];if("decl"===o.type&&o.prop.toLowerCase()===e.prop.toLowerCase())return!0}return!1}function hasSupportsAtRuleAncestor(e){let n=e.parent;for(;n;)if("atrule"===n.type){if("supports"===n.name.toLowerCase()){if(-1!==n.params.toLowerCase().indexOf("lab("))return!0;if(-1!==n.params.toLowerCase().indexOf("lch("))return!0}n=n.parent}else n=n.parent;return!1}function labToDisplayP3(e){const[n,t,s]=e;let r=[Math.max(n,0),Math.min(Math.max(t,-160),160),Math.min(Math.max(s,-160),160)];r=o.conversions.Lab_to_XYZ(r);let i=r.slice();return i=o.conversions.D50_to_D65(i),i=o.conversions.XYZ_to_OKLab(i),i=o.conversions.OKLab_to_OKLCH(i),i[0]<1e-6&&(i=[0,0,0]),i[0]>.999999&&(i=[1,0,0]),r=o.conversions.D50_to_D65(r),r=o.conversions.XYZ_to_lin_P3(r),r=o.conversions.gam_P3(r),o.utils.inGamut(r)?[o.utils.clip(r),!0]:[o.calculations.mapGamut(i,(e=>(e=o.conversions.OKLCH_to_OKLab(e),e=o.conversions.OKLab_to_XYZ(e),e=o.conversions.XYZ_to_lin_P3(e),o.conversions.gam_P3(e))),(e=>(e=o.conversions.lin_P3(e),e=o.conversions.lin_P3_to_XYZ(e),e=o.conversions.XYZ_to_OKLab(e),o.conversions.OKLab_to_OKLCH(e)))),!1]}function labToSRgb(e){const[n,t,s]=e;let r=[Math.max(n,0),Math.min(Math.max(t,-160),160),Math.min(Math.max(s,-160),160)];r=o.conversions.Lab_to_XYZ(r);let i=r.slice();return i=o.conversions.D50_to_D65(i),i=o.conversions.XYZ_to_OKLab(i),i=o.conversions.OKLab_to_OKLCH(i),i[0]<1e-6&&(i=[0,0,0]),i[0]>.999999&&(i=[1,0,0]),r=o.conversions.D50_to_D65(r),r=o.conversions.XYZ_to_lin_sRGB(r),r=o.conversions.gam_sRGB(r),o.utils.inGamut(r)?o.utils.clip(r).map((e=>Math.round(255*e))):o.calculations.mapGamut(i,(e=>(e=o.conversions.OKLCH_to_OKLab(e),e=o.conversions.OKLab_to_XYZ(e),e=o.conversions.XYZ_to_lin_sRGB(e),o.conversions.gam_sRGB(e))),(e=>(e=o.conversions.lin_sRGB(e),e=o.conversions.lin_sRGB_to_XYZ(e),e=o.conversions.XYZ_to_OKLab(e),o.conversions.OKLab_to_OKLCH(e)))).map((e=>Math.round(255*e)))}function lchToDisplayP3(e){const[n,t,s]=e;let r=[Math.max(n,0),t,s%360];r=o.conversions.LCH_to_Lab(r),r=o.conversions.Lab_to_XYZ(r);let i=r.slice();return i=o.conversions.D50_to_D65(i),i=o.conversions.XYZ_to_OKLab(i),i=o.conversions.OKLab_to_OKLCH(i),i[0]<1e-6&&(i=[0,0,0]),i[0]>.999999&&(i=[1,0,0]),r=o.conversions.D50_to_D65(r),r=o.conversions.XYZ_to_lin_P3(r),r=o.conversions.gam_P3(r),o.utils.inGamut(r)?[o.utils.clip(r),!0]:[o.calculations.mapGamut(i,(e=>(e=o.conversions.OKLCH_to_OKLab(e),e=o.conversions.OKLab_to_XYZ(e),e=o.conversions.XYZ_to_lin_P3(e),o.conversions.gam_P3(e))),(e=>(e=o.conversions.lin_P3(e),e=o.conversions.lin_P3_to_XYZ(e),e=o.conversions.XYZ_to_OKLab(e),o.conversions.OKLab_to_OKLCH(e)))),!1]}function lchToSRgb(e){const[n,t,s]=e;let r=[Math.max(n,0),t,s%360];r=o.conversions.LCH_to_Lab(r),r=o.conversions.Lab_to_XYZ(r);let i=r.slice();return i=o.conversions.D50_to_D65(i),i=o.conversions.XYZ_to_OKLab(i),i=o.conversions.OKLab_to_OKLCH(i),i[0]<1e-6&&(i=[0,0,0]),i[0]>.999999&&(i=[1,0,0]),r=o.conversions.D50_to_D65(r),r=o.conversions.XYZ_to_lin_sRGB(r),r=o.conversions.gam_sRGB(r),o.utils.inGamut(r)?o.utils.clip(r).map((e=>Math.round(255*e))):o.calculations.mapGamut(i,(e=>(e=o.conversions.OKLCH_to_OKLab(e),e=o.conversions.OKLab_to_XYZ(e),e=o.conversions.XYZ_to_lin_sRGB(e),o.conversions.gam_sRGB(e))),(e=>(e=o.conversions.lin_sRGB(e),e=o.conversions.lin_sRGB_to_XYZ(e),e=o.conversions.XYZ_to_OKLab(e),o.conversions.OKLab_to_OKLCH(e)))).map((e=>Math.round(255*e)))}function onCSSFunctionSRgb(e){const n=e.value.toLowerCase(),o=e.nodes.slice().filter((e=>"comment"!==e.type&&"space"!==e.type));let t=null;if("lab"===n?t=labFunctionContents(o):"lch"===n&&(t=lchFunctionContents(o)),!t)return;e.value="rgb",transformAlpha(e,t.slash,t.alpha);const[s,r,i]=channelNodes(t),[a,u,l]=channelDimensions(t),c=("lab"===n?labToSRgb:lchToSRgb)([a.number,u.number,l.number].map((e=>parseFloat(e))));e.nodes.splice(e.nodes.indexOf(s)+1,0,{sourceIndex:0,sourceEndIndex:1,value:",",type:"div",before:"",after:""}),e.nodes.splice(e.nodes.indexOf(r)+1,0,{sourceIndex:0,sourceEndIndex:1,value:",",type:"div",before:"",after:""}),replaceWith(e.nodes,s,{...s,value:String(c[0])}),replaceWith(e.nodes,r,{...r,value:String(c[1])}),replaceWith(e.nodes,i,{...i,value:String(c[2])})}function onCSSFunctionDisplayP3(e,o,t,s){const r=n.stringify(e),i=e.value.toLowerCase(),a=e.nodes.slice().filter((e=>"comment"!==e.type&&"space"!==e.type));let u=null;if("lab"===i?u=labFunctionContents(a):"lch"===i&&(u=lchFunctionContents(a)),!u)return;if(a.length>3&&(!u.slash||!u.alpha))return;e.value="color";const[l,c,v]=channelNodes(u),[_,p,d]=channelDimensions(u),b="lab"===i?labToDisplayP3:lchToDisplayP3,m=[_.number,p.number,d.number].map((e=>parseFloat(e))),[f,h]=b(m);!h&&s&&o.warn(t,`"${r}" is out of gamut for "display-p3". Given "preserve: true" is set, this will lead to unexpected results in some browsers.`),e.nodes.splice(0,0,{sourceIndex:0,sourceEndIndex:10,value:"display-p3",type:"word"}),e.nodes.splice(1,0,{sourceIndex:0,sourceEndIndex:1,value:" ",type:"space"}),replaceWith(e.nodes,l,{...l,value:f[0].toFixed(5)}),replaceWith(e.nodes,c,{...c,value:f[1].toFixed(5)}),replaceWith(e.nodes,v,{...v,value:f[2].toFixed(5)})}function isNumericNode(e){if(!e||"word"!==e.type)return!1;if(!canParseAsUnit(e))return!1;const o=n.unit(e.value);return!!o&&!!o.number}function isNumericNodeHueLike(e){if(!e||"word"!==e.type)return!1;if(!canParseAsUnit(e))return!1;const o=n.unit(e.value);if(!o)return!1;const t=o.unit.toLowerCase();return!!o.number&&("deg"===t||"grad"===t||"rad"===t||"turn"===t||""===t)}function isNumericNodePercentageOrNumber(e){if(!e||"word"!==e.type)return!1;if(!canParseAsUnit(e))return!1;const o=n.unit(e.value);return!!o&&("%"===o.unit||""===o.unit)}function isCalcNode(e){return e&&"function"===e.type&&"calc"===e.value.toLowerCase()}function isVarNode(e){return e&&"function"===e.type&&"var"===e.value.toLowerCase()}function isSlashNode(e){return e&&"div"===e.type&&"/"===e.value}function lchFunctionContents(e){if(!isNumericNodePercentageOrNumber(e[0]))return null;if(!isNumericNodePercentageOrNumber(e[1]))return null;if(!isNumericNodeHueLike(e[2]))return null;const o={l:n.unit(e[0].value),lNode:e[0],c:n.unit(e[1].value),cNode:e[1],h:n.unit(e[2].value),hNode:e[2]};return normalizeHueNode(o.h),""!==o.h.unit?null:(isSlashNode(e[3])&&(o.slash=e[3]),(isNumericNodePercentageOrNumber(e[4])||isCalcNode(e[4])||isVarNode(e[4]))&&(o.alpha=e[4]),!(e.length>3)||o.slash&&o.alpha?("%"===o.l.unit&&(o.l.unit=""),"%"===o.c.unit&&(o.c.unit="",o.c.number=(parseFloat(o.c.number)/100*150).toFixed(10)),o):null)}function labFunctionContents(e){if(!isNumericNodePercentageOrNumber(e[0]))return null;if(!isNumericNodePercentageOrNumber(e[1]))return null;if(!isNumericNodePercentageOrNumber(e[2]))return null;const o={l:n.unit(e[0].value),lNode:e[0],a:n.unit(e[1].value),aNode:e[1],b:n.unit(e[2].value),bNode:e[2]};return isSlashNode(e[3])&&(o.slash=e[3]),(isNumericNodePercentageOrNumber(e[4])||isCalcNode(e[4])||isVarNode(e[4]))&&(o.alpha=e[4]),!(e.length>3)||o.slash&&o.alpha?("%"===o.l.unit&&(o.l.unit=""),"%"===o.a.unit&&(o.a.unit="",o.a.number=(parseFloat(o.a.number)/100*125).toFixed(10)),"%"===o.b.unit&&(o.b.unit="",o.b.number=(parseFloat(o.b.number)/100*125).toFixed(10)),o):null}function isLab(e){return void 0!==e.a}function channelNodes(e){return isLab(e)?[e.lNode,e.aNode,e.bNode]:[e.lNode,e.cNode,e.hNode]}function channelDimensions(e){return isLab(e)?[e.l,e.a,e.b]:[e.l,e.c,e.h]}function transformAlpha(e,o,t){if(!o||!t)return;if(e.value="rgba",o.value=",",o.before="",!isNumericNode(t))return;const s=n.unit(t.value);s&&"%"===s.unit&&(s.number=String(parseFloat(s.number)/100),t.value=String(s.number))}function replaceWith(e,n,o){const t=e.indexOf(n);e[t]=o}function normalizeHueNode(e){switch(e.unit.toLowerCase()){case"deg":return void(e.unit="");case"rad":return e.unit="",void(e.number=(180*parseFloat(e.number)/Math.PI).toString());case"grad":return e.unit="",void(e.number=(.9*parseFloat(e.number)).toString());case"turn":return e.unit="",void(e.number=(360*parseFloat(e.number)).toString())}}function canParseAsUnit(e){if(!e||!e.value)return!1;try{return!1!==n.unit(e.value)}catch(e){return!1}}function modifiedValues(e,o,t,s){let r;try{r=n(e)}catch(n){o.warn(t,`Failed to parse value '${e}' as a lab or lch function. Leaving the original value intact.`)}if(void 0===r)return;r.walk((e=>{e.type&&"function"===e.type&&("lab"!==e.value.toLowerCase()&&"lch"!==e.value.toLowerCase()||onCSSFunctionSRgb(e))}));const i=String(r);if(i===e)return;const a=n(e);a.walk((e=>{e.type&&"function"===e.type&&("lab"!==e.value.toLowerCase()&&"lch"!==e.value.toLowerCase()||onCSSFunctionDisplayP3(e,o,t,s))}));return{rgb:i,displayP3:String(a)}}const basePlugin=e=>({postcssPlugin:"postcss-lab-function",Declaration:(n,{result:o})=>{if(hasFallback(n))return;if(hasSupportsAtRuleAncestor(n))return;const t=n.value;if(!/(^|[^\w-])(lab|lch)\(/i.test(t.toLowerCase()))return;const s=modifiedValues(t,n,o,e.preserve);void 0!==s&&(e.preserve?(n.cloneBefore({value:s.rgb}),e.subFeatures.displayP3&&n.cloneBefore({value:s.displayP3})):(n.cloneBefore({value:s.rgb}),e.subFeatures.displayP3&&n.cloneBefore({value:s.displayP3}),n.remove()))}});basePlugin.postcss=!0;const postcssPlugin=n=>{const o=Object.assign({enableProgressiveCustomProperties:!0,preserve:!1,subFeatures:{displayP3:!0}},n);return o.subFeatures=Object.assign({displayP3:!0},o.subFeatures),o.enableProgressiveCustomProperties&&(o.preserve||o.subFeatures.displayP3)?{postcssPlugin:"postcss-lab-function",plugins:[e(),basePlugin(o)]}:basePlugin(o)};postcssPlugin.postcss=!0,module.exports=postcssPlugin;
