<!DOCTYPE html>
<meta charset="utf-8">
<title></title>
<link rel="help" href="https://drafts.csswg.org/selectors/#relational">
<link rel="stylesheet" href="/test/browser.expect.css">
<script src="/dist/browser-global.js"></script>
<script>cssHasPseudo(document, { observedAttributes: ['attrname'] });</script>

<div id="fixture"></div>
<script type="module">
	function rafP(callback) {
		return new Promise((resolve) => {
			requestAnimationFrame(() => {
				requestAnimationFrame(() => {
					callback();
					resolve();
				});
			});
		});
	}

	self.runTest = async function runTest() {
		const invalidationResult = await testInvalidation();
		const adjacentPositionResult = await testAdjacentPosition();

		return invalidationResult && adjacentPositionResult;
	}

	async function testAdjacentPosition() {
		// https://github.com/web-platform-tests/wpt/blob/master/css/selectors/invalidation/has-in-adjacent-position.html

		fixture.innerHTML = `
			<main id=main>
				<div id=previous_sibling>
					<div id=previous_sibling_child>
						<div id=previous_sibling_descendant></div>
					</div>
				</div>
				<div id=subject></div>
				<div id=next_sibling>
					<div id=next_sibling_child>
						<div id=next_sibling_descendant></div>
					</div>
				</div>
			</main>
		`;

		const grey = 'rgb(128, 128, 128)';
		const red = 'rgb(255, 0, 0)';
		const green = 'rgb(0, 128, 0)';
		const blue = 'rgb(0, 0, 255)';
		const yellow = 'rgb(255, 255, 0)';
		const purple = 'rgb(128, 0, 128)';
		const pink = 'rgb(255, 192, 203)';

		function testColor(test_name, color) {
			var actual = getComputedStyle(subject).backgroundColor;
			if (actual !== color) {
				throw new Error(test_name + ': expected ' + color + ' but got ' + actual);
			}
		}

		async function testClassChange(element, expectedColor) {
			element.classList.add('test');
			await rafP(() => {
				testColor(`add .test to ${element.id}`, expectedColor);
			});
			element.classList.remove('test');
			await rafP(() => {
				testColor(`remove .test from ${element.id}`, grey);
			});
		}

		async function testElementInsertionBefore(beforeElement, expectedColor) {
			const newElement = document.createElement('div');
			newElement.classList.add('test')

			beforeElement.before(newElement);
			await rafP(() => {
				testColor(`insert element div.test before ${beforeElement.id}`, expectedColor);
			});

			newElement.remove();
			await rafP(() => {
				testColor(`remove element div.test before ${beforeElement.id}`, grey);
			});
		}

		async function testElementInsertionAfter(afterElement, expectedColor) {
			const newElement = document.createElement('div');
			newElement.classList.add('test')

			afterElement.after(newElement);
			await rafP(() => {
				testColor(`insert element div.test after ${afterElement.id}`, expectedColor);
			});

			newElement.remove();
			await rafP(() => {
				testColor(`remove element div.test after ${afterElement.id}`, grey);
			});
		}

		async function testTreeInsertionBefore(beforeElement, expectedColor) {
			const newElement = document.createElement('div');
			const newChild = document.createElement('div');
			newChild.classList.add('test');
			newElement.appendChild(newChild);

			beforeElement.before(newElement);
			await rafP(() => {
				testColor(`insert tree div>div.test before ${beforeElement.id}`, expectedColor);
			});

			newElement.remove();
			await rafP(() => {
				testColor(`remove tree div>div.test before ${beforeElement.id}`, grey);
			});
		}

		async function testTreeInsertionAfter(afterElement, expectedColor) {
			const newElement = document.createElement('div');
			const newChild = document.createElement('div');
			newChild.classList.add('test');
			newElement.appendChild(newChild);

			afterElement.after(newElement);
			await rafP(() => {
				testColor(`insert tree div>div.test after ${afterElement.id}`, expectedColor);
			});

			newElement.remove();
			await rafP(() => {
				testColor(`remove tree div>div.test after ${afterElement.id}`, grey);
			});
		}

		await rafP(() => {
			testColor('Initial color', grey);
		});

		await testClassChange(previous_sibling, grey);
		await testClassChange(previous_sibling_child, green);
		await testClassChange(previous_sibling_descendant, red);
		await testClassChange(subject, blue);
		await testClassChange(next_sibling, yellow);
		await testClassChange(next_sibling_child, purple);
		await testClassChange(next_sibling_descendant, purple);

		await testElementInsertionBefore(previous_sibling, grey);
		await testElementInsertionBefore(previous_sibling_child, green);
		await testElementInsertionBefore(previous_sibling_descendant, red);
		await testElementInsertionBefore(subject, grey);
		await testElementInsertionBefore(next_sibling, yellow);
		await testElementInsertionBefore(next_sibling_child, purple);
		await testElementInsertionBefore(next_sibling_descendant, purple);

		await testElementInsertionAfter(previous_sibling, grey);
		await testElementInsertionAfter(previous_sibling_child, green);
		await testElementInsertionAfter(previous_sibling_descendant, red);
		await testElementInsertionAfter(subject, yellow);
		await testElementInsertionAfter(next_sibling, yellow);
		await testElementInsertionAfter(next_sibling_child, purple);
		await testElementInsertionAfter(next_sibling_descendant, purple);

		await testTreeInsertionBefore(previous_sibling, grey);
		await testTreeInsertionBefore(previous_sibling_child, red);
		await testTreeInsertionBefore(previous_sibling_descendant, red);
		await testTreeInsertionBefore(subject, green);
		await testTreeInsertionBefore(next_sibling, purple);
		await testTreeInsertionBefore(next_sibling_child, purple);
		await testTreeInsertionBefore(next_sibling_descendant, purple);

		await testTreeInsertionAfter(previous_sibling, green);
		await testTreeInsertionAfter(previous_sibling_child, red);
		await testTreeInsertionAfter(previous_sibling_descendant, red);
		await testTreeInsertionAfter(subject, purple);
		await testTreeInsertionAfter(next_sibling, purple);
		await testTreeInsertionAfter(next_sibling_child, purple);
		await testTreeInsertionAfter(next_sibling_descendant, purple);

		return true;
	}

	async function testInvalidation() {
		// https://github.com/web-platform-tests/wpt/blob/master/css/selectors/invalidation/attribute-or-elemental-selectors-in-has.html

		fixture.innerHTML = `
			<main id=main>
				<div id=div_subject class="subject">
					<div id=div_child>
						<div id=div_grandchild></div>
					</div>
				</div>
			</main>
		`;

		var grey = 'rgb(128, 128, 128)';
		var red = 'rgb(255, 0, 0)';
		var green = 'rgb(0, 128, 0)';
		var blue = 'rgb(0, 0, 255)';
		var yellow = 'rgb(255, 255, 0)';
		var yellowgreen = 'rgb(154, 205, 50)';

		function test_div(test_name, el, color) {
			var actual = getComputedStyle(el).backgroundColor;
			if (actual !== color) {
				throw new Error(test_name + ': div#' + el.id + '.color; expected ' + color + ' but got ' + actual);
			}
		}

		test_div('initial_color', div_subject, grey);
		test_div('initial_color', div_child, grey);
		test_div('initial_color', div_grandchild, grey);

		div_child.classList.add('child');
		await rafP(() => {
			test_div('add .child to #div_child', div_subject, red);
		});

		div_child.classList.remove('child');
		await rafP(() => {
			test_div('remove .child from #div_child', div_subject, grey);
		});

		div_grandchild.classList.add('child');
		await rafP(() => {
			test_div('add .child to #div_grandchild', div_subject, grey);
		});
		div_grandchild.classList.remove('child');
		await rafP(() => {
			test_div('remove .child from #div_grandchild', div_subject, grey);
		});

		div_child.classList.add('descendant');
		await rafP(() => {
			test_div('add .descendant to #div_child', div_subject, green);
		});
		div_child.classList.remove('descendant');
		await rafP(() => {
			test_div('remove .descendant from #div_child', div_subject, grey);
		});

		div_grandchild.classList.add('descendant');
		await rafP(() => {
			test_div('add .descendant to #div_grandchild', div_subject, green);
		});
		div_grandchild.classList.remove('descendant');
		await rafP(() => {
			test_div('remove .descendant from #div_grandchild', div_subject, grey);
		});

		div_grandchild.setAttribute('attrname', 'descendant');
		await rafP(() => {
			test_div('set descendant to #div_grandchild[attrname]', div_subject, blue);
		});
		div_grandchild.setAttribute('attrname', '');
		await rafP(() => {
			test_div('clear #div_grandchild[attrname]', div_subject, grey);
		});

		div_grandchild.id = 'div_descendant';
		await rafP(() => {
			test_div('change #div_grandchild to #div_descendant', div_subject, yellow);
		});
		div_descendant.id = 'div_grandchild';
		await rafP(() => {
			test_div('change #div_descendant to #div_grandchild', div_subject, grey);
		});

		{
			var descendant = document.createElement('descendant');
			div_subject.appendChild(descendant);
			await rafP(() => {
				test_div('add descendant to #div_subject', div_subject, yellowgreen);
			});
			div_subject.removeChild(descendant);
			await rafP(() => {
				test_div('remove descendant from #div_subject', div_subject, grey);
			});
		}

		{
			var div = document.createElement('div');
			var descendant = document.createElement('descendant');
			div.appendChild(descendant);
			div_subject.appendChild(div);
			await rafP(() => {
				test_div('add "div > descendant" to #div_subject', div_subject, yellowgreen);
			});
			div_subject.removeChild(div);
			await rafP(() => {
				test_div('remove "div > descendant" from #div_subject', div_subject, grey);
			});
		}

		{
			var child = document.createElement('div');
			child.classList.add('child');
			div_subject.appendChild(child);
			await rafP(() => {
				test_div('add div.child to #div_subject', div_subject, red);
			});
			div_subject.removeChild(child);
			await rafP(() => {
				test_div('remove div.child from #div_subject', div_subject, grey);
			});
		}

		{
			var descendant = document.createElement('div');
			descendant.classList.add('descendant');
			var div = document.createElement('div');
			div.appendChild(descendant);
			div_subject.appendChild(div);
			await rafP(() => {
				test_div('add "div > div.descendant" to #div_subject', div_subject, green);
			});
			div_subject.removeChild(div);
			await rafP(() => {
				test_div('remove "div > div.descendant" from #div_subject', div_subject, grey);
			});
		}

		{
			var child = document.createElement('div');
			child.id = 'div_descendant';
			div_subject.appendChild(child);
			await rafP(() => {
				test_div('add div#div_descendant to #div_subject', div_subject, yellow);
			});
			div_subject.removeChild(child);
			await rafP(() => {
				test_div('remove div#div_descendant from #div_subject', div_subject, grey);
			});
		}

		{
			var descendant = document.createElement('div');
			descendant.id = 'div_descendant';
			var div = document.createElement('div');
			div.appendChild(descendant);
			div_subject.appendChild(div);
			await rafP(() => {
				test_div('add "div#div_descendant" to #div_subject', div_subject, yellow);
			});
			div_subject.removeChild(div);
			await rafP(() => {
				test_div('remove "div#div_descendant" from #div_subject', div_subject, grey);
			});
		}

		{
			var child = document.createElement('div');
			child.setAttribute('attrname', 'descendant');
			div_subject.appendChild(child);
			await rafP(() => {
				test_div('add div[attrname] to #div_subject', div_subject, blue);
			});
			div_subject.removeChild(child);
			await rafP(() => {
				test_div('remove div[attrname] from #div_subject', div_subject, grey);
			});
		}

		{
			var descendant = document.createElement('div');
			descendant.setAttribute('attrname', 'descendant');
			var div = document.createElement('div');
			div.appendChild(descendant);
			div_subject.appendChild(div);
			await rafP(() => {
				test_div('add "div > div[attrname]" to #div_subject', div_subject, blue);
			});
			div_subject.removeChild(div);
			await rafP(() => {
				test_div('remove "div > div[attrname]" from #div_subject', div_subject, grey);
			});
		}

		return true;
	}
</script>
