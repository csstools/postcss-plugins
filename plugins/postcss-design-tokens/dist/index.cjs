"use strict";var e=require("postcss-value-parser"),t=require("path"),n=require("fs"),r=require("module");function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var i=o(e),a=o(t),s=o(r);function u(e,t){let n=e.length;const r=new Array(n),o={};let i=n;const a=function(e){const t=new Map;for(let n=0,r=e.length;n<r;n++){const r=e[n];t.has(r[0])||t.set(r[0],new Set),t.has(r[1])||t.set(r[1],new Set),t.get(r[0]).add(r[1])}return t}(t),s=function(e){const t=new Map;for(let n=0,r=e.length;n<r;n++)t.set(e[n],n);return t}(e);for(t.forEach((function(e){if(!s.has(e[0])||!s.has(e[1]))throw new Error("Unknown token. Make sure to provide all tokens used in aliases.")}));i--;)o[i]||u(e[i],i,new Set);return r;function u(e,t,i){if(i.has(e)){let t;try{t=", token was: "+JSON.stringify(e)}catch(e){t=""}throw new Error("Cyclic dependency"+t)}if(!s.has(e))throw new Error("Found unknown token. Make sure to provided all involved tokens. Unknown token: "+JSON.stringify(e));if(o[t])return;o[t]=!0;let l=a.get(e)||new Set;if(l=Array.from(l),t=l.length){i.add(e);do{const e=l[--t];u(e,s.get(e),i)}while(t);i.delete(e)}r[--n]=e}}function l(e,t,n,r){var o,i,a;if(void 0===e.value)throw new Error('Token value is undefined for "'+[...n,t].join(".")+'"');switch(typeof e.value){case"string":case"number":break;default:throw new Error('Token value is not a string or a number for "'+[...n,t].join(".")+'"')}const s=String(e.value);return{value:s,cssValue:e=>f(s,e),name:String(null!=(o=e.name)?o:"")||t,comment:String(null!=(i=e.comment)?i:"")||void 0,metadata:{name:String(null!=(a=e.name)?a:"")?t:void 0,path:[...n,t],filePath:r,isSource:!0}}}const c=new Map;function f(e,t){if(!e)return"";if(!t)return e;if(!t.toUnit)return e;const n=i.default.unit(null!=e?e:"");if(!n||n.unit===t.toUnit)return e;if(!n.unit){if(c.has(t.toUnit)){if(c.get(t.toUnit))return`${e}${t.toUnit}`;throw new Error(`Invalid unit "${t.toUnit}" for "${e}"`)}try{const n=i.default.unit(`${e}${t.toUnit}`);if(n&&n.unit===t.toUnit)return c.set(t.toUnit,!0),`${e}${t.toUnit}`;c.set(t.toUnit,!1)}catch(e){c.set(t.toUnit,!1)}throw new Error(`Invalid unit "${t.toUnit}" for "${e}"`)}var r,o,a,s;return"rem"===n.unit&&"px"===t.toUnit?function(e,t){return`${d(e*t)}px`}(parseFloat(n.number),null!=(r=null==(o=t.pluginOptions)?void 0:o.rootFontSize)?r:16):"px"===n.unit&&"rem"===t.toUnit?function(e,t){return`${d(e/t)}rem`}(parseFloat(n.number),null!=(a=null==(s=t.pluginOptions)?void 0:s.rootFontSize)?a:16):e}function d(e){if(Number.isInteger(e))return e.toString();let t=e.toFixed(5);for(let e=t.length;e>0&&"."!==t[e];e--)"0"===t[e]||(t=t.slice(0,e+1));return t}function p(e){if("string"!=typeof e)return[];if(-1===e.indexOf("{"))return[];const t=[];let n=!1,r=!1,o="";for(let i=0;i<e.length;i++){const a=e[i];switch(a){case"{":if(r)throw new Error('Unexpected "{" in "'+e+'" at '+i);o.length>0&&(t.push({type:"value-non-reference",value:o}),o=""),r=!0;break;case"}":if(!r)throw new Error('Unexpected "}" in "'+e+'" at '+i);if(0===o.length)throw new Error('Empty alias "{}" in "'+e+'" at '+i);{let e=o.trim();".value"===e.slice(-6)&&(e=e.slice(0,-6)),t.push({type:"value-reference",raw:e}),o=""}n=!0,r=!1;break;default:o+=a}}if(r)throw new Error('Unexpected end of alias in "'+e+'"');return o.length>0&&t.push({type:"value-non-reference",value:o}),n?t:[]}function w(e,t,n){const r=new Map;for(const o in e)if(Object.hasOwnProperty.call(e,o)){if(null===e[o]||"object"!=typeof e[o]||Array.isArray(e[o]))throw new Error(`Parsing error at "${[...t,o].join(".")}"`);const i=Object(e[o]);if(!i)throw new Error(`Parsing error at "${[...t,o].join(".")}"`);if(void 0!==i.value){const e=l(i,o,t,n);r.set(e.metadata.path.join("."),e);continue}for(const[e,a]of w(i,[...t,o],n).entries())r.set(e,a)}return r}function h(e,t){return function(e){const t=new Set,n=new Map;for(const[r,o]of e.entries()){const e=p(o.value);e.length&&(t.add(r),n.set(r,e))}for(const[r,o]of n.entries()){for(let n=0;n<o.length;n++){const r=o[n];if("value-reference"!==r.type)continue;if(t.has(r.raw))continue;if(!e.has(r.raw))throw new Error('Alias "'+r.raw+'" not found');const i=e.get(r.raw);o[n]={type:"value-resolved",raw:r.raw,value:i.cssValue()}}if(o.some((e=>"value-reference"===e.type)))continue;const i=o.map((e=>e.value)).join(""),a=e.get(r);a.value=i,a.cssValue=e=>f(i,e),e.set(r,a),t.delete(r),n.delete(r)}if(0===t.size)return e;{const r=Array.from(e.keys()),o=[];for(const[e,t]of n.entries())for(let n=0;n<t.length;n++){const r=t[n];"value-reference"===r.type&&o.push([r.raw,e])}const i=u(r,o);if(!i)throw new Error("Circular reference detected");for(const r of i){if(!n.has(r))continue;const o=n.get(r);for(let n=0;n<o.length;n++){const r=o[n];if("value-reference"!==r.type)continue;if(t.has(r.raw))throw new Error('Alias "'+r.raw+'" can not be resolved');if(!e.has(r.raw))throw new Error('Alias "'+r.raw+'" not found');const i=e.get(r.raw);o[n]={type:"value-resolved",raw:r.raw,value:i.cssValue()}}if(o.some((e=>"value-reference"===e.type)))throw new Error('Token "'+r+'" can not be fully resolved');const i=o.map((e=>e.value)).join(""),a=e.get(r);a.value=i,a.cssValue=e=>f(i,e),e.set(r,a),t.delete(r),n.delete(r)}if(0===t.size)return e}return e}(w(e,[],t))}function v(e,t,n){if("3"===e)return h(t,n);throw new Error("Unsupported version: "+e)}const m="6b4e71e7-4787-42f7-a092-8684961895db",g=s.default.createRequire("undefined"==typeof document?new(require("url").URL)("file:"+__filename).href:document.currentScript&&document.currentScript.src||new URL("index.cjs",document.baseURI).href);async function y(e,t,r,o){const{filePath:s,format:u,conditions:l}=function(e){const t=i.default(e),n={filePath:"",format:"standard",conditions:[m]};return t.walk((e=>{"function"===e.type&&"url"===e.value&&(n.filePath=e.nodes[0].value),"function"===e.type&&"format"===e.value&&(n.format=e.nodes[0].value),"function"===e.type&&"when"===e.value&&(n.conditions=e.nodes.filter((e=>"string"===e.type)).map((e=>e.value)))})),n.conditions.length||(n.conditions=[m]),n}(r);if(!l.every((t=>e.includes(t))))return!1;let c="";if(s.startsWith("node_modules://"))try{c=g.resolve(s.slice(15),{paths:[a.default.dirname(t)]})}catch(e){throw new Error(`Failed to read ${s} with error ${e.message}`)}else c=a.default.resolve(a.default.dirname(t),s);if(o.has(c))return!1;o.add(c);const f=await n.promises.readFile(c,"utf8"),d=JSON.parse(f);if("style-dictionary3"===u)return{filePath:a.default.resolve(s),tokens:v("3",d,c)};throw new Error("Unsupported format: "+u)}function k(e,t){const n=new Map(e);for(const[e,r]of t)n.set(e,r);return n}function E(e){const t={importAtRuleName:"design-tokens",is:[m],unitsAndValues:{rootFontSize:16},valueFunctionName:"design-token"};return e?("object"!=typeof e||(Array.isArray(e.is)&&(t.is=e.is.filter((e=>"string"==typeof e))),0===t.is.length&&(t.is=[m]),"object"==typeof e.unitsAndValues&&"number"==typeof e.unitsAndValues.rootFontSize&&((n=e.unitsAndValues.rootFontSize)>0&&n!==1/0)&&(t.unitsAndValues.rootFontSize=e.unitsAndValues.rootFontSize),"string"==typeof e.valueFunctionName&&(t.valueFunctionName=e.valueFunctionName),"string"==typeof e.importAtRuleName&&(t.importAtRuleName=e.importAtRuleName)),t):t;var n}const S=e=>{const t=E(e);return{postcssPlugin:"postcss-design-tokens",prepare(){let e=new Map,n=new Set;return{OnceExit(){e=new Map,n=new Set},Once:async(r,{result:o})=>{const i=[];r.walkAtRules((e=>{var n,r;if(e.name.toLowerCase()!==t.importAtRuleName)return;if(null==e||null==(n=e.source)||null==(r=n.input)||!r.file)return;const o=e.source.input.file,a=e.params;e.remove(),i.push({filePath:o,params:a,node:e})}));for(const r of i.values()){let i;try{if(i=await y(t.is,r.filePath,r.params,n),!i)continue}catch(e){r.node.warn(o,`Failed to import design tokens from "${r.params}" with error:\n\t`+e.message);continue}o.messages.push({type:"dependency",plugin:"postcss-design-tokens",file:i.filePath,parent:r.filePath}),e=k(e,i.tokens)}},Declaration(n,{result:r}){if(!n.value.toLowerCase().includes(t.valueFunctionName))return;const o=function(e,t,n,r){const o=i.default(n.value);return o.walk((o=>{if("function"!==o.type||o.value.toLowerCase()!==r.valueFunctionName)return;if(!o.nodes||0===o.nodes.length)return void n.warn(t,"Expected at least a single string literal for the design-token function.");if("string"!==o.nodes[0].type)return void n.warn(t,"Expected at least a single string literal for the design-token function.");const i=o.nodes[0].value,a=e.get(i);if(!a)return void n.warn(t,`design-token: "${i}" is not configured.`);const s=o.nodes.slice(1).filter((e=>"word"===e.type));if(!s.length)return o.value=a.cssValue(),void(o.nodes=void 0);const u={pluginOptions:r.unitsAndValues};for(let e=0;e<s.length;e++)"word"===s[e].type&&"to"===s[e].value.toLowerCase()&&s[e+1]&&"word"===s[e+1].type&&(u.toUnit=s[e+1].value,e++);try{o.value=a.cssValue(u)}catch(e){return void n.warn(t,e.message)}o.nodes=void 0})),String(o)}(e,r,n,t);o!==n.value&&(n.value=o)}}}}};S.postcss=!0,module.exports=S;
