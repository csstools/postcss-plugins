import{tokenize as e,TokenType as r}from"@csstools/css-tokenizer";import{isFunctionNode as o,isWhitespaceNode as t,isCommentNode as n,isSimpleBlockNode as s,walk as a,isTokenNode as c,replaceComponentValues as l,parseCommaSeparatedListOfComponentValues as i,FunctionNode as u,TokenNode as p,WhitespaceNode as f,stringify as v}from"@csstools/css-parser-algorithms";function hasFallback(e){const r=e.parent;if(!r)return!1;const o=e.prop.toLowerCase(),t=r.index(e);for(let e=0;e<t;e++){const t=r.nodes[e];if("decl"===t.type&&t.prop.toLowerCase()===o)return!0}return!1}function hasSupportsAtRuleAncestor(e){let r=e.parent;for(;r;)if("atrule"===r.type){if("supports"===r.name.toLowerCase()&&-1!==r.params.toLowerCase().indexOf("light-dark("))return!0;r=r.parent}else r=r.parent;return!1}const d=/dark/i,m=/light/i;function colorSchemes(o){const t=e({css:o});let n=!1,s=!1;return t.forEach((e=>{e[0]===r.Ident&&(m.test(e[4].value)?n=!0:d.test(e[4].value)&&(s=!0))})),[n,s]}const h=/^light-dark$/i;function isComma(e){return c(e)&&e.value[0]===r.Comma}function parseLightDark(e){if(!o(e)||!h.test(e.getName()))return!1;const r=e.value.filter((e=>!t(e)&&!n(e)&&!s(e)));if(3!==r.length)return!1;let c=r[0];const l=r[1];let i=r[2];if(!c||!l||!i)return!1;if(!isComma(l))return!1;if(isComma(c)||isComma(i))return!1;if(o(c)){const e=[c];a(e,(({node:e,parent:r},o)=>{recurseLightDark(e,r,o,!0)})),[c]=e}if(o(i)){const e=[i];a(e,(({node:e,parent:r},o)=>{recurseLightDark(e,r,o,!1)})),[i]=e}return[c,i]}function recurseLightDark(e,r,t,n){if("number"!=typeof t)return;const s=parseLightDark(e);if(!s)return;let c=s[n?0:1];if(o(c)){const e=[c];a(e,(({node:e,parent:r},o)=>{recurseLightDark(e,r,o,n)})),[c]=e}r.value[t]=c}const g="--csstools-color-scheme--light",k="--csstools-color-scheme--dark",w="initial",C=" ";function transformLightDark(o){const t=l(i(e({css:o})),(e=>{const o=parseLightDark(e);if(!o)return;const[t,n]=o;return[new u([r.Function,"var(",-1,-1,{value:"var"}],[r.CloseParen,")",-1,-1,void 0],[new p([r.Ident,g,-1,-1,{value:g}]),new p([r.Comma,",",-1,-1,void 0]),new f([[r.Whitespace," ",-1,-1,void 0]]),t]),new f([[r.Whitespace," ",-1,-1,void 0]]),new u([r.Function,"var(",-1,-1,{value:"var"}],[r.CloseParen,")",-1,-1,void 0],[new p([r.Ident,k,-1,-1,{value:k}]),new p([r.Comma,",",-1,-1,void 0]),new f([[r.Whitespace," ",-1,-1,void 0]]),n])]}));return v(t)}const L=/color-scheme/i,D=/light-dark\(/i,creator=e=>{const r=Object.assign({preserve:!0},e);return{postcssPlugin:"postcss-light-dark-function",prepare(){let e,o=!1;return{Declaration(t,{atRule:n}){const s=t.parent;if(s){if(L.test(t.prop)){const[e,r]=colorSchemes(t.value);if(e&&r){t.cloneBefore({prop:g,value:w}),t.cloneBefore({prop:k,value:C});const e=s.clone();e.removeAll(),e.append(t.clone({prop:g,value:C})),e.append(t.clone({prop:k,value:w}));const r=n({name:"media",params:"(prefers-color-scheme: dark)",source:s.source});return r.append(e),void s.after(r)}return r?(t.cloneBefore({prop:g,value:C}),void t.cloneBefore({prop:k,value:w})):e?(t.cloneBefore({prop:g,value:w}),void t.cloneBefore({prop:k,value:C})):void 0}if(D.test(t.value)){if(hasFallback(t))return;if(hasSupportsAtRuleAncestor(t))return;const n=transformLightDark(t.value);if(n===t.value)return;o=!0,e||(e=t.source),t.cloneBefore({value:n}),r.preserve||t.remove()}}},OnceExit(r,{atRule:t,rule:n,decl:s}){if(!o||!e)return;const a=s({prop:g,value:w}),c=s({prop:k,value:C});a.source=e,c.source=e;{const o=n({selector:":root",source:e});o.append(a,c),r.append(o)}{const o=n({selector:":root",source:e});o.append(a.clone({value:C}),c.clone({value:w}));const s=t({name:"media",params:"(prefers-color-scheme: dark)",source:e});s.append(o),r.append(s)}}}}}};creator.postcss=!0;export{creator as default};
