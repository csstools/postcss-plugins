import e from"@csstools/postcss-progressive-custom-properties";import{tokenize as r,TokenType as o}from"@csstools/css-tokenizer";import{hasFallback as t,hasSupportsAtRuleAncestor as s}from"@csstools/utilities";import{isFunctionNode as n,isWhitespaceNode as a,isCommentNode as c,walk as i,isTokenNode as l,replaceComponentValues as u,parseCommaSeparatedListOfComponentValues as p,FunctionNode as v,TokenNode as f,WhitespaceNode as m,stringify as d}from"@csstools/css-parser-algorithms";const h="--csstools-color-scheme--light",g="--csstools-color-scheme--dark",k="initial",C=" ",D=/dark/i,w=/light/i;function colorSchemes(e){const t=r({css:e});let s=!1,n=!1;return t.forEach((e=>{e[0]===o.Ident&&(w.test(e[4].value)?s=!0:D.test(e[4].value)&&(n=!0))})),[s,n]}const L=/^light-dark$/i;function isComma(e){return l(e)&&e.value[0]===o.Comma}function parseLightDark(e){if(!n(e)||!L.test(e.getName()))return!1;const r=e.value.filter((e=>!a(e)&&!c(e)));if(3!==r.length)return!1;let o=r[0];const t=r[1];let s=r[2];if(!o||!t||!s)return!1;if(!isComma(t))return!1;if(isComma(o)||isComma(s))return!1;if(n(o)){const e=[o];i(e,(({node:e,parent:r},o)=>{recurseLightDark(e,r,o,!0)})),[o]=e}if(n(s)){const e=[s];i(e,(({node:e,parent:r},o)=>{recurseLightDark(e,r,o,!1)})),[s]=e}return[o,s]}function recurseLightDark(e,r,o,t){if("number"!=typeof o)return;const s=parseLightDark(e);if(!s)return;let a=s[t?0:1];if(n(a)){const e=[a];i(e,(({node:e,parent:r},o)=>{recurseLightDark(e,r,o,t)})),[a]=e}r.value[o]=a}function transformLightDark(e){const t=u(p(r({css:e})),(e=>{const r=parseLightDark(e);if(!r)return;const[t,s]=r;return[new v([o.Function,"var(",-1,-1,{value:"var"}],[o.CloseParen,")",-1,-1,void 0],[new f([o.Ident,h,-1,-1,{value:h}]),new f([o.Comma,",",-1,-1,void 0]),new m([[o.Whitespace," ",-1,-1,void 0]]),t]),new m([[o.Whitespace," ",-1,-1,void 0]]),new v([o.Function,"var(",-1,-1,{value:"var"}],[o.CloseParen,")",-1,-1,void 0],[new f([o.Ident,g,-1,-1,{value:g}]),new f([o.Comma,",",-1,-1,void 0]),new m([[o.Whitespace," ",-1,-1,void 0]]),s])]}));return d(t)}const P=/^color-scheme$/i,B=/\blight-dark\(/i,basePlugin=e=>({postcssPlugin:"postcss-light-dark-function",prepare(){let r,o=!1;return{postcssPlugin:"postcss-light-dark-function",Declaration(n,{atRule:a,rule:c}){const i=n.parent;if(i){if(P.test(n.prop)){const[e,r]=colorSchemes(n.value);if(e&&r){n.cloneBefore({prop:h,value:k}),n.cloneBefore({prop:g,value:C});const e=i.clone();e.removeAll(),e.append(n.clone({prop:h,value:C})),e.append(n.clone({prop:g,value:k}));const r=a({name:"media",params:"(prefers-color-scheme: dark)",source:i.source});return r.append(e),void i.after(r)}return r?(n.cloneBefore({prop:h,value:C}),void n.cloneBefore({prop:g,value:k})):e?(n.cloneBefore({prop:h,value:k}),void n.cloneBefore({prop:g,value:C})):void 0}if(B.test(n.value)){if(t(n))return;if(s(n,B))return;const a=transformLightDark(n.value);if(a===n.value)return;if(o=!0,r||(r=n.source),n.cloneBefore({value:a}),n.variable&&n.parent){const e=c({selector:"& *",source:n.source});e.append(n.clone({value:a})),n.parent.append(e)}e?.preserve||n.remove()}}},OnceExit(e,{atRule:t,rule:s,decl:n}){if(!o||!r)return;const a=n({prop:h,value:k}),c=n({prop:g,value:C});a.source=r,c.source=r;{const o=s({selector:":root",source:r});o.append(a,c),e.append(o)}{const o=s({selector:":root",source:r});o.append(a.clone({value:C}),c.clone({value:k}));const n=t({name:"media",params:"(prefers-color-scheme: dark)",source:r});n.append(o),e.append(n)}}}}});basePlugin.postcss=!0;const postcssPlugin=r=>{const o=Object.assign({enableProgressiveCustomProperties:!0,preserve:!0},r);return o.enableProgressiveCustomProperties&&o.preserve?{postcssPlugin:"postcss-light-dark-function",plugins:[e(),basePlugin(o)]}:basePlugin(o)};postcssPlugin.postcss=!0;export{postcssPlugin as default};
