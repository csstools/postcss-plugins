import e from"@csstools/postcss-progressive-custom-properties";import{tokenize as r,TokenType as o}from"@csstools/css-tokenizer";import{hasFallback as t,hasSupportsAtRuleAncestor as s}from"@csstools/utilities";import{isFunctionNode as n,isWhitespaceNode as a,isCommentNode as c,isSimpleBlockNode as i,walk as l,isTokenNode as u,replaceComponentValues as p,parseCommaSeparatedListOfComponentValues as v,FunctionNode as f,TokenNode as m,WhitespaceNode as d,stringify as h}from"@csstools/css-parser-algorithms";const g="--csstools-color-scheme--light",k="--csstools-color-scheme--dark",C="initial",D=" ",w=/dark/i,L=/light/i;function colorSchemes(e){const t=r({css:e});let s=!1,n=!1;return t.forEach((e=>{e[0]===o.Ident&&(L.test(e[4].value)?s=!0:w.test(e[4].value)&&(n=!0))})),[s,n]}const P=/^light-dark$/i;function isComma(e){return u(e)&&e.value[0]===o.Comma}function parseLightDark(e){if(!n(e)||!P.test(e.getName()))return!1;const r=e.value.filter((e=>!a(e)&&!c(e)&&!i(e)));if(3!==r.length)return!1;let o=r[0];const t=r[1];let s=r[2];if(!o||!t||!s)return!1;if(!isComma(t))return!1;if(isComma(o)||isComma(s))return!1;if(n(o)){const e=[o];l(e,(({node:e,parent:r},o)=>{recurseLightDark(e,r,o,!0)})),[o]=e}if(n(s)){const e=[s];l(e,(({node:e,parent:r},o)=>{recurseLightDark(e,r,o,!1)})),[s]=e}return[o,s]}function recurseLightDark(e,r,o,t){if("number"!=typeof o)return;const s=parseLightDark(e);if(!s)return;let a=s[t?0:1];if(n(a)){const e=[a];l(e,(({node:e,parent:r},o)=>{recurseLightDark(e,r,o,t)})),[a]=e}r.value[o]=a}function transformLightDark(e){const t=p(v(r({css:e})),(e=>{const r=parseLightDark(e);if(!r)return;const[t,s]=r;return[new f([o.Function,"var(",-1,-1,{value:"var"}],[o.CloseParen,")",-1,-1,void 0],[new m([o.Ident,g,-1,-1,{value:g}]),new m([o.Comma,",",-1,-1,void 0]),new d([[o.Whitespace," ",-1,-1,void 0]]),t]),new d([[o.Whitespace," ",-1,-1,void 0]]),new f([o.Function,"var(",-1,-1,{value:"var"}],[o.CloseParen,")",-1,-1,void 0],[new m([o.Ident,k,-1,-1,{value:k}]),new m([o.Comma,",",-1,-1,void 0]),new d([[o.Whitespace," ",-1,-1,void 0]]),s])]}));return h(t)}const B=/^color-scheme$/i,b=/\blight-dark\(/i,basePlugin=e=>({postcssPlugin:"postcss-light-dark-function",prepare(){let r,o=!1;return{Declaration(n,{atRule:a,rule:c}){const i=n.parent;if(i){if(B.test(n.prop)){const[e,r]=colorSchemes(n.value);if(e&&r){n.cloneBefore({prop:g,value:C}),n.cloneBefore({prop:k,value:D});const e=i.clone();e.removeAll(),e.append(n.clone({prop:g,value:D})),e.append(n.clone({prop:k,value:C}));const r=a({name:"media",params:"(prefers-color-scheme: dark)",source:i.source});return r.append(e),void i.after(r)}return r?(n.cloneBefore({prop:g,value:D}),void n.cloneBefore({prop:k,value:C})):e?(n.cloneBefore({prop:g,value:C}),void n.cloneBefore({prop:k,value:D})):void 0}if(b.test(n.value)){if(t(n))return;if(s(n,b))return;const a=transformLightDark(n.value);if(a===n.value)return;if(o=!0,r||(r=n.source),n.cloneBefore({value:a}),n.variable&&n.parent){const e=c({selector:"& *",source:n.source});e.append(n.clone({value:a})),n.parent.append(e)}e?.preserve||n.remove()}}},OnceExit(e,{atRule:t,rule:s,decl:n}){if(!o||!r)return;const a=n({prop:g,value:C}),c=n({prop:k,value:D});a.source=r,c.source=r;{const o=s({selector:":root",source:r});o.append(a,c),e.append(o)}{const o=s({selector:":root",source:r});o.append(a.clone({value:D}),c.clone({value:C}));const n=t({name:"media",params:"(prefers-color-scheme: dark)",source:r});n.append(o),e.append(n)}}}}});basePlugin.postcss=!0;const postcssPlugin=r=>{const o=Object.assign({enableProgressiveCustomProperties:!0,preserve:!0},r);return o.enableProgressiveCustomProperties&&o.preserve?{postcssPlugin:"postcss-light-dark-function",plugins:[e(),basePlugin(o)]}:basePlugin(o)};postcssPlugin.postcss=!0;export{postcssPlugin as default};
