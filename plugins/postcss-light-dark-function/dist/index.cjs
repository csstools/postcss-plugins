"use strict";var e=require("@csstools/css-tokenizer"),o=require("@csstools/css-parser-algorithms");function hasFallback(e){const o=e.parent;if(!o)return!1;const r=e.prop.toLowerCase(),n=o.index(e);for(let e=0;e<n;e++){const n=o.nodes[e];if("decl"===n.type&&n.prop.toLowerCase()===r)return!0}return!1}function hasSupportsAtRuleAncestor(e){let o=e.parent;for(;o;)if("atrule"===o.type){if("supports"===o.name.toLowerCase()&&-1!==o.params.toLowerCase().indexOf("light-dark("))return!0;o=o.parent}else o=o.parent;return!1}const r=/dark/i,n=/light/i;function colorSchemes(o){const t=e.tokenize({css:o});let s=!1,a=!1;return t.forEach((o=>{o[0]===e.TokenType.Ident&&(n.test(o[4].value)?s=!0:r.test(o[4].value)&&(a=!0))})),[s,a]}const t=/^light-dark$/i;function isComma(r){return o.isTokenNode(r)&&r.value[0]===e.TokenType.Comma}function parseLightDark(e){if(!o.isFunctionNode(e)||!t.test(e.getName()))return!1;const r=e.value.filter((e=>!o.isWhitespaceNode(e)&&!o.isCommentNode(e)&&!o.isSimpleBlockNode(e)));if(3!==r.length)return!1;let n=r[0];const s=r[1];let a=r[2];if(!n||!s||!a)return!1;if(!isComma(s))return!1;if(isComma(n)||isComma(a))return!1;if(o.isFunctionNode(n)){const e=[n];o.walk(e,(({node:e,parent:o},r)=>{recurseLightDark(e,o,r,!0)})),[n]=e}if(o.isFunctionNode(a)){const e=[a];o.walk(e,(({node:e,parent:o},r)=>{recurseLightDark(e,o,r,!1)})),[a]=e}return[n,a]}function recurseLightDark(e,r,n,t){if("number"!=typeof n)return;const s=parseLightDark(e);if(!s)return;let a=s[t?0:1];if(o.isFunctionNode(a)){const e=[a];o.walk(e,(({node:e,parent:o},r)=>{recurseLightDark(e,o,r,t)})),[a]=e}r.value[n]=a}const s="--csstools-color-scheme--light",a="--csstools-color-scheme--dark",c="initial",i=" ";function transformLightDark(r){const n=o.replaceComponentValues(o.parseCommaSeparatedListOfComponentValues(e.tokenize({css:r})),(r=>{const n=parseLightDark(r);if(!n)return;const[t,c]=n;return[new o.FunctionNode([e.TokenType.Function,"var(",-1,-1,{value:"var"}],[e.TokenType.CloseParen,")",-1,-1,void 0],[new o.TokenNode([e.TokenType.Ident,s,-1,-1,{value:s}]),new o.TokenNode([e.TokenType.Comma,",",-1,-1,void 0]),new o.WhitespaceNode([[e.TokenType.Whitespace," ",-1,-1,void 0]]),t]),new o.WhitespaceNode([[e.TokenType.Whitespace," ",-1,-1,void 0]]),new o.FunctionNode([e.TokenType.Function,"var(",-1,-1,{value:"var"}],[e.TokenType.CloseParen,")",-1,-1,void 0],[new o.TokenNode([e.TokenType.Ident,a,-1,-1,{value:a}]),new o.TokenNode([e.TokenType.Comma,",",-1,-1,void 0]),new o.WhitespaceNode([[e.TokenType.Whitespace," ",-1,-1,void 0]]),c])]}));return o.stringify(n)}const p=/color-scheme/i,u=/light-dark\(/i,creator=e=>{const o=Object.assign({preserve:!0},e);return{postcssPlugin:"postcss-light-dark-function",prepare(){let e,r=!1;return{Declaration(n,{atRule:t}){const l=n.parent;if(l){if(p.test(n.prop)){const[e,o]=colorSchemes(n.value);if(e&&o){n.cloneBefore({prop:s,value:c}),n.cloneBefore({prop:a,value:i});const e=l.clone();e.removeAll(),e.append(n.clone({prop:s,value:i})),e.append(n.clone({prop:a,value:c}));const o=t({name:"media",params:"(prefers-color-scheme: dark)",source:l.source});return o.append(e),void l.after(o)}return o?(n.cloneBefore({prop:s,value:i}),void n.cloneBefore({prop:a,value:c})):e?(n.cloneBefore({prop:s,value:c}),void n.cloneBefore({prop:a,value:i})):void 0}if(u.test(n.value)){if(hasFallback(n))return;if(hasSupportsAtRuleAncestor(n))return;const t=transformLightDark(n.value);if(t===n.value)return;r=!0,e||(e=n.source),n.cloneBefore({value:t}),o.preserve||n.remove()}}},OnceExit(o,{atRule:n,rule:t,decl:p}){if(!r||!e)return;const u=p({prop:s,value:c}),l=p({prop:a,value:i});u.source=e,l.source=e;{const r=t({selector:":root",source:e});r.append(u,l),o.append(r)}{const r=t({selector:":root",source:e});r.append(u.clone({value:i}),l.clone({value:c}));const s=n({name:"media",params:"(prefers-color-scheme: dark)",source:e});s.append(r),o.append(s)}}}}}};creator.postcss=!0,module.exports=creator;
