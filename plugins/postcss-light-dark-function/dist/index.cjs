"use strict";var e=require("@csstools/postcss-progressive-custom-properties"),o=require("@csstools/css-tokenizer"),r=require("@csstools/css-parser-algorithms");const t="--csstools-color-scheme--light",n="--csstools-color-scheme--dark",s="initial",a=" ",c=/dark/i,i=/light/i;function colorSchemes(e){const r=o.tokenize({css:e});let t=!1,n=!1;return r.forEach((e=>{e[0]===o.TokenType.Ident&&(i.test(e[4].value)?t=!0:c.test(e[4].value)&&(n=!0))})),[t,n]}function hasFallback(e){const o=e.parent;if(!o)return!1;const r=e.prop.toLowerCase(),t=o.index(e);for(let e=0;e<t;e++){const t=o.nodes[e];if("decl"===t.type&&t.prop.toLowerCase()===r)return!0}return!1}function hasSupportsAtRuleAncestor(e){let o=e.parent;for(;o;)if("atrule"===o.type){if("supports"===o.name.toLowerCase()&&-1!==o.params.toLowerCase().indexOf("light-dark("))return!0;o=o.parent}else o=o.parent;return!1}const p=/^light-dark$/i;function isComma(e){return r.isTokenNode(e)&&e.value[0]===o.TokenType.Comma}function parseLightDark(e){if(!r.isFunctionNode(e)||!p.test(e.getName()))return!1;const o=e.value.filter((e=>!r.isWhitespaceNode(e)&&!r.isCommentNode(e)&&!r.isSimpleBlockNode(e)));if(3!==o.length)return!1;let t=o[0];const n=o[1];let s=o[2];if(!t||!n||!s)return!1;if(!isComma(n))return!1;if(isComma(t)||isComma(s))return!1;if(r.isFunctionNode(t)){const e=[t];r.walk(e,(({node:e,parent:o},r)=>{recurseLightDark(e,o,r,!0)})),[t]=e}if(r.isFunctionNode(s)){const e=[s];r.walk(e,(({node:e,parent:o},r)=>{recurseLightDark(e,o,r,!1)})),[s]=e}return[t,s]}function recurseLightDark(e,o,t,n){if("number"!=typeof t)return;const s=parseLightDark(e);if(!s)return;let a=s[n?0:1];if(r.isFunctionNode(a)){const e=[a];r.walk(e,(({node:e,parent:o},r)=>{recurseLightDark(e,o,r,n)})),[a]=e}o.value[t]=a}function transformLightDark(e){const s=r.replaceComponentValues(r.parseCommaSeparatedListOfComponentValues(o.tokenize({css:e})),(e=>{const s=parseLightDark(e);if(!s)return;const[a,c]=s;return[new r.FunctionNode([o.TokenType.Function,"var(",-1,-1,{value:"var"}],[o.TokenType.CloseParen,")",-1,-1,void 0],[new r.TokenNode([o.TokenType.Ident,t,-1,-1,{value:t}]),new r.TokenNode([o.TokenType.Comma,",",-1,-1,void 0]),new r.WhitespaceNode([[o.TokenType.Whitespace," ",-1,-1,void 0]]),a]),new r.WhitespaceNode([[o.TokenType.Whitespace," ",-1,-1,void 0]]),new r.FunctionNode([o.TokenType.Function,"var(",-1,-1,{value:"var"}],[o.TokenType.CloseParen,")",-1,-1,void 0],[new r.TokenNode([o.TokenType.Ident,n,-1,-1,{value:n}]),new r.TokenNode([o.TokenType.Comma,",",-1,-1,void 0]),new r.WhitespaceNode([[o.TokenType.Whitespace," ",-1,-1,void 0]]),c])]}));return r.stringify(s)}const u=/color-scheme/i,l=/light-dark\(/i,basePlugin=e=>{const o=Object.assign({preserve:!0},e);return{postcssPlugin:"postcss-light-dark-function",prepare(){let e,r=!1;return{Declaration(c,{atRule:i,rule:p}){const d=c.parent;if(d){if(u.test(c.prop)){const[e,o]=colorSchemes(c.value);if(e&&o){c.cloneBefore({prop:t,value:s}),c.cloneBefore({prop:n,value:a});const e=d.clone();e.removeAll(),e.append(c.clone({prop:t,value:a})),e.append(c.clone({prop:n,value:s}));const o=i({name:"media",params:"(prefers-color-scheme: dark)",source:d.source});return o.append(e),void d.after(o)}return o?(c.cloneBefore({prop:t,value:a}),void c.cloneBefore({prop:n,value:s})):e?(c.cloneBefore({prop:t,value:s}),void c.cloneBefore({prop:n,value:a})):void 0}if(l.test(c.value)){if(hasFallback(c))return;if(hasSupportsAtRuleAncestor(c))return;const t=transformLightDark(c.value);if(t===c.value)return;if(r=!0,e||(e=c.source),c.cloneBefore({value:t}),c.variable&&c.parent){const e=p({selector:"& *",source:c.source});e.append(c.clone({value:t})),c.parent.append(e)}o.preserve||c.remove()}}},OnceExit(o,{atRule:c,rule:i,decl:p}){if(!r||!e)return;const u=p({prop:t,value:s}),l=p({prop:n,value:a});u.source=e,l.source=e;{const r=i({selector:":root",source:e});r.append(u,l),o.append(r)}{const r=i({selector:":root",source:e});r.append(u.clone({value:a}),l.clone({value:s}));const t=c({name:"media",params:"(prefers-color-scheme: dark)",source:e});t.append(r),o.append(t)}}}}}};basePlugin.postcss=!0;const postcssPlugin=o=>{const r=Object.assign({enableProgressiveCustomProperties:!0,preserve:!0},o);return r.enableProgressiveCustomProperties&&r.preserve?{postcssPlugin:"postcss-light-dark-function",plugins:[e(),basePlugin(r)]}:basePlugin(r)};postcssPlugin.postcss=!0,module.exports=postcssPlugin;
