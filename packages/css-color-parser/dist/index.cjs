"use strict";var e,a,n=require("@csstools/css-parser-algorithms"),o=require("@csstools/css-tokenizer"),t=require("@csstools/color-helpers"),r=require("@csstools/css-calc");exports.ColorSpace=void 0,(e=exports.ColorSpace||(exports.ColorSpace={})).XYZ_D50="xyz-d50",e.XYZ_D65="xyz-d65",e.sRGB="srgb",exports.SyntaxFlag=void 0,(a=exports.SyntaxFlag||(exports.SyntaxFlag={})).ColorKeyword="color-keyword",a.HasAlpha="has-alpha",a.HasDimensionValues="has-dimension-values",a.HasNoneKeywords="has-none-keywords",a.HasNumberValues="has-number-values",a.HasPercentageAlpha="has-percentage-alpha",a.HasPercentageValues="has-percentage-values",a.HasVariableAlpha="has-variable-alpha",a.Hex="hex",a.LegacyHSL="legacy-hsl",a.LegacyRGB="legacy-rgb",a.NamedColor="named-color",a.RelativeColorSyntax="relative-color-syntax";const s=/[A-Z]/g;function toLowerCaseAZ(e){return e.replace(s,(e=>String.fromCharCode(e.charCodeAt(0)+32)))}function hex(e){const a=toLowerCaseAZ(e[4].value);if(a.match(/[^a-f0-9]/))return!1;const n={colorSpace:exports.ColorSpace.XYZ_D50,channels:[0,0,0],sourceColorSpace:exports.ColorSpace.sRGB,alpha:1,missingComponents:[!1,!1,!1,!1],syntaxFlags:new Set([exports.SyntaxFlag.Hex])},o=a.length;if(3===o){const e=a[0],o=a[1],r=a[2];return n.channels=t.xyz.sRGB_to_XYZ_D50([parseInt(e+e,16)/255,parseInt(o+o,16)/255,parseInt(r+r,16)/255]),n}if(6===o){const e=a[0]+a[1],o=a[2]+a[3],r=a[4]+a[5];return n.channels=t.xyz.sRGB_to_XYZ_D50([parseInt(e,16)/255,parseInt(o,16)/255,parseInt(r,16)/255]),n}if(4===o){const e=a[0],o=a[1],r=a[2],s=a[3];return n.channels=t.xyz.sRGB_to_XYZ_D50([parseInt(e+e,16)/255,parseInt(o+o,16)/255,parseInt(r+r,16)/255]),n.alpha=parseInt(s+s,16)/255,n.syntaxFlags.add(exports.SyntaxFlag.HasAlpha),n}if(8===o){const e=a[0]+a[1],o=a[2]+a[3],r=a[4]+a[5],s=a[6]+a[7];return n.channels=t.xyz.sRGB_to_XYZ_D50([parseInt(e,16)/255,parseInt(o,16)/255,parseInt(r,16)/255]),n.alpha=parseInt(s,16)/255,n.syntaxFlags.add(exports.SyntaxFlag.HasAlpha),n}return!1}function normalizeHue(e){if(e[0]===o.TokenType.Number)return e[4].value=e[4].value%360,e[1]=e[4].value.toString(),e;if(e[0]===o.TokenType.Dimension){let a=e[4].value;switch(toLowerCaseAZ(e[4].unit)){case"deg":break;case"rad":a=180*e[4].value/Math.PI;break;case"grad":a=.9*e[4].value;break;case"turn":a=360*e[4].value;break;default:return!1}return a%=360,[o.TokenType.Number,a.toString(),e[2],e[3],{value:a,type:o.NumberType.Number}]}return!1}function normalize(e,a,n,o){return Math.min(Math.max(e/a,n),o)}function normalize_legacy_HSL_ChannelValues(e,a){const n=[];for(let t=0;t<e.length;t++){const r=e[t];if(0!==t)if(r[0]!==o.TokenType.Percentage){if(r[0]!==o.TokenType.Number)return!1;{3!==t&&a.syntaxFlags.add(exports.SyntaxFlag.HasNumberValues);let e=normalize(r[4].value,1,0,100);3===t&&(e=normalize(r[4].value,1,0,1)),n.push([o.TokenType.Number,e.toString(),r[2],r[3],{value:e,type:o.NumberType.Number}])}}else{3===t?a.syntaxFlags.add(exports.SyntaxFlag.HasPercentageAlpha):a.syntaxFlags.add(exports.SyntaxFlag.HasPercentageValues);let e=normalize(r[4].value,1,0,100);3===t&&(e=normalize(r[4].value,100,0,1)),n.push([o.TokenType.Number,e.toString(),r[2],r[3],{value:e,type:o.NumberType.Number}])}else{const e=normalizeHue(r);if(!1===e)return!1;r[0]===o.TokenType.Dimension&&a.syntaxFlags.add(exports.SyntaxFlag.HasDimensionValues),n.push(e)}}return!a.syntaxFlags.has(exports.SyntaxFlag.HasNumberValues)&&n}function normalize_modern_HSL_ChannelValues(e,a){const n=[];for(let t=0;t<e.length;t++){const r=e[t];if(r[0]!==o.TokenType.Ident||"none"!==toLowerCaseAZ(r[4].value))if(0!==t)if(r[0]!==o.TokenType.Percentage){if(r[0]!==o.TokenType.Number)return!1;{3!==t&&a.syntaxFlags.add(exports.SyntaxFlag.HasNumberValues);let e=normalize(r[4].value,1,0,100);3===t&&(e=normalize(r[4].value,1,0,1)),n.push([o.TokenType.Number,e.toString(),r[2],r[3],{value:e,type:o.NumberType.Number}])}}else{3===t?a.syntaxFlags.add(exports.SyntaxFlag.HasPercentageAlpha):a.syntaxFlags.add(exports.SyntaxFlag.HasPercentageValues);let e=normalize(r[4].value,1,0,100);3===t&&(e=normalize(r[4].value,100,0,1)),n.push([o.TokenType.Number,e.toString(),r[2],r[3],{value:e,type:o.NumberType.Number}])}else{const e=normalizeHue(r);if(!1===e)return!1;r[0]===o.TokenType.Dimension&&a.syntaxFlags.add(exports.SyntaxFlag.HasDimensionValues),n.push(e)}else a.syntaxFlags.add(exports.SyntaxFlag.HasNoneKeywords),a.missingComponents[t]=!0,n.push([o.TokenType.Number,"0",r[2],r[3],{value:0,type:o.NumberType.Number}])}return n}function threeChannelLegacySyntax(e,a,t,s,l){const u=[],i=[],p=[],c=[],y={colorSpace:exports.ColorSpace.XYZ_D50,channels:[0,0,0],sourceColorSpace:t,alpha:1,missingComponents:[!1,!1,!1,!1],syntaxFlags:new Set(l)};let m=u;for(let a=0;a<e.value.length;a++){let t=e.value[a];if(!n.isWhitespaceNode(t)&&!n.isCommentNode(t)){if(n.isTokenNode(t)&&t.value[0]===o.TokenType.Comma){if(m===u){m=i;continue}if(m===i){m=p;continue}if(m===p){m=c;continue}if(m===c)return!1}if(n.isFunctionNode(t)){if(m===c&&"var"===toLowerCaseAZ(t.getName())){y.syntaxFlags.add(exports.SyntaxFlag.HasVariableAlpha),m.push(t);continue}if("calc"!==toLowerCaseAZ(t.getName()))return!1;const[[e]]=r.calcFromComponentValues([[t]],{toCanonicalUnits:!0,precision:100});if(!e||!n.isTokenNode(e))return!1;t=e}if(!n.isTokenNode(t))return!1;m.push(t)}}if(1!==m.length)return!1;if(1!==u.length||1!==i.length||1!==p.length)return!1;if(!n.isTokenNode(u[0])||!n.isTokenNode(i[0])||!n.isTokenNode(p[0]))return!1;const g=[u[0].value,i[0].value,p[0].value];1===c.length&&(y.syntaxFlags.add(exports.SyntaxFlag.HasAlpha),n.isTokenNode(c[0])?g.push(c[0].value):y.alpha=c[0]);const h=a(g,y);return!1!==h&&(y.channels=s([h[0][4].value,h[1][4].value,h[2][4].value]),4===h.length&&(y.alpha=h[3][4].value),y)}function threeChannelSpaceSeparated(e,a,t,s,l){const u=[],i=[],p=[],c=[],y={colorSpace:exports.ColorSpace.XYZ_D50,channels:[0,0,0],sourceColorSpace:t,alpha:1,missingComponents:[!1,!1,!1,!1],syntaxFlags:new Set(l)};let m=u;for(let a=0;a<e.value.length;a++){let t=e.value[a];if(n.isWhitespaceNode(t)||n.isCommentNode(t)){for(;n.isWhitespaceNode(e.value[a+1])||n.isCommentNode(e.value[a+1]);)a++;if(!u.length)continue;if(m===u){m=i;continue}if(m===i){m=p;continue}}else if(n.isTokenNode(t)&&t.value[0]===o.TokenType.Delim&&"/"===t.value[4].value){if(m===c)return!1;m=c}else{if(n.isFunctionNode(t)){if(m===c&&"var"===toLowerCaseAZ(t.getName())){y.syntaxFlags.add(exports.SyntaxFlag.HasVariableAlpha),m.push(t);continue}if("calc"!==toLowerCaseAZ(t.getName()))return!1;const[[e]]=r.calcFromComponentValues([[t]],{toCanonicalUnits:!0,precision:100});if(!e||!n.isTokenNode(e))return!1;t=e}if(!n.isTokenNode(t))return!1;m.push(t)}}if(1!==m.length)return!1;if(1!==u.length||1!==i.length||1!==p.length)return!1;if(!n.isTokenNode(u[0])||!n.isTokenNode(i[0])||!n.isTokenNode(p[0]))return!1;const g=[u[0].value,i[0].value,p[0].value];1===c.length&&(y.syntaxFlags.add(exports.SyntaxFlag.HasAlpha),n.isTokenNode(c[0])?g.push(c[0].value):y.alpha=c[0]);const h=a(g,y);return!1!==h&&(y.channels=s([h[0][4].value,h[1][4].value,h[2][4].value]),4===h.length&&(y.alpha=h[3][4].value),y)}function hsl(e,a){{const a=hslCommaSeparated(e);if(!1!==a)return a}{const a=hslSpaceSeparated(e);if(!1!==a)return a}return!1}function hslCommaSeparated(e){return threeChannelLegacySyntax(e,normalize_legacy_HSL_ChannelValues,exports.ColorSpace.sRGB,t.xyz.HSL_to_XYZ_D50,[exports.SyntaxFlag.LegacyHSL])}function hslSpaceSeparated(e){return threeChannelSpaceSeparated(e,normalize_modern_HSL_ChannelValues,exports.ColorSpace.sRGB,t.xyz.HSL_to_XYZ_D50,[])}function normalize_HWB_ChannelValues(e,a){const n=[];for(let t=0;t<e.length;t++){const r=e[t];if(r[0]!==o.TokenType.Ident||"none"!==toLowerCaseAZ(r[4].value))if(0!==t)if(r[0]!==o.TokenType.Percentage){if(r[0]!==o.TokenType.Number)return!1;{if(3!==t)return!1;const e=normalize(r[4].value,1,0,1);n.push([o.TokenType.Number,e.toString(),r[2],r[3],{value:e,type:o.NumberType.Number}])}}else{3===t?a.syntaxFlags.add(exports.SyntaxFlag.HasPercentageAlpha):a.syntaxFlags.add(exports.SyntaxFlag.HasPercentageValues);let e=normalize(r[4].value,1,0,100);3===t&&(e=normalize(r[4].value,100,0,1)),n.push([o.TokenType.Number,e.toString(),r[2],r[3],{value:e,type:o.NumberType.Number}])}else{const e=normalizeHue(r);if(!1===e)return!1;r[0]===o.TokenType.Dimension&&a.syntaxFlags.add(exports.SyntaxFlag.HasDimensionValues),n.push(e)}else a.syntaxFlags.add(exports.SyntaxFlag.HasNoneKeywords),a.missingComponents[t]=!0,n.push([o.TokenType.Number,"0",r[2],r[3],{value:0,type:o.NumberType.Number}])}return n}function hwb(e,a){{const a=hwbSpaceSeparated(e);if(!1!==a)return a}return!1}function hwbSpaceSeparated(e){return threeChannelSpaceSeparated(e,normalize_HWB_ChannelValues,exports.ColorSpace.sRGB,t.xyz.HWB_to_XYZ_D50,[])}const l=new Map;for(const[e,a]of Object.entries(t.namedColors))l.set(e,a);function namedColor(e){const a=l.get(toLowerCaseAZ(e));return!!a&&{colorSpace:exports.ColorSpace.XYZ_D50,channels:t.xyz.sRGB_to_XYZ_D50([a[0]/255,a[1]/255,a[2]/255]),sourceColorSpace:exports.ColorSpace.sRGB,alpha:1,missingComponents:[!1,!1,!1,!1],syntaxFlags:new Set([exports.SyntaxFlag.ColorKeyword,exports.SyntaxFlag.NamedColor])}}function normalize_legacy_sRGB_ChannelValues(e,a){const n=[];for(let t=0;t<e.length;t++){const r=e[t];if(r[0]!==o.TokenType.Percentage){if(r[0]!==o.TokenType.Number)return!1;{3!==t&&a.syntaxFlags.add(exports.SyntaxFlag.HasNumberValues);let e=normalize(r[4].value,255,0,1);3===t&&(e=normalize(r[4].value,1,0,1)),n.push([o.TokenType.Number,e.toString(),r[2],r[3],{value:e,type:o.NumberType.Number}])}}else{3===t?a.syntaxFlags.add(exports.SyntaxFlag.HasPercentageAlpha):a.syntaxFlags.add(exports.SyntaxFlag.HasPercentageValues);const e=normalize(r[4].value,100,0,1);n.push([o.TokenType.Number,e.toString(),r[2],r[3],{value:e,type:o.NumberType.Number}])}}return(!a.syntaxFlags.has(exports.SyntaxFlag.HasNumberValues)||!a.syntaxFlags.has(exports.SyntaxFlag.HasPercentageValues))&&n}function normalize_modern_sRGB_ChannelValues(e,a){const n=[];for(let t=0;t<e.length;t++){const r=e[t];if(r[0]!==o.TokenType.Ident||"none"!==toLowerCaseAZ(r[4].value))if(r[0]!==o.TokenType.Percentage){if(r[0]!==o.TokenType.Number)return!1;{3!==t&&a.syntaxFlags.add(exports.SyntaxFlag.HasNumberValues);let e=normalize(r[4].value,255,0,1);3===t&&(e=normalize(r[4].value,1,0,1)),n.push([o.TokenType.Number,e.toString(),r[2],r[3],{value:e,type:o.NumberType.Number}])}}else{3!==t&&a.syntaxFlags.add(exports.SyntaxFlag.HasPercentageValues);const e=normalize(r[4].value,100,0,1);n.push([o.TokenType.Number,e.toString(),r[2],r[3],{value:e,type:o.NumberType.Number}])}else a.syntaxFlags.add(exports.SyntaxFlag.HasNoneKeywords),a.missingComponents[t]=!0,n.push([o.TokenType.Number,"0",r[2],r[3],{value:0,type:o.NumberType.Number}])}return n}function rgb(e,a){{const a=rgbCommaSeparated(e);if(!1!==a)return a}{const a=rgbSpaceSeparated(e);if(!1!==a)return a}return!1}function rgbCommaSeparated(e){return threeChannelLegacySyntax(e,normalize_legacy_sRGB_ChannelValues,exports.ColorSpace.sRGB,t.xyz.sRGB_to_XYZ_D50,[exports.SyntaxFlag.LegacyRGB])}function rgbSpaceSeparated(e){return threeChannelSpaceSeparated(e,normalize_modern_sRGB_ChannelValues,exports.ColorSpace.sRGB,t.xyz.sRGB_to_XYZ_D50,[])}function normalize_Lab_ChannelValues(e,a){const n=[];for(let t=0;t<e.length;t++){const r=e[t];if(r[0]!==o.TokenType.Ident||"none"!==toLowerCaseAZ(r[4].value))if(r[0]!==o.TokenType.Percentage){if(r[0]!==o.TokenType.Number)return!1;{3!==t&&a.syntaxFlags.add(exports.SyntaxFlag.HasNumberValues);let e=normalize(r[4].value,1,0,100);1===t||2===t?e=normalize(r[4].value,1,-1/0,1/0):3===t&&(e=normalize(r[4].value,1,0,1)),n.push([o.TokenType.Number,e.toString(),r[2],r[3],{value:r[4].value,type:o.NumberType.Number}])}}else{3!==t&&a.syntaxFlags.add(exports.SyntaxFlag.HasPercentageValues);let e=normalize(r[4].value,1,0,100);1===t||2===t?e=normalize(r[4].value,.8,-1/0,1/0):3===t&&(e=normalize(r[4].value,100,0,1)),n.push([o.TokenType.Number,e.toString(),r[2],r[3],{value:e,type:o.NumberType.Number}])}else a.syntaxFlags.add(exports.SyntaxFlag.HasNoneKeywords),a.missingComponents[t]=!0,n.push([o.TokenType.Number,"0",r[2],r[3],{value:0,type:o.NumberType.Number}])}return n}function lab(e,a){{const a=labSpaceSeparated(e);if(!1!==a)return a}return!1}function labSpaceSeparated(e){return threeChannelSpaceSeparated(e,normalize_Lab_ChannelValues,exports.ColorSpace.sRGB,t.xyz.Lab_to_XYZ_D50,[])}function toPrecision(e,a=7){e=+e,a=+a;const n=(Math.floor(e)+"").length;if(a>n)return+e.toFixed(a-n);{const o=10**(n-a);return Math.round(e/o)*o}}function XYZ_D50_to_sRGB_Gamut(e){const a=t.xyz.XYZ_D50_to_sRGB(e);if(t.utils.inGamut(a))return t.utils.clip(a);let n=e.slice();return n=t.conversions.D50_to_D65(n),n=t.conversions.XYZ_to_OKLab(n),n=t.conversions.OKLab_to_OKLCH(n),n[0]<1e-6&&(n=[0,0,0]),n[0]>.999999&&(n=[1,0,0]),t.calculations.mapGamut(n,(e=>(e=t.conversions.OKLCH_to_OKLab(e),e=t.conversions.OKLab_to_XYZ(e),e=t.conversions.XYZ_to_lin_sRGB(e),t.conversions.gam_sRGB(e))),(e=>(e=t.conversions.lin_sRGB(e),e=t.conversions.lin_sRGB_to_XYZ(e),e=t.conversions.XYZ_to_OKLab(e),t.conversions.OKLab_to_OKLCH(e))))}exports.color=function color(e){if(n.isFunctionNode(e)){const a=toLowerCaseAZ(e.getName());return"rgb"===a||"rgba"===a?rgb(e):"hsl"===a||"hsla"===a?hsl(e):"hwb"===a?hwb(e):"lab"===a&&lab(e)}if(n.isTokenNode(e)){if(e.value[0]===o.TokenType.Hash)return hex(e.value);if(e.value[0]===o.TokenType.Ident){const a=namedColor(e.value[4].value);if(!1!==a)return a;const n="transparent"===toLowerCaseAZ(e.value[4].value)&&{colorSpace:exports.ColorSpace.XYZ_D50,channels:[0,0,0],sourceColorSpace:exports.ColorSpace.sRGB,alpha:0,missingComponents:[!1,!1,!1,!1],syntaxFlags:new Set([exports.SyntaxFlag.ColorKeyword])};return!1!==n&&n}return!1}return!1},exports.serializeRGB=function serializeRGB(e){const a=XYZ_D50_to_sRGB_Gamut(e.channels),t=Math.min(255,Math.max(0,Math.round(255*toPrecision(a[0])))),r=Math.min(255,Math.max(0,Math.round(255*toPrecision(a[1])))),s=Math.min(255,Math.max(0,Math.round(255*toPrecision(a[2])))),l=[o.TokenType.CloseParen,")",-1,-1,void 0],u=[new n.TokenNode([o.TokenType.Number,t.toString(),-1,-1,{value:a[0],type:o.NumberType.Integer}]),new n.TokenNode([o.TokenType.Comma,",",-1,-1,void 0]),new n.TokenNode([o.TokenType.Whitespace," ",-1,-1,void 0]),new n.TokenNode([o.TokenType.Number,r.toString(),-1,-1,{value:a[1],type:o.NumberType.Integer}]),new n.TokenNode([o.TokenType.Comma,",",-1,-1,void 0]),new n.TokenNode([o.TokenType.Whitespace," ",-1,-1,void 0]),new n.TokenNode([o.TokenType.Number,s.toString(),-1,-1,{value:a[2],type:o.NumberType.Integer}])];if("number"==typeof e.alpha){const a=Math.min(1,Math.max(0,toPrecision(e.alpha)));return 1===a?new n.FunctionNode([o.TokenType.Function,"rgb(",-1,-1,{value:"rgb"}],l,u):new n.FunctionNode([o.TokenType.Function,"rgba(",-1,-1,{value:"rgba"}],l,[...u,new n.TokenNode([o.TokenType.Comma,",",-1,-1,void 0]),new n.TokenNode([o.TokenType.Whitespace," ",-1,-1,void 0]),new n.TokenNode([o.TokenType.Number,a.toString(),-1,-1,{value:e.alpha,type:o.NumberType.Integer}])])}return new n.FunctionNode([o.TokenType.Function,"rgba(",-1,-1,{value:"rgba"}],l,[...u,new n.TokenNode([o.TokenType.Comma,",",-1,-1,void 0]),new n.TokenNode([o.TokenType.Whitespace," ",-1,-1,void 0]),e.alpha])};
