import{isWhitespaceNode as e,isCommentNode as a,isTokenNode as n,isFunctionNode as t,TokenNode as r,FunctionNode as l}from"@csstools/css-parser-algorithms";import{TokenType as o,NumberType as s}from"@csstools/css-tokenizer";import{xyz as u,namedColors as i,utils as c,conversions as m,calculations as h}from"@csstools/color-helpers";import{calcFromComponentValues as p}from"@csstools/css-calc";var g,f;!function(e){e.XYZ_D50="xyz-d50",e.XYZ_D65="xyz-d65",e.sRGB="srgb"}(g||(g={})),function(e){e.ColorKeyword="color-keyword",e.HasAlpha="has-alpha",e.HasDimensionValues="has-dimension-values",e.HasNoneKeywords="has-none-keywords",e.HasNumberValues="has-number-values",e.HasPercentageAlpha="has-percentage-alpha",e.HasPercentageValues="has-percentage-values",e.HasVariableAlpha="has-variable-alpha",e.Hex="hex",e.LegacyHSL="legacy-hsl",e.LegacyRGB="legacy-rgb",e.NamedColor="named-color",e.RelativeColorSyntax="relative-color-syntax",e.ColorMix="color-mix"}(f||(f={}));const v=/[A-Z]/g;function toLowerCaseAZ(e){return e.replace(v,(e=>String.fromCharCode(e.charCodeAt(0)+32)))}function hex(e){const a=toLowerCaseAZ(e[4].value);if(a.match(/[^a-f0-9]/))return!1;const n={colorSpace:g.XYZ_D50,channels:[0,0,0],sourceColorSpace:g.sRGB,alpha:1,missingComponents:[!1,!1,!1,!1],syntaxFlags:new Set([f.Hex])},t=a.length;if(3===t){const e=a[0],t=a[1],r=a[2];return n.channels=u.sRGB_to_XYZ_D50([parseInt(e+e,16)/255,parseInt(t+t,16)/255,parseInt(r+r,16)/255]),n}if(6===t){const e=a[0]+a[1],t=a[2]+a[3],r=a[4]+a[5];return n.channels=u.sRGB_to_XYZ_D50([parseInt(e,16)/255,parseInt(t,16)/255,parseInt(r,16)/255]),n}if(4===t){const e=a[0],t=a[1],r=a[2],l=a[3];return n.channels=u.sRGB_to_XYZ_D50([parseInt(e+e,16)/255,parseInt(t+t,16)/255,parseInt(r+r,16)/255]),n.alpha=parseInt(l+l,16)/255,n.syntaxFlags.add(f.HasAlpha),n}if(8===t){const e=a[0]+a[1],t=a[2]+a[3],r=a[4]+a[5],l=a[6]+a[7];return n.channels=u.sRGB_to_XYZ_D50([parseInt(e,16)/255,parseInt(t,16)/255,parseInt(r,16)/255]),n.alpha=parseInt(l,16)/255,n.syntaxFlags.add(f.HasAlpha),n}return!1}function normalizeHue(e){if(e[0]===o.Number)return e[4].value=e[4].value%360,e[1]=e[4].value.toString(),e;if(e[0]===o.Dimension){let a=e[4].value;switch(toLowerCaseAZ(e[4].unit)){case"deg":break;case"rad":a=180*e[4].value/Math.PI;break;case"grad":a=.9*e[4].value;break;case"turn":a=360*e[4].value;break;default:return!1}return a%=360,[o.Number,a.toString(),e[2],e[3],{value:a,type:s.Number}]}return!1}function normalize(e,a,n,t){return Math.min(Math.max(e/a,n),t)}function normalize_legacy_HSL_ChannelValues(e,a){const n=[];for(let t=0;t<e.length;t++){const r=e[t];if(0!==t)if(r[0]!==o.Percentage){if(r[0]!==o.Number)return!1;{3!==t&&a.syntaxFlags.add(f.HasNumberValues);let e=normalize(r[4].value,1,0,100);3===t&&(e=normalize(r[4].value,1,0,1)),n.push([o.Number,e.toString(),r[2],r[3],{value:e,type:s.Number}])}}else{3===t?a.syntaxFlags.add(f.HasPercentageAlpha):a.syntaxFlags.add(f.HasPercentageValues);let e=normalize(r[4].value,1,0,100);3===t&&(e=normalize(r[4].value,100,0,1)),n.push([o.Number,e.toString(),r[2],r[3],{value:e,type:s.Number}])}else{const e=normalizeHue(r);if(!1===e)return!1;r[0]===o.Dimension&&a.syntaxFlags.add(f.HasDimensionValues),n.push(e)}}return!a.syntaxFlags.has(f.HasNumberValues)&&n}function normalize_modern_HSL_ChannelValues(e,a){const n=[];for(let t=0;t<e.length;t++){const r=e[t];if(r[0]!==o.Ident||"none"!==toLowerCaseAZ(r[4].value))if(0!==t)if(r[0]!==o.Percentage){if(r[0]!==o.Number)return!1;{3!==t&&a.syntaxFlags.add(f.HasNumberValues);let e=normalize(r[4].value,1,0,100);3===t&&(e=normalize(r[4].value,1,0,1)),n.push([o.Number,e.toString(),r[2],r[3],{value:e,type:s.Number}])}}else{3===t?a.syntaxFlags.add(f.HasPercentageAlpha):a.syntaxFlags.add(f.HasPercentageValues);let e=normalize(r[4].value,1,0,100);3===t&&(e=normalize(r[4].value,100,0,1)),n.push([o.Number,e.toString(),r[2],r[3],{value:e,type:s.Number}])}else{const e=normalizeHue(r);if(!1===e)return!1;r[0]===o.Dimension&&a.syntaxFlags.add(f.HasDimensionValues),n.push(e)}else a.syntaxFlags.add(f.HasNoneKeywords),a.missingComponents[t]=!0,n.push([o.Number,"0",r[2],r[3],{value:0,type:s.Number}])}return n}function threeChannelLegacySyntax(r,l,s,u,i){const c=[],m=[],h=[],v=[],d={colorSpace:g.XYZ_D50,channels:[0,0,0],sourceColorSpace:s,alpha:1,missingComponents:[!1,!1,!1,!1],syntaxFlags:new Set(i)};let _=c;for(let l=0;l<r.value.length;l++){let s=r.value[l];if(!e(s)&&!a(s)){if(n(s)&&s.value[0]===o.Comma){if(_===c){_=m;continue}if(_===m){_=h;continue}if(_===h){_=v;continue}if(_===v)return!1}if(t(s)){if(_===v&&"var"===toLowerCaseAZ(s.getName())){d.syntaxFlags.add(f.HasVariableAlpha),_.push(s);continue}if("calc"!==toLowerCaseAZ(s.getName()))return!1;const[[e]]=p([[s]],{toCanonicalUnits:!0,precision:100});if(!e||!n(e))return!1;s=e}if(!n(s))return!1;_.push(s)}}if(1!==_.length)return!1;if(1!==c.length||1!==m.length||1!==h.length)return!1;if(!n(c[0])||!n(m[0])||!n(h[0]))return!1;const b=[c[0].value,m[0].value,h[0].value];1===v.length&&(d.syntaxFlags.add(f.HasAlpha),n(v[0])?b.push(v[0].value):d.alpha=v[0]);const y=l(b,d);return!1!==y&&(d.channels=u([y[0][4].value,y[1][4].value,y[2][4].value]),4===y.length&&(d.alpha=y[3][4].value),d)}function threeChannelSpaceSeparated(r,l,s,u,i){const c=[],m=[],h=[],v=[],d={colorSpace:g.XYZ_D50,channels:[0,0,0],sourceColorSpace:s,alpha:1,missingComponents:[!1,!1,!1,!1],syntaxFlags:new Set(i)};let _=c;for(let l=0;l<r.value.length;l++){let s=r.value[l];if(e(s)||a(s)){for(;e(r.value[l+1])||a(r.value[l+1]);)l++;if(!c.length)continue;if(_===c){_=m;continue}if(_===m){_=h;continue}}else if(n(s)&&s.value[0]===o.Delim&&"/"===s.value[4].value){if(_===v)return!1;_=v}else{if(t(s)){if(_===v&&"var"===toLowerCaseAZ(s.getName())){d.syntaxFlags.add(f.HasVariableAlpha),_.push(s);continue}if("calc"!==toLowerCaseAZ(s.getName()))return!1;const[[e]]=p([[s]],{toCanonicalUnits:!0,precision:100});if(!e||!n(e))return!1;s=e}if(!n(s))return!1;_.push(s)}}if(1!==_.length)return!1;if(1!==c.length||1!==m.length||1!==h.length)return!1;if(!n(c[0])||!n(m[0])||!n(h[0]))return!1;const b=[c[0].value,m[0].value,h[0].value];1===v.length&&(d.syntaxFlags.add(f.HasAlpha),n(v[0])?b.push(v[0].value):d.alpha=v[0]);const y=l(b,d);return!1!==y&&(d.channels=u([y[0][4].value,y[1][4].value,y[2][4].value]),4===y.length&&(d.alpha=y[3][4].value),d)}function hsl(e,a){{const a=hslCommaSeparated(e);if(!1!==a)return a}{const a=hslSpaceSeparated(e);if(!1!==a)return a}return!1}function hslCommaSeparated(e){return threeChannelLegacySyntax(e,normalize_legacy_HSL_ChannelValues,g.sRGB,u.HSL_to_XYZ_D50,[f.LegacyHSL])}function hslSpaceSeparated(e){return threeChannelSpaceSeparated(e,normalize_modern_HSL_ChannelValues,g.sRGB,u.HSL_to_XYZ_D50,[])}function normalize_HWB_ChannelValues(e,a){const n=[];for(let t=0;t<e.length;t++){const r=e[t];if(r[0]!==o.Ident||"none"!==toLowerCaseAZ(r[4].value))if(0!==t)if(r[0]!==o.Percentage){if(r[0]!==o.Number)return!1;{if(3!==t)return!1;const e=normalize(r[4].value,1,0,1);n.push([o.Number,e.toString(),r[2],r[3],{value:e,type:s.Number}])}}else{3===t?a.syntaxFlags.add(f.HasPercentageAlpha):a.syntaxFlags.add(f.HasPercentageValues);let e=normalize(r[4].value,1,0,100);3===t&&(e=normalize(r[4].value,100,0,1)),n.push([o.Number,e.toString(),r[2],r[3],{value:e,type:s.Number}])}else{const e=normalizeHue(r);if(!1===e)return!1;r[0]===o.Dimension&&a.syntaxFlags.add(f.HasDimensionValues),n.push(e)}else a.syntaxFlags.add(f.HasNoneKeywords),a.missingComponents[t]=!0,n.push([o.Number,"0",r[2],r[3],{value:0,type:s.Number}])}return n}const d=new Map;for(const[e,a]of Object.entries(i))d.set(e,a);function namedColor(e){const a=d.get(toLowerCaseAZ(e));return!!a&&{colorSpace:g.XYZ_D50,channels:u.sRGB_to_XYZ_D50([a[0]/255,a[1]/255,a[2]/255]),sourceColorSpace:g.sRGB,alpha:1,missingComponents:[!1,!1,!1,!1],syntaxFlags:new Set([f.ColorKeyword,f.NamedColor])}}function normalize_legacy_sRGB_ChannelValues(e,a){const n=[];for(let t=0;t<e.length;t++){const r=e[t];if(r[0]!==o.Percentage){if(r[0]!==o.Number)return!1;{3!==t&&a.syntaxFlags.add(f.HasNumberValues);let e=normalize(r[4].value,255,0,1);3===t&&(e=normalize(r[4].value,1,0,1)),n.push([o.Number,e.toString(),r[2],r[3],{value:e,type:s.Number}])}}else{3===t?a.syntaxFlags.add(f.HasPercentageAlpha):a.syntaxFlags.add(f.HasPercentageValues);const e=normalize(r[4].value,100,0,1);n.push([o.Number,e.toString(),r[2],r[3],{value:e,type:s.Number}])}}return(!a.syntaxFlags.has(f.HasNumberValues)||!a.syntaxFlags.has(f.HasPercentageValues))&&n}function normalize_modern_sRGB_ChannelValues(e,a){const n=[];for(let t=0;t<e.length;t++){const r=e[t];if(r[0]!==o.Ident||"none"!==toLowerCaseAZ(r[4].value))if(r[0]!==o.Percentage){if(r[0]!==o.Number)return!1;{3!==t&&a.syntaxFlags.add(f.HasNumberValues);let e=normalize(r[4].value,255,0,1);3===t&&(e=normalize(r[4].value,1,0,1)),n.push([o.Number,e.toString(),r[2],r[3],{value:e,type:s.Number}])}}else{3!==t&&a.syntaxFlags.add(f.HasPercentageValues);const e=normalize(r[4].value,100,0,1);n.push([o.Number,e.toString(),r[2],r[3],{value:e,type:s.Number}])}else a.syntaxFlags.add(f.HasNoneKeywords),a.missingComponents[t]=!0,n.push([o.Number,"0",r[2],r[3],{value:0,type:s.Number}])}return n}function rgb(e,a){{const a=rgbCommaSeparated(e);if(!1!==a)return a}{const a=rgbSpaceSeparated(e);if(!1!==a)return a}return!1}function rgbCommaSeparated(e){return threeChannelLegacySyntax(e,normalize_legacy_sRGB_ChannelValues,g.sRGB,u.sRGB_to_XYZ_D50,[f.LegacyRGB])}function rgbSpaceSeparated(e){return threeChannelSpaceSeparated(e,normalize_modern_sRGB_ChannelValues,g.sRGB,u.sRGB_to_XYZ_D50,[])}function normalize_Lab_ChannelValues(e,a){const n=[];for(let t=0;t<e.length;t++){const r=e[t];if(r[0]!==o.Ident||"none"!==toLowerCaseAZ(r[4].value))if(r[0]!==o.Percentage){if(r[0]!==o.Number)return!1;{3!==t&&a.syntaxFlags.add(f.HasNumberValues);let e=normalize(r[4].value,1,0,100);1===t||2===t?e=normalize(r[4].value,1,-1/0,1/0):3===t&&(e=normalize(r[4].value,1,0,1)),n.push([o.Number,e.toString(),r[2],r[3],{value:r[4].value,type:s.Number}])}}else{3!==t&&a.syntaxFlags.add(f.HasPercentageValues);let e=normalize(r[4].value,1,0,100);1===t||2===t?e=normalize(r[4].value,.8,-1/0,1/0):3===t&&(e=normalize(r[4].value,100,0,1)),n.push([o.Number,e.toString(),r[2],r[3],{value:e,type:s.Number}])}else a.syntaxFlags.add(f.HasNoneKeywords),a.missingComponents[t]=!0,n.push([o.Number,"0",r[2],r[3],{value:0,type:s.Number}])}return n}const _=new Set(["srgb","srgb-linear","lab","oklab","xyz","xyz-d50","xyz-d65"]),b=new Set(["hsl","hwb","lch","oklch"]),y=new Set(["shorter","longer","increasing","decreasing"]);function colorMix(t,r){let l=null,s=null,u=null,i=!1;for(let c=0;c<t.value.length;c++){const m=t.value[c];if(!e(m)&&!a(m)){if(n(m)&&m.value[0]===o.Ident){if(!l&&"in"===toLowerCaseAZ(m.value[4].value)){l=m;continue}if(l&&!s){s=toLowerCaseAZ(m.value[4].value);continue}if(l&&s&&!u&&b.has(s)){u=toLowerCaseAZ(m.value[4].value);continue}if(l&&s&&u&&!i&&"hue"===toLowerCaseAZ(m.value[4].value)){i=!0;continue}return!1}return!(!n(m)||m.value[0]!==o.Comma)&&(!!s&&(u||i?!!(s&&u&&i&&b.has(s)&&y.has(u))&&colorMixPolar(s,u,colorMixComponents(t.value.slice(c+1),r)):_.has(s)?colorMixRectangular(s,colorMixComponents(t.value.slice(c+1),r)):!!b.has(s)&&colorMixPolar(s,"shorter",colorMixComponents(t.value.slice(c+1),r))))}}return!1}function colorMixComponents(r,l){const s=[];let u=1,i=!1,c=!1;for(let u=0;u<r.length;u++){let m=r[u];if(!e(m)&&!a(m))if(n(m)&&m.value[0]===o.Comma){if(!i)return!1;s.push({color:i,percentage:c}),i=!1,c=!1}else if(i){if(c||(t(m)&&"calc"===toLowerCaseAZ(m.getName())&&([[m]]=p([[m]],{toCanonicalUnits:!0,precision:100})),!(n(m)&&m.value[0]===o.Percentage&&m.value[4].value>=0)))return!1;c=m.value[4].value}else{const e=l(m);if(!e)return!1;i=e}}if(i&&s.push({color:i,percentage:c}),2!==s.length)return!1;let m=s[0].percentage,h=s[1].percentage;return!1===m&&!1===h?(m=50,h=50):!1!==m&&!1===h?h=100-m:!1===m&&!1!==h&&(m=100-h),(0!==m||0!==h)&&(!1!==m&&!1!==h&&(m+h>100&&(m=m/(m+h)*100,h=h/(m+h)*100),m+h<100&&(m=m/(m+h)*100,h=h/(m+h)*100,u=(m+h)/100),{a:{color:s[0].color,percentage:m},b:{color:s[1].color,percentage:h},alphaMultiplier:u}))}function colorMixRectangular(e,a){return!1}function colorMixPolar(e,a,n){if(!n)return!1;let t=n.a.color.channels,r=n.b.color.channels,l=0,o=0;const s=n.a.color.alpha;if("number"!=typeof s)return!1;const i=n.b.color.alpha;if("number"!=typeof i)return!1;if("hsl"===e)t=u.XYZ_D50_to_HSL(t),r=u.XYZ_D50_to_HSL(r),l=t[0],o=r[0];if("shorter"===a)Math.abs(l-o)>180&&(l>o?o+=360:l+=360);const c=interpolate(l,o,n.a.percentage/100),m=interpolate(t[1],r[1],n.a.percentage/100),h=interpolate(t[2],r[2],n.a.percentage/100),p=interpolate(s,i,n.a.percentage/100);return{colorSpace:g.XYZ_D50,channels:u.HSL_to_XYZ_D50([c,m,h]),sourceColorSpace:g.sRGB,alpha:p,missingComponents:[!1,!1,!1,!1],syntaxFlags:new Set([f.ColorMix])}}function interpolate(e,a,n){return isNaN(e)?a:isNaN(a)?e:e+(a-e)*n}function toPrecision(e,a=7){e=+e,a=+a;const n=(Math.floor(e)+"").length;if(a>n)return+e.toFixed(a-n);{const t=10**(n-a);return Math.round(e/t)*t}}function serializeRGB(e){const a=XYZ_D50_to_sRGB_Gamut(e.channels),n=Math.min(255,Math.max(0,Math.round(255*toPrecision(a[0])))),t=Math.min(255,Math.max(0,Math.round(255*toPrecision(a[1])))),u=Math.min(255,Math.max(0,Math.round(255*toPrecision(a[2])))),i=[o.CloseParen,")",-1,-1,void 0],c=[new r([o.Number,n.toString(),-1,-1,{value:a[0],type:s.Integer}]),new r([o.Comma,",",-1,-1,void 0]),new r([o.Whitespace," ",-1,-1,void 0]),new r([o.Number,t.toString(),-1,-1,{value:a[1],type:s.Integer}]),new r([o.Comma,",",-1,-1,void 0]),new r([o.Whitespace," ",-1,-1,void 0]),new r([o.Number,u.toString(),-1,-1,{value:a[2],type:s.Integer}])];if("number"==typeof e.alpha){const a=Math.min(1,Math.max(0,toPrecision(e.alpha)));return 1===a?new l([o.Function,"rgb(",-1,-1,{value:"rgb"}],i,c):new l([o.Function,"rgba(",-1,-1,{value:"rgba"}],i,[...c,new r([o.Comma,",",-1,-1,void 0]),new r([o.Whitespace," ",-1,-1,void 0]),new r([o.Number,a.toString(),-1,-1,{value:e.alpha,type:s.Integer}])])}return new l([o.Function,"rgba(",-1,-1,{value:"rgba"}],i,[...c,new r([o.Comma,",",-1,-1,void 0]),new r([o.Whitespace," ",-1,-1,void 0]),e.alpha])}function XYZ_D50_to_sRGB_Gamut(e){const a=u.XYZ_D50_to_sRGB(e);if(c.inGamut(a))return c.clip(a);let n=e.slice();return n=m.D50_to_D65(n),n=m.XYZ_to_OKLab(n),n=m.OKLab_to_OKLCH(n),n[0]<1e-6&&(n=[0,0,0]),n[0]>.999999&&(n=[1,0,0]),h.mapGamut(n,(e=>(e=m.OKLCH_to_OKLab(e),e=m.OKLab_to_XYZ(e),e=m.XYZ_to_lin_sRGB(e),m.gam_sRGB(e))),(e=>(e=m.lin_sRGB(e),e=m.lin_sRGB_to_XYZ(e),e=m.XYZ_to_OKLab(e),m.OKLab_to_OKLCH(e))))}function color(e){if(t(e)){const a=toLowerCaseAZ(e.getName());return"rgb"===a||"rgba"===a?rgb(e):"hsl"===a||"hsla"===a?hsl(e):"hwb"===a?threeChannelSpaceSeparated(e,normalize_HWB_ChannelValues,g.sRGB,u.HWB_to_XYZ_D50,[]):"lab"===a?threeChannelSpaceSeparated(e,normalize_Lab_ChannelValues,g.sRGB,u.Lab_to_XYZ_D50,[]):"color-mix"===a&&colorMix(e,color)}if(n(e)){if(e.value[0]===o.Hash)return hex(e.value);if(e.value[0]===o.Ident){const a=namedColor(e.value[4].value);if(!1!==a)return a;const n="transparent"===toLowerCaseAZ(e.value[4].value)&&{colorSpace:g.XYZ_D50,channels:[0,0,0],sourceColorSpace:g.sRGB,alpha:0,missingComponents:[!1,!1,!1,!1],syntaxFlags:new Set([f.ColorKeyword])};return!1!==n&&n}return!1}return!1}export{g as ColorSpace,f as SyntaxFlag,color,serializeRGB};
