import{isWhitespaceNode as e,isCommentNode as a,isTokenNode as n,isFunctionNode as t,TokenNode as r}from"@csstools/css-parser-algorithms";import{TokenType as s,NumberType as l}from"@csstools/css-tokenizer";import{xyz as u,namedColors as o}from"@csstools/color-helpers";import{calcFromComponentValues as c}from"@csstools/css-calc";var i,h;function colorDataChannelsToCalcGlobals(e){const a=new Map;switch(e.colorSpace){case i.XYZ_D50:a.set("x",dummyNumberToken(e.channels[0])),a.set("y",dummyNumberToken(e.channels[1])),a.set("z",dummyNumberToken(e.channels[2])),a.set("alpha",dummyNumberToken(e.alpha));break;case i.sRGB:a.set("r",dummyNumberToken(255*e.channels[0])),a.set("g",dummyNumberToken(255*e.channels[1])),a.set("b",dummyNumberToken(255*e.channels[2])),a.set("alpha",dummyNumberToken(e.alpha))}return a}function dummyNumberToken(e){return[s.Number,e.toString(),-1,-1,{value:e,type:l.Number}]}function colorDataToColorSpace(e,a){if(-1===e)return-1;if(e.colorSpace!==i.XYZ_D50)return-1;switch(a){case i.XYZ_D50:return e;case i.sRGB:return e.colorSpace=i.sRGB,e.channels=u.XYZ_D50_to_sRGB(e.channels),e}return-1}function hex(e){const a=e[4].value.toLowerCase();if(a.match(/[^a-f0-9]/))return-1;const n={colorSpace:i.XYZ_D50,channels:[0,0,0],sourceColorSpace:i.sRGB,alpha:1,missingComponents:[!1,!1,!1,!1],syntaxFlags:new Set([h.Hex])},t=a.length;if(3===t){const e=a[0],t=a[1],r=a[2];return n.channels=u.sRGB_to_XYZ_D50([parseInt(e+e,16)/255,parseInt(t+t,16)/255,parseInt(r+r,16)/255]),n}if(6===t){const e=a[0]+a[1],t=a[2]+a[3],r=a[4]+a[5];return n.channels=u.sRGB_to_XYZ_D50([parseInt(e,16)/255,parseInt(t,16)/255,parseInt(r,16)/255]),n}if(4===t){const e=a[0],t=a[1],r=a[2],s=a[3];return n.channels=u.sRGB_to_XYZ_D50([parseInt(e+e,16)/255,parseInt(t+t,16)/255,parseInt(r+r,16)/255]),n.alpha=parseInt(s+s,16)/255,n.syntaxFlags.add(h.HasAlpha),n}if(8===t){const e=a[0]+a[1],t=a[2]+a[3],r=a[4]+a[5],s=a[6]+a[7];return n.channels=u.sRGB_to_XYZ_D50([parseInt(e,16)/255,parseInt(t,16)/255,parseInt(r,16)/255]),n.alpha=parseInt(s,16)/255,n.syntaxFlags.add(h.HasAlpha),n}return-1}function normalizeHue(e){if(e[0]===s.Number)return e[4].value=e[4].value%360,e[1]=e[4].value.toString(),e;if(e[0]===s.Dimension){let a=e[4].value;switch(e[4].unit.toLowerCase()){case"deg":break;case"rad":a=180*e[4].value/Math.PI;break;case"grad":a=.9*e[4].value;break;case"turn":a=360*e[4].value;break;default:return-1}return a%=360,[s.Number,a.toString(),e[2],e[3],{value:a,type:l.Number}]}return-1}function normalize_legacy_HSL_ChannelValues(e,a){const n=[];for(let t=0;t<e.length;t++){const r=e[t];if(0!==t)if(r[0]!==s.Percentage){if(r[0]!==s.Number)return-1;{3!==t&&a.syntaxFlags.add(h.HasNumberValues);let e=1;3===t&&(e=1),n.push([s.Number,(r[4].value/e).toString(),r[2],r[3],{value:r[4].value/e,type:l.Number}])}}else{3===t?a.syntaxFlags.add(h.HasPercentageAlpha):a.syntaxFlags.add(h.HasPercentageValues);let e=1;3===t&&(e=100),n.push([s.Number,(r[4].value/e).toString(),r[2],r[3],{value:r[4].value/e,type:l.Number}])}else{const e=normalizeHue(r);if(-1===e)return-1;r[0]===s.Dimension&&a.syntaxFlags.add(h.HasDimensionValues),n.push(e)}}return a.syntaxFlags.has(h.HasNumberValues)?-1:n}function normalize_modern_HSL_ChannelValues(e,a){const n=[];for(let t=0;t<e.length;t++){const r=e[t];if(r[0]!==s.Ident||"none"!==r[4].value.toLowerCase())if(0!==t)if(r[0]!==s.Percentage){if(r[0]!==s.Number)return-1;{3!==t&&a.syntaxFlags.add(h.HasNumberValues);let e=1;3===t&&(e=1),n.push([s.Number,(r[4].value/e).toString(),r[2],r[3],{value:r[4].value/e,type:l.Number}])}}else{3===t?a.syntaxFlags.add(h.HasPercentageAlpha):a.syntaxFlags.add(h.HasPercentageValues);let e=1;3===t&&(e=100),n.push([s.Number,(r[4].value/e).toString(),r[2],r[3],{value:r[4].value/e,type:l.Number}])}else{const e=normalizeHue(r);if(-1===e)return-1;r[0]===s.Dimension&&a.syntaxFlags.add(h.HasDimensionValues),n.push(e)}else a.syntaxFlags.add(h.HasNoneKeywords),a.missingComponents[t]=!0,n.push([s.Number,"0",r[2],r[3],{value:0,type:l.Number}])}return n}function threeChannelLegacySyntax(r,l,u,o,m){const p=[],g=[],f=[],v=[],d={colorSpace:i.XYZ_D50,channels:[0,0,0],sourceColorSpace:u,alpha:0,missingComponents:[!1,!1,!1,!1],syntaxFlags:new Set(m)};let y=p;for(let l=0;l<r.value.length;l++){let u=r.value[l];if(!e(u)&&!a(u)){if(n(u)&&u.value[0]===s.Comma){if(y===p){y=g;continue}if(y===g){y=f;continue}if(y===f){y=v;continue}if(y===v)return-1}if(t(u)){if("calc"!==u.getName().toLowerCase())return-1;const[[e]]=c([[u]],{toCanonicalUnits:!0,precision:100});if(!e||!n(e))return-1;u=e}if(!n(u))return-1;y.push(u.value)}}if(1!==y.length)return-1;if(1!==p.length||1!==g.length||1!==f.length)return-1;const b=[p[0],g[0],f[0]],S=1===v.length;S&&(d.syntaxFlags.add(h.HasAlpha),b.push(v[0]));const _=l(b,d);return-1===_?-1:(d.channels=o([_[0][4].value,_[1][4].value,_[2][4].value]),d.alpha=S?_[3][4].value:1,d)}function threeChannelSpaceSeparated(r,l,u,o,m){const p=[],g=[],f=[],v=[],d={colorSpace:i.XYZ_D50,channels:[0,0,0],sourceColorSpace:u,alpha:0,missingComponents:[!1,!1,!1,!1],syntaxFlags:new Set(m)};let y=p;for(let l=0;l<r.value.length;l++){let u=r.value[l];if(e(u)||a(u)){for(;e(r.value[l+1])||a(r.value[l+1]);)l++;if(!p.length)continue;if(y===p){y=g;continue}if(y===g){y=f;continue}}else if(n(u)&&u.value[0]===s.Delim&&"/"===u.value[4].value){if(y===v)return-1;y=v}else{if(t(u)){if("calc"!==u.getName().toLowerCase())return-1;const[[e]]=c([[u]],{toCanonicalUnits:!0,precision:100});if(!e||!n(e))return-1;u=e}if(!n(u))return-1;y.push(u.value)}}if(1!==y.length)return-1;if(1!==p.length||1!==g.length||1!==f.length)return-1;const b=[p[0],g[0],f[0]],S=1===v.length;S&&(d.syntaxFlags.add(h.HasAlpha),b.push(v[0]));const _=l(b,d);return-1===_?-1:(d.channels=o([_[0][4].value,_[1][4].value,_[2][4].value]),d.alpha=S?_[3][4].value:1,d)}function hsl(e,a){{const a=hslCommaSeparated(e);if(-1!==a)return a}{const a=hslSpaceSeparated(e);if(-1!==a)return a}return-1}function hslCommaSeparated(e){return threeChannelLegacySyntax(e,normalize_legacy_HSL_ChannelValues,i.sRGB,u.HSL_to_XYZ_D50,[h.LegacyHSL])}function hslSpaceSeparated(e){return threeChannelSpaceSeparated(e,normalize_modern_HSL_ChannelValues,i.sRGB,u.HSL_to_XYZ_D50,[])}function normalize_modern_HWB_ChannelValues(e,a){const n=[];for(let t=0;t<e.length;t++){const r=e[t];if(r[0]!==s.Ident||"none"!==r[4].value.toLowerCase())if(0!==t)if(r[0]!==s.Percentage){if(r[0]!==s.Number)return-1;if(3!==t)return-1;n.push([s.Number,r[1],r[2],r[3],{value:r[4].value,type:l.Number}])}else{3===t?a.syntaxFlags.add(h.HasPercentageAlpha):a.syntaxFlags.add(h.HasPercentageValues);let e=1;3===t&&(e=100),n.push([s.Number,(r[4].value/e).toString(),r[2],r[3],{value:r[4].value/e,type:l.Number}])}else{const e=normalizeHue(r);if(-1===e)return-1;r[0]===s.Dimension&&a.syntaxFlags.add(h.HasDimensionValues),n.push(e)}else a.syntaxFlags.add(h.HasNoneKeywords),a.missingComponents[t]=!0,n.push([s.Number,"0",r[2],r[3],{value:0,type:l.Number}])}return n}function hwb(e,a){{const a=hwbSpaceSeparated(e);if(-1!==a)return a}return-1}function hwbSpaceSeparated(e){return threeChannelSpaceSeparated(e,normalize_modern_HWB_ChannelValues,i.sRGB,u.HWB_to_XYZ_D50,[])}function normalize_legacy_sRGB_ChannelValues(e,a){const n=[];for(let t=0;t<e.length;t++){const r=e[t];if(r[0]!==s.Percentage){if(r[0]!==s.Number)return-1;{3!==t&&a.syntaxFlags.add(h.HasNumberValues);let e=255;3===t&&(e=1),n.push([s.Number,(r[4].value/e).toString(),r[2],r[3],{value:r[4].value/e,type:l.Number}])}}else 3===t?a.syntaxFlags.add(h.HasPercentageAlpha):a.syntaxFlags.add(h.HasPercentageValues),n.push([s.Number,(r[4].value/100).toString(),r[2],r[3],{value:r[4].value/100,type:l.Number}])}return a.syntaxFlags.has(h.HasNumberValues)&&a.syntaxFlags.has(h.HasPercentageValues)?-1:n}function normalize_modern_sRGB_ChannelValues(e,a){const n=[];for(let t=0;t<e.length;t++){const r=e[t];if(r[0]!==s.Percentage)if(r[0]!==s.Number){if(r[0]!==s.Ident||"none"!==r[4].value.toLowerCase())return-1;a.syntaxFlags.add(h.HasNoneKeywords),a.missingComponents[t]=!0,n.push([s.Number,"0",r[2],r[3],{value:0,type:l.Number}])}else{3!==t&&a.syntaxFlags.add(h.HasNumberValues);let e=255;3===t&&(e=1),n.push([s.Number,(r[4].value/e).toString(),r[2],r[3],{value:r[4].value/e,type:l.Number}])}else 3!==t&&a.syntaxFlags.add(h.HasPercentageValues),n.push([s.Number,(r[4].value/100).toString(),r[2],r[3],{value:r[4].value/100,type:l.Number}])}return n}function rgb(e,a){{const a=rgbCommaSeparated(e);if(-1!==a)return a}{const a=rgbSpaceSeparated(e);if(-1!==a)return a}{const n=rgbSpaceSeparated_RCS(e,a);if(-1!==n)return n}return-1}function rgbCommaSeparated(e){return threeChannelLegacySyntax(e,normalize_legacy_sRGB_ChannelValues,i.sRGB,u.sRGB_to_XYZ_D50,[h.LegacyRGB])}function rgbSpaceSeparated(e){return threeChannelSpaceSeparated(e,normalize_modern_sRGB_ChannelValues,i.sRGB,u.sRGB_to_XYZ_D50,[])}function rgbSpaceSeparated_RCS(o,m){let p=null,g=1;const f=[],v=[],d=[],y=[],b={channels:[0,0,0],colorSpace:i.XYZ_D50,sourceColorSpace:i.sRGB,alpha:0,missingComponents:[!1,!1,!1,!1],syntaxFlags:new Set([h.RelativeColorSyntax])};let S=f;for(let u=0;u<o.value.length;u++){let h=o.value[u];if(e(h)||a(h)){for(;e(o.value[u+1])||a(o.value[u+1]);)u++;if(!f.length)continue;if(S===f){S=v;continue}if(S===v){S=d;continue}}else if(!n(h)||p||h.value[0]!==s.Ident||"from"!==h.value[4].value.toLowerCase()){if(!p)return-1;if(!n(h)||h.value[0]!==s.Delim||"/"!==h.value[4].value){if(t(h)){if("calc"!==h.getName().toLowerCase())return-1;const[[e]]=c([[h]],{toCanonicalUnits:!0,precision:100,globals:p});if(!e||!n(e))return-1;h=e}if(n(h)){if(h.value[0]===s.Ident){const e=h.value,a=p.get(e[4].value.toLowerCase());if(!a)return-1;h=new r(a)}if(h.value[0]===s.Percentage){const e=h.value;S.push([s.Number,(e[4].value/100).toString(),e[2],e[3],{value:e[4].value/100,type:l.Number}]);continue}if(h.value[0]===s.Number){let e=255;S===y&&(e=1);const a=h.value;S.push([s.Number,(a[4].value/e).toString(),a[2],a[3],{value:a[4].value/e,type:l.Number}]);continue}}return-1}if(S===y)return-1;S=y}else{for(;e(o.value[u+1])||a(o.value[u+1]);)u++;const n=colorDataToColorSpace(m(o.value[u+1]),i.sRGB);if(-1===n)return-1;p=colorDataChannelsToCalcGlobals(n),g=n.alpha,u++}}return 1!==S.length||1!==f.length||1!==v.length||1!==d.length?-1:(b.channels=u.sRGB_to_XYZ_D50([f[0][4].value,v[0][4].value,d[0][4].value]),b.alpha=1===y.length?y[0][4].value:g,b)}!function(e){e.XYZ_D50="xyz-d50",e.XYZ_D65="xyz-d65",e.sRGB="srgb"}(i||(i={})),function(e){e.ColorKeyword="color-keyword",e.HasAlpha="has-alpha",e.HasDimensionValues="has-dimension-values",e.HasNoneKeywords="has-none-keywords",e.HasNumberValues="has-number-values",e.HasPercentageAlpha="has-percentage-alpha",e.HasPercentageValues="has-percentage-values",e.Hex="hex",e.LegacyHSL="legacy-hsl",e.LegacyRGB="legacy-rgb",e.NamedColor="named-color",e.RelativeColorSyntax="relative-color-syntax"}(h||(h={}));const m=new Map;for(const[e,a]of Object.entries(o))m.set(e.toLowerCase(),a);function namedColor(e){const a=m.get(e);return a?{colorSpace:i.XYZ_D50,channels:u.sRGB_to_XYZ_D50([a[0]/255,a[1]/255,a[2]/255]),sourceColorSpace:i.sRGB,alpha:1,missingComponents:[!1,!1,!1,!1],syntaxFlags:new Set([h.ColorKeyword,h.NamedColor])}:-1}function color(e){if(t(e)){const a=e.getName().toLowerCase();return"rgb"===a||"rgba"===a?rgb(e,color):"hsl"===a||"hsla"===a?hsl(e):"hwb"===a?hwb(e):-1}if(n(e)){if(e.value[0]===s.Hash)return hex(e.value);if(e.value[0]===s.Ident){const a=namedColor(e.value[4].value.toLowerCase());if(-1!==a)return a;const n="transparent"===e.value[4].value.toLowerCase()?{colorSpace:i.XYZ_D50,channels:[0,0,0],sourceColorSpace:i.sRGB,alpha:0,missingComponents:[!1,!1,!1,!1],syntaxFlags:new Set([h.ColorKeyword])}:-1;return-1!==n?n:-1}return-1}return-1}export{i as ColorSpace,color};
