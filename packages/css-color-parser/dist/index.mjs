import{isWhitespaceNode as e,isCommentNode as t,isTokenNode as n,isFunctionNode as a,TokenNode as r}from"@csstools/css-parser-algorithms";import{TokenType as l,NumberType as o}from"@csstools/css-tokenizer";import{calcFromComponentValues as u}from"@csstools/css-calc";import{xyz as c,namedColors as s}from"@csstools/color-helpers";var i;function colorDataChannelsToCalcGlobals(e){const t=new Map;switch(e.currentColorSpace){case i.XYZ_D50:t.set("x",dummyNumberToken(e.channels[0])),t.set("y",dummyNumberToken(e.channels[1])),t.set("z",dummyNumberToken(e.channels[2])),t.set("alpha",dummyNumberToken(e.alpha));break;case i.sRGB:t.set("r",dummyNumberToken(255*e.channels[0])),t.set("g",dummyNumberToken(255*e.channels[1])),t.set("b",dummyNumberToken(255*e.channels[2])),t.set("alpha",dummyNumberToken(e.alpha))}return t}function dummyNumberToken(e){return[l.Number,e.toString(),-1,-1,{value:e,type:o.Number}]}function rgb(e,t){{const t=rgbCommaSeparated(e);if(-1!==t)return t}{const t=rgbSpaceSeparated(e);if(-1!==t)return t}{const n=rgbSpaceSeparated_RCS(e,t);if(-1!==n)return n}return-1}function rgbCommaSeparated(r){const s=[],v=[],f=[],m=[];let p=s;for(let c=0;c<r.value.length;c++){let i=r.value[c];if(!e(i)&&!t(i)){if(n(i)&&i.value[0]===l.Comma){if(p===s){p=v;continue}if(p===v){p=f;continue}if(p===f){p=m;continue}if(p===m)return-1}if(a(i)){if("calc"!==i.getName().toLowerCase())return-1;const[[e]]=u([[i]],{toCanonicalUnits:!0,precision:100});if(!e||!n(e))return-1;i=e}if(n(i)){if(i.value[0]===l.Percentage){const e=i.value;p.push([l.Number,(e[4].value/100).toString(),e[2],e[3],{value:e[4].value/100,type:o.Number}]);continue}if(i.value[0]===l.Number){let e=255;p===m&&(e=1);const t=i.value;p.push([l.Number,(t[4].value/e).toString(),t[2],t[3],{value:t[4].value/e,type:o.Number}]);continue}}return-1}}return 1!==p.length||1!==s.length||1!==v.length||1!==f.length?-1:{channels:c.sRGB_to_XYZ_D50([s[0][4].value,v[0][4].value,f[0][4].value]),alpha:1===m.length?m[0][4].value:1,currentColorSpace:i.XYZ_D50,sourceColorSpace:i.sRGB}}function rgbSpaceSeparated(r){const s=[],v=[],f=[],m=[];let p=s;for(let c=0;c<r.value.length;c++){let i=r.value[c];if(e(i)||t(i)){for(;e(r.value[c+1])||t(r.value[c+1]);)c++;if(!s.length)continue;if(p===s){p=v;continue}if(p===v){p=f;continue}}else{if(!n(i)||i.value[0]!==l.Delim||"/"!==i.value[4].value){if(a(i)){if("calc"!==i.getName().toLowerCase())return-1;const[[e]]=u([[i]],{toCanonicalUnits:!0,precision:100});if(!e||!n(e))return-1;i=e}if(n(i)){if(i.value[0]===l.Percentage){const e=i.value;p.push([l.Number,(e[4].value/100).toString(),e[2],e[3],{value:e[4].value/100,type:o.Number}]);continue}if(i.value[0]===l.Number){let e=255;p===m&&(e=1);const t=i.value;p.push([l.Number,(t[4].value/e).toString(),t[2],t[3],{value:t[4].value/e,type:o.Number}]);continue}}return-1}if(p===m)return-1;p=m}}return 1!==p.length||1!==s.length||1!==v.length||1!==f.length?-1:{channels:c.sRGB_to_XYZ_D50([s[0][4].value,v[0][4].value,f[0][4].value]),alpha:1===m.length?m[0][4].value:1,currentColorSpace:i.XYZ_D50,sourceColorSpace:i.sRGB}}function rgbSpaceSeparated_RCS(v,f){let m=null;const p=[],h=[],g=[],b=[];let C=p;for(let S=0;S<v.value.length;S++){let N=v.value[S];if(e(N)||t(N)){for(;e(v.value[S+1])||t(v.value[S+1]);)S++;if(!p.length)continue;if(C===p){C=h;continue}if(C===h){C=g;continue}}else{if(n(N)&&!m&&N.value[0]===l.Ident&&"from"===N.value[4].value.toLowerCase()){for(;e(v.value[S+1])||t(v.value[S+1]);)S++;const r=v.value[S+1];if(n(r)&&r.value[0]===l.Ident){const e=r.value[4].value.toLowerCase();if("currentcolor"===e)return-1;if("transparent"===e){m=colorDataChannelsToCalcGlobals({channels:[0,0,0],alpha:0,currentColorSpace:i.sRGB,sourceColorSpace:i.sRGB}),S++;continue}if(!Object.prototype.hasOwnProperty.call(s,e))return-1;const t=s[e];if(!t)return-1;m=colorDataChannelsToCalcGlobals({channels:[t[0]/255,t[1]/255,t[2]/255],alpha:1,currentColorSpace:i.sRGB,sourceColorSpace:i.sRGB}),S++;continue}if(a(r)){if("var"===r.getName().toLowerCase())return-1;const e=f(r);if(-1===e)return-1;m=colorDataChannelsToCalcGlobals({channels:c.XYZ_D50_to_sRGB(e.channels),alpha:e.alpha,currentColorSpace:i.sRGB,sourceColorSpace:e.sourceColorSpace}),S++;continue}}if(!m)return-1;if(!n(N)||N.value[0]!==l.Delim||"/"!==N.value[4].value){if(a(N)){if("calc"!==N.getName().toLowerCase())return-1;const[[e]]=u([[N]],{toCanonicalUnits:!0,precision:100,globals:m});if(!e||!n(e))return-1;N=e}if(n(N)){if(N.value[0]===l.Ident){const e=N.value,t=m.get(e[4].value.toLowerCase());if(!t)return-1;N=new r(t)}if(N.value[0]===l.Percentage){const e=N.value;C.push([l.Number,(e[4].value/100).toString(),e[2],e[3],{value:e[4].value/100,type:o.Number}]);continue}if(N.value[0]===l.Number){let e=255;C===b&&(e=1);const t=N.value;C.push([l.Number,(t[4].value/e).toString(),t[2],t[3],{value:t[4].value/e,type:o.Number}]);continue}}return-1}if(C===b)return-1;C=b}}return 1!==C.length||1!==p.length||1!==h.length||1!==g.length?-1:{channels:c.sRGB_to_XYZ_D50([p[0][4].value,h[0][4].value,g[0][4].value]),alpha:1===b.length?b[0][4].value:1,currentColorSpace:i.XYZ_D50,sourceColorSpace:i.sRGB}}function color(e){return a(e)&&("rgb"===e.getName().toLowerCase()||"rgba"===e.getName().toLowerCase())?rgb(e,color):-1}!function(e){e.XYZ_D50="xyz-d50",e.XYZ_D65="xyz-d65",e.sRGB="srgb"}(i||(i={}));export{i as ColorSpace,color};
