import{isWhitespaceNode as e,isCommentNode as a,isTokenNode as n,isFunctionNode as t,TokenNode as l}from"@csstools/css-parser-algorithms";import{TokenType as r,NumberType as s}from"@csstools/css-tokenizer";import{calcFromComponentValues as o}from"@csstools/css-calc";import{xyz as u,namedColors as c}from"@csstools/color-helpers";var i,m;function colorDataChannelsToCalcGlobals(e){const a=new Map;switch(e.currentColorSpace){case i.XYZ_D50:a.set("x",dummyNumberToken(e.channels[0])),a.set("y",dummyNumberToken(e.channels[1])),a.set("z",dummyNumberToken(e.channels[2])),a.set("alpha",dummyNumberToken(e.alpha));break;case i.sRGB:a.set("r",dummyNumberToken(255*e.channels[0])),a.set("g",dummyNumberToken(255*e.channels[1])),a.set("b",dummyNumberToken(255*e.channels[2])),a.set("alpha",dummyNumberToken(e.alpha))}return a}function dummyNumberToken(e){return[r.Number,e.toString(),-1,-1,{value:e,type:s.Number}]}function threeChannelLegacySyntax(l,s,u,c,h){const g=[],p=[],f=[],v=[],C={channels:[0,0,0],alpha:0,missingComponents:[!1,!1,!1,!1],currentColorSpace:i.XYZ_D50,sourceColorSpace:u,syntaxFlags:new Set(h)};let y=g;for(let s=0;s<l.value.length;s++){let u=l.value[s];if(!e(u)&&!a(u)){if(n(u)&&u.value[0]===r.Comma){if(y===g){y=p;continue}if(y===p){y=f;continue}if(y===f){y=v;continue}if(y===v)return-1}if(t(u)){if("calc"!==u.getName().toLowerCase())return-1;const[[e]]=o([[u]],{toCanonicalUnits:!0,precision:100});if(!e||!n(e))return-1;u=e}if(!n(u))return-1;y.push(u.value)}}if(1!==y.length)return-1;if(1!==g.length||1!==p.length||1!==f.length)return-1;const b=[g[0],p[0],f[0]],S=1===v.length;S&&(C.syntaxFlags.add(m.HasAlpha),b.push(v[0]));const d=s(b,C);return-1===d?-1:(C.channels=c([d[0][4].value,d[1][4].value,d[2][4].value]),C.alpha=S?d[3][4].value:1,C)}function threeChannelSpaceSeparated(l,s,u,c,h){const g=[],p=[],f=[],v=[],C={channels:[0,0,0],alpha:0,missingComponents:[!1,!1,!1,!1],currentColorSpace:i.XYZ_D50,sourceColorSpace:u,syntaxFlags:new Set(h)};let y=g;for(let s=0;s<l.value.length;s++){let u=l.value[s];if(e(u)||a(u)){for(;e(l.value[s+1])||a(l.value[s+1]);)s++;if(!g.length)continue;if(y===g){y=p;continue}if(y===p){y=f;continue}}else if(n(u)&&u.value[0]===r.Delim&&"/"===u.value[4].value){if(y===v)return-1;y=v}else{if(t(u)){if("calc"!==u.getName().toLowerCase())return-1;const[[e]]=o([[u]],{toCanonicalUnits:!0,precision:100});if(!e||!n(e))return-1;u=e}if(!n(u))return-1;y.push(u.value)}}if(1!==y.length)return-1;if(1!==g.length||1!==p.length||1!==f.length)return-1;const b=[g[0],p[0],f[0]],S=1===v.length;S&&(C.syntaxFlags.add(m.HasAlpha),b.push(v[0]));const d=s(b,C);return-1===d?-1:(C.channels=c([d[0][4].value,d[1][4].value,d[2][4].value]),C.alpha=S?d[3][4].value:1,C)}function normalize_legacy_sRGB_ChannelValues(e,a){const n=[];for(let t=0;t<e.length;t++){const l=e[t];if(l[0]!==r.Percentage){if(l[0]!==r.Number)return-1;{3!==t&&a.syntaxFlags.add(m.HasNumberValues);let e=255;3===t&&(e=1),n.push([r.Number,(l[4].value/e).toString(),l[2],l[3],{value:l[4].value/e,type:s.Number}])}}else 3!==t&&a.syntaxFlags.add(m.HasPercentageValues),n.push([r.Number,(l[4].value/100).toString(),l[2],l[3],{value:l[4].value/100,type:s.Number}])}return a.syntaxFlags.has(m.HasNumberValues)&&a.syntaxFlags.has(m.HasPercentageValues)?-1:n}function normalize_modern_sRGB_ChannelValues(e,a){const n=[];for(let t=0;t<e.length;t++){const l=e[t];if(l[0]!==r.Percentage)if(l[0]!==r.Number){if(l[0]!==r.Ident||"none"!==l[4].value.toLowerCase())return-1;a.syntaxFlags.add(m.HasNoneKeywords),a.missingComponents[t]=!0,n.push([r.Number,"0",l[2],l[3],{value:0,type:s.Number}])}else{3!==t&&a.syntaxFlags.add(m.HasNumberValues);let e=255;3===t&&(e=1),n.push([r.Number,(l[4].value/e).toString(),l[2],l[3],{value:l[4].value/e,type:s.Number}])}else 3!==t&&a.syntaxFlags.add(m.HasPercentageValues),n.push([r.Number,(l[4].value/100).toString(),l[2],l[3],{value:l[4].value/100,type:s.Number}])}return n}function rgb(e,a){{const a=rgbCommaSeparated(e);if(-1!==a)return a}{const a=rgbSpaceSeparated(e);if(-1!==a)return a}{const n=rgbSpaceSeparated_RCS(e,a);if(-1!==n)return n}return-1}function rgbCommaSeparated(e){return threeChannelLegacySyntax(e,normalize_legacy_sRGB_ChannelValues,i.sRGB,u.sRGB_to_XYZ_D50,[m.LegacyRGB])}function rgbSpaceSeparated(e){return threeChannelSpaceSeparated(e,normalize_modern_sRGB_ChannelValues,i.sRGB,u.sRGB_to_XYZ_D50,[])}function rgbSpaceSeparated_RCS(h,g){let p=null,f=1;const v=[],C=[],y=[],b=[];let S=v;for(let m=0;m<h.value.length;m++){let d=h.value[m];if(e(d)||a(d)){for(;e(h.value[m+1])||a(h.value[m+1]);)m++;if(!v.length)continue;if(S===v){S=C;continue}if(S===C){S=y;continue}}else{if(n(d)&&!p&&d.value[0]===r.Ident&&"from"===d.value[4].value.toLowerCase()){for(;e(h.value[m+1])||a(h.value[m+1]);)m++;const l=h.value[m+1];if(n(l)&&l.value[0]===r.Ident){const e=l.value[4].value.toLowerCase();if("currentcolor"===e)return-1;if("transparent"===e){p=colorDataChannelsToCalcGlobals({channels:[0,0,0],alpha:0,missingComponents:[],currentColorSpace:i.sRGB,sourceColorSpace:i.sRGB,syntaxFlags:new Set}),f=0,m++;continue}if(!Object.prototype.hasOwnProperty.call(c,e))return-1;const a=c[e];if(!a)return-1;p=colorDataChannelsToCalcGlobals({channels:[a[0]/255,a[1]/255,a[2]/255],alpha:1,missingComponents:[],currentColorSpace:i.sRGB,sourceColorSpace:i.sRGB,syntaxFlags:new Set}),f=1,m++;continue}if(t(l)){if("var"===l.getName().toLowerCase())return-1;const e=g(l);if(-1===e)return-1;p=colorDataChannelsToCalcGlobals({channels:u.XYZ_D50_to_sRGB(e.channels),alpha:e.alpha,missingComponents:[],currentColorSpace:i.sRGB,sourceColorSpace:e.sourceColorSpace,syntaxFlags:new Set}),f=e.alpha,m++;continue}}if(!p)return-1;if(!n(d)||d.value[0]!==r.Delim||"/"!==d.value[4].value){if(t(d)){if("calc"!==d.getName().toLowerCase())return-1;const[[e]]=o([[d]],{toCanonicalUnits:!0,precision:100,globals:p});if(!e||!n(e))return-1;d=e}if(n(d)){if(d.value[0]===r.Ident){const e=d.value,a=p.get(e[4].value.toLowerCase());if(!a)return-1;d=new l(a)}if(d.value[0]===r.Percentage){const e=d.value;S.push([r.Number,(e[4].value/100).toString(),e[2],e[3],{value:e[4].value/100,type:s.Number}]);continue}if(d.value[0]===r.Number){let e=255;S===b&&(e=1);const a=d.value;S.push([r.Number,(a[4].value/e).toString(),a[2],a[3],{value:a[4].value/e,type:s.Number}]);continue}}return-1}if(S===b)return-1;S=b}}return 1!==S.length||1!==v.length||1!==C.length||1!==y.length?-1:{channels:u.sRGB_to_XYZ_D50([v[0][4].value,C[0][4].value,y[0][4].value]),alpha:1===b.length?b[0][4].value:f,missingComponents:[],currentColorSpace:i.XYZ_D50,sourceColorSpace:i.sRGB,syntaxFlags:new Set([m.RelativeColorSyntax])}}function color(e){return t(e)&&("rgb"===e.getName().toLowerCase()||"rgba"===e.getName().toLowerCase())?rgb(e,color):-1}!function(e){e.XYZ_D50="xyz-d50",e.XYZ_D65="xyz-d65",e.sRGB="srgb"}(i||(i={})),function(e){e.LegacyRGB="legacy-rgb",e.LegacyHSL="legacy-hsl",e.RelativeColorSyntax="relative-color-syntax",e.HasAlpha="has-alpha",e.HasNoneKeywords="has-none-keywords",e.HasNumberValues="has-number-values",e.HasPercentageValues="has-percentage-values"}(m||(m={}));export{i as ColorSpace,color};
