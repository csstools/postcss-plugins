import{isWhitespaceNode as e,isCommentNode as a,isTokenNode as n,isFunctionNode as t}from"@csstools/css-parser-algorithms";import{TokenType as s,NumberType as r}from"@csstools/css-tokenizer";import{xyz as l,namedColors as u}from"@csstools/color-helpers";import{calcFromComponentValues as o}from"@csstools/css-calc";var i,c;!function(e){e.XYZ_D50="xyz-d50",e.XYZ_D65="xyz-d65",e.sRGB="srgb"}(i||(i={})),function(e){e.ColorKeyword="color-keyword",e.HasAlpha="has-alpha",e.HasDimensionValues="has-dimension-values",e.HasNoneKeywords="has-none-keywords",e.HasNumberValues="has-number-values",e.HasPercentageAlpha="has-percentage-alpha",e.HasPercentageValues="has-percentage-values",e.HasVariableAlpha="has-variable-alpha",e.Hex="hex",e.LegacyHSL="legacy-hsl",e.LegacyRGB="legacy-rgb",e.NamedColor="named-color",e.RelativeColorSyntax="relative-color-syntax"}(c||(c={}));const h=/[A-Z]/g;function toLowerCaseAZ(e){return e.replace(h,(e=>String.fromCharCode(e.charCodeAt(0)+32)))}function hex(e){const a=toLowerCaseAZ(e[4].value);if(a.match(/[^a-f0-9]/))return!1;const n={colorSpace:i.XYZ_D50,channels:[0,0,0],sourceColorSpace:i.sRGB,alpha:1,missingComponents:[!1,!1,!1,!1],syntaxFlags:new Set([c.Hex])},t=a.length;if(3===t){const e=a[0],t=a[1],s=a[2];return n.channels=l.sRGB_to_XYZ_D50([parseInt(e+e,16)/255,parseInt(t+t,16)/255,parseInt(s+s,16)/255]),n}if(6===t){const e=a[0]+a[1],t=a[2]+a[3],s=a[4]+a[5];return n.channels=l.sRGB_to_XYZ_D50([parseInt(e,16)/255,parseInt(t,16)/255,parseInt(s,16)/255]),n}if(4===t){const e=a[0],t=a[1],s=a[2],r=a[3];return n.channels=l.sRGB_to_XYZ_D50([parseInt(e+e,16)/255,parseInt(t+t,16)/255,parseInt(s+s,16)/255]),n.alpha=parseInt(r+r,16)/255,n.syntaxFlags.add(c.HasAlpha),n}if(8===t){const e=a[0]+a[1],t=a[2]+a[3],s=a[4]+a[5],r=a[6]+a[7];return n.channels=l.sRGB_to_XYZ_D50([parseInt(e,16)/255,parseInt(t,16)/255,parseInt(s,16)/255]),n.alpha=parseInt(r,16)/255,n.syntaxFlags.add(c.HasAlpha),n}return!1}function normalizeHue(e){if(e[0]===s.Number)return e[4].value=e[4].value%360,e[1]=e[4].value.toString(),e;if(e[0]===s.Dimension){let a=e[4].value;switch(toLowerCaseAZ(e[4].unit)){case"deg":break;case"rad":a=180*e[4].value/Math.PI;break;case"grad":a=.9*e[4].value;break;case"turn":a=360*e[4].value;break;default:return!1}return a%=360,[s.Number,a.toString(),e[2],e[3],{value:a,type:r.Number}]}return!1}function normalize_legacy_HSL_ChannelValues(e,a){const n=[];for(let t=0;t<e.length;t++){const l=e[t];if(0!==t)if(l[0]!==s.Percentage){if(l[0]!==s.Number)return!1;{3!==t&&a.syntaxFlags.add(c.HasNumberValues);let e=1;3===t&&(e=1),n.push([s.Number,(l[4].value/e).toString(),l[2],l[3],{value:l[4].value/e,type:r.Number}])}}else{3===t?a.syntaxFlags.add(c.HasPercentageAlpha):a.syntaxFlags.add(c.HasPercentageValues);let e=1;3===t&&(e=100),n.push([s.Number,(l[4].value/e).toString(),l[2],l[3],{value:l[4].value/e,type:r.Number}])}else{const e=normalizeHue(l);if(!1===e)return!1;l[0]===s.Dimension&&a.syntaxFlags.add(c.HasDimensionValues),n.push(e)}}return!a.syntaxFlags.has(c.HasNumberValues)&&n}function normalize_modern_HSL_ChannelValues(e,a){const n=[];for(let t=0;t<e.length;t++){const l=e[t];if(l[0]!==s.Ident||"none"!==toLowerCaseAZ(l[4].value))if(0!==t)if(l[0]!==s.Percentage){if(l[0]!==s.Number)return!1;{3!==t&&a.syntaxFlags.add(c.HasNumberValues);let e=1;3===t&&(e=1),n.push([s.Number,(l[4].value/e).toString(),l[2],l[3],{value:l[4].value/e,type:r.Number}])}}else{3===t?a.syntaxFlags.add(c.HasPercentageAlpha):a.syntaxFlags.add(c.HasPercentageValues);let e=1;3===t&&(e=100),n.push([s.Number,(l[4].value/e).toString(),l[2],l[3],{value:l[4].value/e,type:r.Number}])}else{const e=normalizeHue(l);if(!1===e)return!1;l[0]===s.Dimension&&a.syntaxFlags.add(c.HasDimensionValues),n.push(e)}else a.syntaxFlags.add(c.HasNoneKeywords),a.missingComponents[t]=!0,n.push([s.Number,"0",l[2],l[3],{value:0,type:r.Number}])}return n}function threeChannelLegacySyntax(r,l,u,h,p){const g=[],m=[],f=[],d=[],v={colorSpace:i.XYZ_D50,channels:[0,0,0],sourceColorSpace:u,alpha:1,missingComponents:[!1,!1,!1,!1],syntaxFlags:new Set(p)};let y=g;for(let l=0;l<r.value.length;l++){let u=r.value[l];if(!e(u)&&!a(u)){if(n(u)&&u.value[0]===s.Comma){if(y===g){y=m;continue}if(y===m){y=f;continue}if(y===f){y=d;continue}if(y===d)return!1}if(t(u)){if(y===d&&"var"===toLowerCaseAZ(u.getName())){v.syntaxFlags.add(c.HasVariableAlpha),y.push(u);continue}if("calc"!==toLowerCaseAZ(u.getName()))return!1;const[[e]]=o([[u]],{toCanonicalUnits:!0,precision:100});if(!e||!n(e))return!1;u=e}if(!n(u))return!1;y.push(u)}}if(1!==y.length)return!1;if(1!==g.length||1!==m.length||1!==f.length)return!1;if(!n(g[0])||!n(m[0])||!n(f[0]))return!1;const _=[g[0].value,m[0].value,f[0].value];1===d.length&&(v.syntaxFlags.add(c.HasAlpha),n(d[0])?_.push(d[0].value):v.alpha=d[0]);const b=l(_,v);return!1!==b&&(v.channels=h([b[0][4].value,b[1][4].value,b[2][4].value]),4===b.length&&(v.alpha=b[3][4].value),v)}function threeChannelSpaceSeparated(r,l,u,h,p){const g=[],m=[],f=[],d=[],v={colorSpace:i.XYZ_D50,channels:[0,0,0],sourceColorSpace:u,alpha:1,missingComponents:[!1,!1,!1,!1],syntaxFlags:new Set(p)};let y=g;for(let l=0;l<r.value.length;l++){let u=r.value[l];if(e(u)||a(u)){for(;e(r.value[l+1])||a(r.value[l+1]);)l++;if(!g.length)continue;if(y===g){y=m;continue}if(y===m){y=f;continue}}else if(n(u)&&u.value[0]===s.Delim&&"/"===u.value[4].value){if(y===d)return!1;y=d}else{if(t(u)){if(y===d&&"var"===toLowerCaseAZ(u.getName())){v.syntaxFlags.add(c.HasVariableAlpha),y.push(u);continue}if("calc"!==toLowerCaseAZ(u.getName()))return!1;const[[e]]=o([[u]],{toCanonicalUnits:!0,precision:100});if(!e||!n(e))return!1;u=e}if(!n(u))return!1;y.push(u)}}if(1!==y.length)return!1;if(1!==g.length||1!==m.length||1!==f.length)return!1;if(!n(g[0])||!n(m[0])||!n(f[0]))return!1;const _=[g[0].value,m[0].value,f[0].value];1===d.length&&(v.syntaxFlags.add(c.HasAlpha),n(d[0])?_.push(d[0].value):v.alpha=d[0]);const b=l(_,v);return!1!==b&&(v.channels=h([b[0][4].value,b[1][4].value,b[2][4].value]),4===b.length&&(v.alpha=b[3][4].value),v)}function hsl(e,a){{const a=hslCommaSeparated(e);if(!1!==a)return a}{const a=hslSpaceSeparated(e);if(!1!==a)return a}return!1}function hslCommaSeparated(e){return threeChannelLegacySyntax(e,normalize_legacy_HSL_ChannelValues,i.sRGB,l.HSL_to_XYZ_D50,[c.LegacyHSL])}function hslSpaceSeparated(e){return threeChannelSpaceSeparated(e,normalize_modern_HSL_ChannelValues,i.sRGB,l.HSL_to_XYZ_D50,[])}function normalize_modern_HWB_ChannelValues(e,a){const n=[];for(let t=0;t<e.length;t++){const l=e[t];if(l[0]!==s.Ident||"none"!==toLowerCaseAZ(l[4].value))if(0!==t)if(l[0]!==s.Percentage){if(l[0]!==s.Number)return!1;if(3!==t)return!1;n.push([s.Number,l[1],l[2],l[3],{value:l[4].value,type:r.Number}])}else{3===t?a.syntaxFlags.add(c.HasPercentageAlpha):a.syntaxFlags.add(c.HasPercentageValues);let e=1;3===t&&(e=100),n.push([s.Number,(l[4].value/e).toString(),l[2],l[3],{value:l[4].value/e,type:r.Number}])}else{const e=normalizeHue(l);if(!1===e)return!1;l[0]===s.Dimension&&a.syntaxFlags.add(c.HasDimensionValues),n.push(e)}else a.syntaxFlags.add(c.HasNoneKeywords),a.missingComponents[t]=!0,n.push([s.Number,"0",l[2],l[3],{value:0,type:r.Number}])}return n}function hwb(e,a){{const a=hwbSpaceSeparated(e);if(!1!==a)return a}return!1}function hwbSpaceSeparated(e){return threeChannelSpaceSeparated(e,normalize_modern_HWB_ChannelValues,i.sRGB,l.HWB_to_XYZ_D50,[])}function normalize_legacy_sRGB_ChannelValues(e,a){const n=[];for(let t=0;t<e.length;t++){const l=e[t];if(l[0]!==s.Percentage){if(l[0]!==s.Number)return!1;{3!==t&&a.syntaxFlags.add(c.HasNumberValues);let e=255;3===t&&(e=1),n.push([s.Number,(l[4].value/e).toString(),l[2],l[3],{value:l[4].value/e,type:r.Number}])}}else 3===t?a.syntaxFlags.add(c.HasPercentageAlpha):a.syntaxFlags.add(c.HasPercentageValues),n.push([s.Number,(l[4].value/100).toString(),l[2],l[3],{value:l[4].value/100,type:r.Number}])}return(!a.syntaxFlags.has(c.HasNumberValues)||!a.syntaxFlags.has(c.HasPercentageValues))&&n}function normalize_modern_sRGB_ChannelValues(e,a){const n=[];for(let t=0;t<e.length;t++){const l=e[t];if(l[0]!==s.Percentage)if(l[0]!==s.Number){if(l[0]!==s.Ident||"none"!==toLowerCaseAZ(l[4].value))return!1;a.syntaxFlags.add(c.HasNoneKeywords),a.missingComponents[t]=!0,n.push([s.Number,"0",l[2],l[3],{value:0,type:r.Number}])}else{3!==t&&a.syntaxFlags.add(c.HasNumberValues);let e=255;3===t&&(e=1),n.push([s.Number,(l[4].value/e).toString(),l[2],l[3],{value:l[4].value/e,type:r.Number}])}else 3!==t&&a.syntaxFlags.add(c.HasPercentageValues),n.push([s.Number,(l[4].value/100).toString(),l[2],l[3],{value:l[4].value/100,type:r.Number}])}return n}function rgb(e,a){{const a=rgbCommaSeparated(e);if(!1!==a)return a}{const a=rgbSpaceSeparated(e);if(!1!==a)return a}return!1}function rgbCommaSeparated(e){return threeChannelLegacySyntax(e,normalize_legacy_sRGB_ChannelValues,i.sRGB,l.sRGB_to_XYZ_D50,[c.LegacyRGB])}function rgbSpaceSeparated(e){return threeChannelSpaceSeparated(e,normalize_modern_sRGB_ChannelValues,i.sRGB,l.sRGB_to_XYZ_D50,[])}const p=new Map;for(const[e,a]of Object.entries(u))p.set(e,a);function namedColor(e){const a=p.get(toLowerCaseAZ(e));return!!a&&{colorSpace:i.XYZ_D50,channels:l.sRGB_to_XYZ_D50([a[0]/255,a[1]/255,a[2]/255]),sourceColorSpace:i.sRGB,alpha:1,missingComponents:[!1,!1,!1,!1],syntaxFlags:new Set([c.ColorKeyword,c.NamedColor])}}function color(e){if(t(e)){const a=toLowerCaseAZ(e.getName());return"rgb"===a||"rgba"===a?rgb(e):"hsl"===a||"hsla"===a?hsl(e):"hwb"===a&&hwb(e)}if(n(e)){if(e.value[0]===s.Hash)return hex(e.value);if(e.value[0]===s.Ident){const a=namedColor(e.value[4].value);if(!1!==a)return a;const n="transparent"===toLowerCaseAZ(e.value[4].value)&&{colorSpace:i.XYZ_D50,channels:[0,0,0],sourceColorSpace:i.sRGB,alpha:0,missingComponents:[!1,!1,!1,!1],syntaxFlags:new Set([c.ColorKeyword])};return!1!==n&&n}return!1}return!1}export{i as ColorSpace,color};
