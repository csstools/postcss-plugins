import{isWhitespaceNode as e,isCommentNode as a,isTokenNode as n,isFunctionNode as t,TokenNode as r}from"@csstools/css-parser-algorithms";import{xyz as l,namedColors as s}from"@csstools/color-helpers";import{TokenType as o,NumberType as u}from"@csstools/css-tokenizer";import{calcFromComponentValues as c}from"@csstools/css-calc";var i,m;function colorDataChannelsToCalcGlobals(e){const a=new Map;switch(e.colorSpace){case i.XYZ_D50:a.set("x",dummyNumberToken(e.channels[0])),a.set("y",dummyNumberToken(e.channels[1])),a.set("z",dummyNumberToken(e.channels[2])),a.set("alpha",dummyNumberToken(e.alpha));break;case i.sRGB:a.set("r",dummyNumberToken(255*e.channels[0])),a.set("g",dummyNumberToken(255*e.channels[1])),a.set("b",dummyNumberToken(255*e.channels[2])),a.set("alpha",dummyNumberToken(e.alpha))}return a}function dummyNumberToken(e){return[o.Number,e.toString(),-1,-1,{value:e,type:u.Number}]}function colorDataToColorSpace(e,a){if(-1===e)return-1;if(e.colorSpace!==i.XYZ_D50)return-1;switch(a){case i.XYZ_D50:return e;case i.sRGB:return e.colorSpace=i.sRGB,e.channels=l.XYZ_D50_to_sRGB(e.channels),e}return-1}function normalizeHue(e){if(e[0]===o.Number)return e[4].value=e[4].value%360,e[1]=e[4].value.toString(),e;if(e[0]===o.Dimension){let a=e[4].value;switch(e[4].unit.toLowerCase()){case"deg":break;case"rad":a=180*e[4].value/Math.PI;break;case"grad":a=.9*e[4].value;break;case"turn":a=360*e[4].value;break;default:return-1}return a%=360,[o.Number,a.toString(),e[2],e[3],{value:a,type:u.Number}]}return-1}function normalize_legacy_HSL_ChannelValues(e,a){const n=[];for(let t=0;t<e.length;t++){const r=e[t];if(0!==t)if(r[0]!==o.Percentage){if(r[0]!==o.Number)return-1;{3!==t&&a.syntaxFlags.add(m.HasNumberValues);let e=1;3===t&&(e=1),n.push([o.Number,(r[4].value/e).toString(),r[2],r[3],{value:r[4].value/e,type:u.Number}])}}else{3===t?a.syntaxFlags.add(m.HasPercentageAlpha):a.syntaxFlags.add(m.HasPercentageValues);let e=1;3===t&&(e=100),n.push([o.Number,(r[4].value/e).toString(),r[2],r[3],{value:r[4].value/e,type:u.Number}])}else{const e=normalizeHue(r);if(-1===e)return-1;r[0]===o.Dimension&&a.syntaxFlags.add(m.HasDimensionValues),n.push(e)}}return a.syntaxFlags.has(m.HasNumberValues)?-1:n}function normalize_modern_HSL_ChannelValues(e,a){const n=[];for(let t=0;t<e.length;t++){const r=e[t];if(r[0]!==o.Ident||"none"!==r[4].value.toLowerCase())if(0!==t)if(r[0]!==o.Percentage){if(r[0]!==o.Number)return-1;{3!==t&&a.syntaxFlags.add(m.HasNumberValues);let e=1;3===t&&(e=1),n.push([o.Number,(r[4].value/e).toString(),r[2],r[3],{value:r[4].value/e,type:u.Number}])}}else{3===t?a.syntaxFlags.add(m.HasPercentageAlpha):a.syntaxFlags.add(m.HasPercentageValues);let e=1;3===t&&(e=100),n.push([o.Number,(r[4].value/e).toString(),r[2],r[3],{value:r[4].value/e,type:u.Number}])}else{const e=normalizeHue(r);if(-1===e)return-1;r[0]===o.Dimension&&a.syntaxFlags.add(m.HasDimensionValues),n.push(e)}else a.syntaxFlags.add(m.HasNoneKeywords),a.missingComponents[t]=!0,n.push([o.Number,"0",r[2],r[3],{value:0,type:u.Number}])}return a.syntaxFlags.has(m.HasNumberValues)?-1:n}function threeChannelLegacySyntax(r,l,s,u,h){const g=[],p=[],f=[],v=[],d={colorSpace:i.XYZ_D50,channels:[0,0,0],sourceColorSpace:s,alpha:0,missingComponents:[!1,!1,!1,!1],syntaxFlags:new Set(h)};let b=g;for(let l=0;l<r.value.length;l++){let s=r.value[l];if(!e(s)&&!a(s)){if(n(s)&&s.value[0]===o.Comma){if(b===g){b=p;continue}if(b===p){b=f;continue}if(b===f){b=v;continue}if(b===v)return-1}if(t(s)){if("calc"!==s.getName().toLowerCase())return-1;const[[e]]=c([[s]],{toCanonicalUnits:!0,precision:100});if(!e||!n(e))return-1;s=e}if(!n(s))return-1;b.push(s.value)}}if(1!==b.length)return-1;if(1!==g.length||1!==p.length||1!==f.length)return-1;const y=[g[0],p[0],f[0]],S=1===v.length;S&&(d.syntaxFlags.add(m.HasAlpha),y.push(v[0]));const C=l(y,d);return-1===C?-1:(d.channels=u([C[0][4].value,C[1][4].value,C[2][4].value]),d.alpha=S?C[3][4].value:1,d)}function threeChannelSpaceSeparated(r,l,s,u,h){const g=[],p=[],f=[],v=[],d={colorSpace:i.XYZ_D50,channels:[0,0,0],sourceColorSpace:s,alpha:0,missingComponents:[!1,!1,!1,!1],syntaxFlags:new Set(h)};let b=g;for(let l=0;l<r.value.length;l++){let s=r.value[l];if(e(s)||a(s)){for(;e(r.value[l+1])||a(r.value[l+1]);)l++;if(!g.length)continue;if(b===g){b=p;continue}if(b===p){b=f;continue}}else if(n(s)&&s.value[0]===o.Delim&&"/"===s.value[4].value){if(b===v)return-1;b=v}else{if(t(s)){if("calc"!==s.getName().toLowerCase())return-1;const[[e]]=c([[s]],{toCanonicalUnits:!0,precision:100});if(!e||!n(e))return-1;s=e}if(!n(s))return-1;b.push(s.value)}}if(1!==b.length)return-1;if(1!==g.length||1!==p.length||1!==f.length)return-1;const y=[g[0],p[0],f[0]],S=1===v.length;S&&(d.syntaxFlags.add(m.HasAlpha),y.push(v[0]));const C=l(y,d);return-1===C?-1:(d.channels=u([C[0][4].value,C[1][4].value,C[2][4].value]),d.alpha=S?C[3][4].value:1,d)}function hsl(e,a){{const a=hslCommaSeparated(e);if(-1!==a)return a}{const a=hslSpaceSeparated(e);if(-1!==a)return a}return-1}function hslCommaSeparated(e){return threeChannelLegacySyntax(e,normalize_legacy_HSL_ChannelValues,i.sRGB,l.HSL_to_XYZ_D50,[m.LegacyHSL])}function hslSpaceSeparated(e){return threeChannelSpaceSeparated(e,normalize_modern_HSL_ChannelValues,i.sRGB,l.HSL_to_XYZ_D50,[])}function normalize_modern_HWB_ChannelValues(e,a){const n=[];for(let t=0;t<e.length;t++){const r=e[t];if(r[0]!==o.Ident||"none"!==r[4].value.toLowerCase())if(0!==t)if(r[0]!==o.Percentage){if(r[0]!==o.Number)return-1;if(3!==t)return-1;n.push([o.Number,r[1],r[2],r[3],{value:r[4].value,type:u.Number}])}else{3===t?a.syntaxFlags.add(m.HasPercentageAlpha):a.syntaxFlags.add(m.HasPercentageValues);let e=1;3===t&&(e=100),n.push([o.Number,(r[4].value/e).toString(),r[2],r[3],{value:r[4].value/e,type:u.Number}])}else{const e=normalizeHue(r);if(-1===e)return-1;r[0]===o.Dimension&&a.syntaxFlags.add(m.HasDimensionValues),n.push(e)}else a.syntaxFlags.add(m.HasNoneKeywords),a.missingComponents[t]=!0,n.push([o.Number,"0",r[2],r[3],{value:0,type:u.Number}])}return n}function hwb(e,a){{const a=hwbSpaceSeparated(e);if(-1!==a)return a}return-1}function hwbSpaceSeparated(e){return threeChannelSpaceSeparated(e,normalize_modern_HWB_ChannelValues,i.sRGB,l.HWB_to_XYZ_D50,[])}!function(e){e.XYZ_D50="xyz-d50",e.XYZ_D65="xyz-d65",e.sRGB="srgb"}(i||(i={})),function(e){e.ColorKeyword="color-keyword",e.HasAlpha="has-alpha",e.HasNoneKeywords="has-none-keywords",e.HasNumberValues="has-number-values",e.HasPercentageValues="has-percentage-values",e.HasDimensionValues="has-dimension-values",e.HasPercentageAlpha="has-percentage-alpha",e.LegacyHSL="legacy-hsl",e.LegacyRGB="legacy-rgb",e.NamedColor="named-color",e.RelativeColorSyntax="relative-color-syntax"}(m||(m={}));const h=new Map;for(const[e,a]of Object.entries(s))h.set(e.toLowerCase(),a);function namedColor(e){const a=h.get(e);return a?{colorSpace:i.XYZ_D50,channels:l.sRGB_to_XYZ_D50([a[0]/255,a[1]/255,a[2]/255]),sourceColorSpace:i.sRGB,alpha:1,missingComponents:[!1,!1,!1,!1],syntaxFlags:new Set([m.ColorKeyword,m.NamedColor])}:-1}function normalize_legacy_sRGB_ChannelValues(e,a){const n=[];for(let t=0;t<e.length;t++){const r=e[t];if(r[0]!==o.Percentage){if(r[0]!==o.Number)return-1;{3!==t&&a.syntaxFlags.add(m.HasNumberValues);let e=255;3===t&&(e=1),n.push([o.Number,(r[4].value/e).toString(),r[2],r[3],{value:r[4].value/e,type:u.Number}])}}else 3===t?a.syntaxFlags.add(m.HasPercentageAlpha):a.syntaxFlags.add(m.HasPercentageValues),n.push([o.Number,(r[4].value/100).toString(),r[2],r[3],{value:r[4].value/100,type:u.Number}])}return a.syntaxFlags.has(m.HasNumberValues)&&a.syntaxFlags.has(m.HasPercentageValues)?-1:n}function normalize_modern_sRGB_ChannelValues(e,a){const n=[];for(let t=0;t<e.length;t++){const r=e[t];if(r[0]!==o.Percentage)if(r[0]!==o.Number){if(r[0]!==o.Ident||"none"!==r[4].value.toLowerCase())return-1;a.syntaxFlags.add(m.HasNoneKeywords),a.missingComponents[t]=!0,n.push([o.Number,"0",r[2],r[3],{value:0,type:u.Number}])}else{3!==t&&a.syntaxFlags.add(m.HasNumberValues);let e=255;3===t&&(e=1),n.push([o.Number,(r[4].value/e).toString(),r[2],r[3],{value:r[4].value/e,type:u.Number}])}else 3!==t&&a.syntaxFlags.add(m.HasPercentageValues),n.push([o.Number,(r[4].value/100).toString(),r[2],r[3],{value:r[4].value/100,type:u.Number}])}return n}function rgb(e,a){{const a=rgbCommaSeparated(e);if(-1!==a)return a}{const a=rgbSpaceSeparated(e);if(-1!==a)return a}{const n=rgbSpaceSeparated_RCS(e,a);if(-1!==n)return n}return-1}function rgbCommaSeparated(e){return threeChannelLegacySyntax(e,normalize_legacy_sRGB_ChannelValues,i.sRGB,l.sRGB_to_XYZ_D50,[m.LegacyRGB])}function rgbSpaceSeparated(e){return threeChannelSpaceSeparated(e,normalize_modern_sRGB_ChannelValues,i.sRGB,l.sRGB_to_XYZ_D50,[])}function rgbSpaceSeparated_RCS(s,h){let g=null,p=1;const f=[],v=[],d=[],b=[],y={channels:[0,0,0],colorSpace:i.XYZ_D50,sourceColorSpace:i.sRGB,alpha:0,missingComponents:[!1,!1,!1,!1],syntaxFlags:new Set([m.RelativeColorSyntax])};let S=f;for(let l=0;l<s.value.length;l++){let y=s.value[l];if(e(y)||a(y)){for(;e(s.value[l+1])||a(s.value[l+1]);)l++;if(!f.length)continue;if(S===f){S=v;continue}if(S===v){S=d;continue}}else{if(n(y)&&!g&&y.value[0]===o.Ident&&"from"===y.value[4].value.toLowerCase()){for(;e(s.value[l+1])||a(s.value[l+1]);)l++;const r=s.value[l+1];if(n(r)&&r.value[0]===o.Ident){const e=r.value[4].value.toLowerCase();{const a=colorDataToColorSpace("transparent"===e?{colorSpace:i.XYZ_D50,channels:[0,0,0],sourceColorSpace:i.sRGB,alpha:0,missingComponents:[!1,!1,!1,!1],syntaxFlags:new Set([m.ColorKeyword,m.NamedColor])}:-1,i.sRGB);if(-1!==a){g=colorDataChannelsToCalcGlobals(a),p=a.alpha,l++;continue}}{const a=colorDataToColorSpace(namedColor(e),i.sRGB);if(-1!==a){g=colorDataChannelsToCalcGlobals(a),p=a.alpha,l++;continue}}return-1}if(t(r)){if("var"===r.getName().toLowerCase())return-1;const e=colorDataToColorSpace(h(r),i.sRGB);if(-1===e)return-1;g=colorDataChannelsToCalcGlobals(e),p=e.alpha,l++;continue}}if(!g)return-1;if(!n(y)||y.value[0]!==o.Delim||"/"!==y.value[4].value){if(t(y)){if("calc"!==y.getName().toLowerCase())return-1;const[[e]]=c([[y]],{toCanonicalUnits:!0,precision:100,globals:g});if(!e||!n(e))return-1;y=e}if(n(y)){if(y.value[0]===o.Ident){const e=y.value,a=g.get(e[4].value.toLowerCase());if(!a)return-1;y=new r(a)}if(y.value[0]===o.Percentage){const e=y.value;S.push([o.Number,(e[4].value/100).toString(),e[2],e[3],{value:e[4].value/100,type:u.Number}]);continue}if(y.value[0]===o.Number){let e=255;S===b&&(e=1);const a=y.value;S.push([o.Number,(a[4].value/e).toString(),a[2],a[3],{value:a[4].value/e,type:u.Number}]);continue}}return-1}if(S===b)return-1;S=b}}return 1!==S.length||1!==f.length||1!==v.length||1!==d.length?-1:(y.channels=l.sRGB_to_XYZ_D50([f[0][4].value,v[0][4].value,d[0][4].value]),y.alpha=1===b.length?b[0][4].value:p,y)}function color(e){if(!t(e))return-1;const a=e.getName().toLowerCase();return"rgb"===a||"rgba"===a?rgb(e,color):"hsl"===a||"hsla"===a?hsl(e):"hwb"===a?hwb(e):-1}export{i as ColorSpace,color};
