"use strict";var e=require("postcss"),n=require("postcss-8.2"),s=require("path"),o=require("fs"),t=require("assert");function r(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var c=r(e),l=r(n),i=r(s),a=r(o);function p(e,n="error",s={}){let o="::"+n;const t=Object.keys(s).map((e=>{let n=String(s[e]);return"file"===e&&process.env.GITHUB_WORKSPACE&&(n=i.default.relative(process.env.GITHUB_WORKSPACE,i.default.resolve(n))),`${e}=${o=n,o.replace(/\r/g,"%0D").replace(/\n/g,"%0A").replace(/]/g,"%5D").replace(/;/g,"%3B")}`;var o})).join(",");return t&&(o+=` ${t}`),`${o}::${r=e||"",r.replace(/\r/g,"%0D").replace(/\n/g,"%0A")}`;var r}const u="----------------------------------------";function g(e,n,s,o=!1){let t="";if(t+=`\n${e}\n\n`,n.message&&(t+=`message :\n  ${n.message}\n\n`),n.options)try{t+=`options :\n${JSON.stringify(n.options,null,2)}\n\n`}catch(e){}return t+=`output changed :\n${function(e){const n=/[^\\](\\n)/gm,s=/(\\t)/gm;return e.replace(n,((e,n)=>e.replace(n," "))).replace(s,((e,n)=>e.replace(n," "))).replace(/\+$/gm,"").replace(/^Expected values to be strictly equal:\n/,"")}(s.message)}\n`,o||(t+="\n"+u),t}function d(e,n,s,o,t=!1){let r="";if(r+=`\n${e}\n\n`,n.message&&(r+=`message :\n  ${n.message}\n\n`),n.options)try{r+=`options :\n${JSON.stringify(n.options,null,2)}\n\n`}catch(e){}return r+=`unexpected or missing warnings :\n+ actual ${s.length}\n- expected ${o}\n`,t||(s.forEach((e=>{r+=`\n[${e.plugin}]: ${e.text}`})),s.length&&(r+="\n"),r+="\n"+u),r}const f=()=>({postcssPlugin:"noop-plugin",Rule(){}});function m(e){"CssSyntaxError"!==e.name||process.env.DEBUG||(delete e.source,e.input&&delete e.input.source,delete e.postcssNode)}f.postcss=!0;const $=process.env.GITHUB_ACTIONS&&"true"===process.env.ENABLE_ANNOTATIONS_FOR_NODE&&"true"===process.env.ENABLE_ANNOTATIONS_FOR_OS;module.exports=function(e){let n=!1;{!0!==e.postcss&&(n=!0,$?console.log(p('postcss flag not set to "true" on exported plugin object',"error",{file:"./package.json",line:1,col:1})):console.error(`\npostcss flag not set to "true"\n\n${u}`));const s=e();s.postcssPlugin&&"string"==typeof s.postcssPlugin||(n=!0,$?console.log(p('plugin name not set via "postcssPlugin"',"error",{file:"./package.json",line:1,col:1})):console.error(`\nplugin name not set via "postcssPlugin"\n\n${u}`));const o=JSON.parse(a.default.readFileSync("./package.json").toString());o.keywords&&o.keywords.includes("postcss-plugin")||(n=!0,$?console.log(p('package.json does not include "postcss-plugin" keyword',"error",{file:"./package.json",line:1,col:1})):console.error(`\npackage.json does not include "postcss-plugin" keyword\n\n${u}`));const t=["css-has-pseudo","css-blank-pseudo","css-prefers-color-scheme","@csstools/css-has-pseudo-experimental"].includes(o.name);o.name.startsWith("postcss-")||o.name.startsWith("@csstools/postcss-")||t||(n=!0,$?console.log(p('plugin name in package.json does not start with "postcss-"',"error",{file:"./package.json",line:1,col:1})):console.error(`\nplugin name in package.json does not start with "postcss-"\n\n${u}`)),Object.keys(Object(o.dependencies)).includes("postcss")&&!("postcssTapeSelfTest"in e)&&(n=!0,$?console.log(p("postcss should only be a peer and/or dev dependency","error",{file:"./package.json",line:1,col:1})):console.error(`\npostcss should only be a peer and/or dev dependency\n\n${u}`))}return async s=>{const r=new Set;for(const w in s){var a;const h=s[w];h.before&&await h.before();const S=i.default.join(".","test",w.split(":")[0]),y=i.default.join(".","test",w.replace(/:/g,".")),b=`${S}.css`;let k=`${y}.expect.css`,v=`${y}.result.css`;h.expect&&(k=i.default.join(".","test",h.expect)),h.result&&(v=i.default.join(".","test",h.result));const x=null!=(a=h.plugins)?a:[e(h.options)],O=await o.promises.readFile(b,"utf8");let j,E="";try{E=await o.promises.readFile(k,"utf8")}catch(e){n=!0,E=!1,$?console.log(p(`${w}\n\nmissing or broken "expect" file: "${i.default.parse(k).base}"`,"error",{file:b,line:1,col:1})):(r.add(w),console.error(`\n${w}\n\nmissing or broken "expect" file: "${i.default.parse(k).base}"\n\n${u}`))}let N=!1;try{j=await c.default(x).process(O,{from:b,to:v,map:{inline:!1,annotation:!1}})}catch(e){if(m(e),N=!0,h.exception&&h.exception.test(e.message))continue;throw e}!N&&h.exception&&(n=!0,$?console.log(p(`${w}\n\nexpected an exception but got none`,"error",{file:b,line:1,col:1})):(r.add(w),console.error(`\n${w}\n\nexpected an exception but got none\n\n${u}`)));const P=j.css.toString();if(await o.promises.writeFile(v,P,"utf8"),process.env.REWRITE_EXPECTS&&o.promises.writeFile(k,P,"utf8"),!1!==E){try{t.strict.strictEqual(P,E)}catch(e){n=!0,$?console.log(p(g(w,h,e,!0),"error",{file:k,line:1,col:1})):(r.add(w),console.error(g(w,h,e)))}try{if(j.map.toJSON().sources.includes("<no source>"))throw new Error("Sourcemap is broken")}catch(e){n=!0;const s='\nThis is most likely a newly created PostCSS AST Node without a value for "source".\nsee :\n- https://github.com/postcss/postcss/blob/main/docs/guidelines/plugin.md#24-set-nodesource-for-new-nodes\n- https://postcss.org/api/#node-source';$?console.log(p(`${w}\n\nbroken source map: ${JSON.stringify(j.map.toJSON().sources)}\n${s}`,"error",{file:b,line:1,col:1})):(r.add(w),console.error(`\n${w}\n\nbroken source map: ${JSON.stringify(j.map.toJSON().sources)}\n${s}\n\n${u}`))}h.after&&await h.after();try{const e=await o.promises.readFile(v,"utf8");if((await c.default([f()]).process(e,{from:v,to:v,map:{inline:!1,annotation:!1}})).warnings().length)throw new Error("Unexpected warnings on second pass")}catch(e){n=!0,$?console.log(p(`${w}\n\nresult was not parsable with PostCSS.`,"error",{file:k,line:1,col:1})):(r.add(w),console.error(`\n${w}\n\nresult was not parsable with PostCSS.\n\n${u}`))}if(c.default([f()]).version!==l.default([f()]).version){const e=await l.default(x).process(O,{from:b,to:v,map:{inline:!1,annotation:!1}});try{t.strict.strictEqual(e.css.toString(),P)}catch(e){m(e),n=!0,$?console.log(p("testing older PostCSS:\n"+g(w,h,e,!0),"error",{file:k,line:1,col:1})):(r.add(w),console.error("testing older PostCSS:\n"+g(w,h,e)))}}try{(j.warnings().length||h.warnings)&&t.strict.strictEqual(j.warnings().length,h.warnings)}catch(e){n=!0,$?console.log(p(d(w,h,j.warnings(),h.warnings,!0),"error",{file:k,line:1,col:1})):(r.add(w),console.error(d(w,h,j.warnings(),h.warnings)))}}}if(r.size){console.error("\nunexpected failures:");for(const e of r.values())console.error("  - "+e)}n&&process.exit(1),console.warn("pass "+e().postcssPlugin)}};
