import{TokenType as e,NumberType as n,isToken as t,tokenizer as r,stringify as u}from"@csstools/css-tokenizer";import{isTokenNode as i,TokenNode as a,isCommentNode as o,isWhitespaceNode as l,isSimpleBlockNode as c,isFunctionNode as s,FunctionNode as v,WhitespaceNode as m,parseCommaSeparatedListOfComponentValues as f}from"@csstools/css-parser-algorithms";function isCalculation(e){return!!e&&"object"==typeof e&&"inputs"in e&&Array.isArray(e.inputs)&&"operation"in e}function solve(e){if(-1===e)return-1;const n=[];for(let t=0;t<e.inputs.length;t++){const r=e.inputs[t];if(i(r)){n.push(r);continue}const u=solve(r);if(-1===u)return-1;n.push(u)}return e.operation(n)}const p={cm:"px",in:"px",mm:"px",pc:"px",pt:"px",px:"px",q:"px",deg:"deg",grad:"deg",rad:"deg",turn:"deg",ms:"s",s:"s",hz:"hz",khz:"hz"},N=new Map([["cm",e=>e],["mm",e=>10*e],["q",e=>40*e],["in",e=>e/2.54],["pc",e=>e/2.54*6],["pt",e=>e/2.54*72],["px",e=>e/2.54*96]]),g=new Map([["deg",e=>e],["grad",e=>e/.9],["rad",e=>e/180*Math.PI],["turn",e=>e/360]]),b=new Map([["deg",e=>.9*e],["grad",e=>e],["rad",e=>.9*e/180*Math.PI],["turn",e=>.9*e/360]]),d=new Map([["hz",e=>e],["khz",e=>e/1e3]]),w=new Map([["cm",e=>2.54*e],["mm",e=>25.4*e],["q",e=>25.4*e*4],["in",e=>e],["pc",e=>6*e],["pt",e=>72*e],["px",e=>96*e]]),h=new Map([["hz",e=>1e3*e],["khz",e=>e]]),C=new Map([["cm",e=>e/10],["mm",e=>e],["q",e=>4*e],["in",e=>e/25.4],["pc",e=>e/25.4*6],["pt",e=>e/25.4*72],["px",e=>e/25.4*96]]),I=new Map([["ms",e=>e],["s",e=>e/1e3]]),S=new Map([["cm",e=>e/6*2.54],["mm",e=>e/6*25.4],["q",e=>e/6*25.4*4],["in",e=>e/6],["pc",e=>e],["pt",e=>e/6*72],["px",e=>e/6*96]]),y=new Map([["cm",e=>e/72*2.54],["mm",e=>e/72*25.4],["q",e=>e/72*25.4*4],["in",e=>e/72],["pc",e=>e/72*6],["pt",e=>e],["px",e=>e/72*96]]),M=new Map([["cm",e=>e/96*2.54],["mm",e=>e/96*25.4],["q",e=>e/96*25.4*4],["in",e=>e/96],["pc",e=>e/96*6],["pt",e=>e/96*72],["px",e=>e]]),P=new Map([["cm",e=>e/4/10],["mm",e=>e/4],["q",e=>e],["in",e=>e/4/25.4],["pc",e=>e/4/25.4*6],["pt",e=>e/4/25.4*72],["px",e=>e/4/25.4*96]]),D=new Map([["deg",e=>180*e/Math.PI],["grad",e=>180*e/Math.PI/.9],["rad",e=>e],["turn",e=>180*e/Math.PI/360]]),T=new Map([["ms",e=>1e3*e],["s",e=>e]]),k=new Map([["deg",e=>360*e],["grad",e=>360*e/.9],["rad",e=>360*e/180*Math.PI],["turn",e=>e]]),F=new Map([["cm",N],["mm",C],["q",P],["in",w],["pc",S],["pt",y],["px",M],["ms",I],["s",T],["deg",g],["grad",b],["rad",D],["turn",k],["hz",d],["khz",h]]);function convertUnit(t,r){if(t[0]!==e.Dimension)return r;if(r[0]!==e.Dimension)return r;const u=t[4].unit.toLowerCase(),i=r[4].unit.toLowerCase();if(u===i)return r;const a=F.get(i);if(!a)return r;const o=a.get(u);if(!o)return r;const l=o(r[4].value);return[e.Dimension,l.toString()+t[4].unit,r[2],r[3],{value:l,unit:t[4].unit,type:Number.isInteger(l)?n.Integer:n.Number}]}function toCanonicalUnit(t){if(t[0]!==e.Dimension)return t;const r=t[4].unit.toLowerCase(),u=p[r];if(r===u)return t;const i=F.get(r);if(!i)return t;const a=i.get(u);if(!a)return t;const o=a(t[4].value);return[e.Dimension,o.toString()+u,t[2],t[3],{value:o,unit:u,type:Number.isInteger(o)?n.Integer:n.Number}]}function addition(t){if(2!==t.length)return-1;const r=t[0].value;let u=t[1].value;if(r[0]===e.Number&&u[0]===e.Number){const t=r[4].value+u[4].value;return new a([e.Number,t.toString(),r[2],u[3],{value:t,type:r[4].type===n.Integer&&u[4].type===n.Integer?n.Integer:n.Number}])}if(r[0]===e.Percentage&&u[0]===e.Percentage){const n=r[4].value+u[4].value;return new a([e.Percentage,n.toString()+"%",r[2],u[3],{value:n}])}if(r[0]===e.Dimension&&u[0]===e.Dimension&&(u=convertUnit(r,u),r[4].unit.toLowerCase()===u[4].unit.toLowerCase())){const t=r[4].value+u[4].value;return new a([e.Dimension,t.toString()+r[4].unit,r[2],u[3],{value:t,type:r[4].type===n.Integer&&u[4].type===n.Integer?n.Integer:n.Number,unit:r[4].unit}])}return-1}function division(t){if(2!==t.length)return-1;const r=t[0].value,u=t[1].value;if(r[0]===e.Number&&u[0]===e.Number){const t=r[4].value/u[4].value;return new a([e.Number,t.toString(),r[2],u[3],{value:t,type:Number.isInteger(t)?n.Integer:n.Number}])}if(r[0]===e.Percentage&&u[0]===e.Number){const n=r[4].value/u[4].value;return new a([e.Percentage,n.toString()+"%",r[2],u[3],{value:n}])}if(r[0]===e.Dimension&&u[0]===e.Number){const t=r[4].value/u[4].value;return new a([e.Dimension,t.toString()+r[4].unit,r[2],u[3],{value:t,type:Number.isInteger(t)?n.Integer:n.Number,unit:r[4].unit}])}return-1}function multiplication(t){if(2!==t.length)return-1;const r=t[0].value,u=t[1].value;if(r[0]===e.Number&&u[0]===e.Number){const t=r[4].value*u[4].value;return new a([e.Number,t.toString(),r[2],u[3],{value:t,type:r[4].type===n.Integer&&u[4].type===n.Integer?n.Integer:n.Number}])}if(r[0]===e.Percentage&&u[0]===e.Number){const n=r[4].value*u[4].value;return new a([e.Percentage,n.toString()+"%",r[2],u[3],{value:n}])}if(r[0]===e.Number&&u[0]===e.Percentage){const n=r[4].value*u[4].value;return new a([e.Percentage,n.toString()+"%",r[2],u[3],{value:n}])}if(r[0]===e.Dimension&&u[0]===e.Number){const t=r[4].value*u[4].value;return new a([e.Dimension,t.toString()+r[4].unit,r[2],u[3],{value:t,type:r[4].type===n.Integer&&u[4].type===n.Integer?n.Integer:n.Number,unit:r[4].unit}])}if(r[0]===e.Number&&u[0]===e.Dimension){const t=r[4].value*u[4].value;return new a([e.Dimension,t.toString()+u[4].unit,r[2],u[3],{value:t,type:r[4].type===n.Integer&&u[4].type===n.Integer?n.Integer:n.Number,unit:u[4].unit}])}return-1}function resolveGlobalsAndConstants(t,r){for(let u=0;u<t.length;u++){const o=t[u];if(!i(o))continue;const l=o.value;if(l[0]!==e.Ident)continue;const c=l[4].value.toLowerCase();switch(c){case"e":t.splice(u,1,new a([e.Number,Math.E.toString(),l[2],l[3],{value:Math.E,type:n.Number}]));break;case"pi":t.splice(u,1,new a([e.Number,Math.PI.toString(),l[2],l[3],{value:Math.PI,type:n.Number}]));break;case"infinity":t.splice(u,1,new a([e.Number,"infinity",l[2],l[3],{value:1/0,type:n.Number}]));break;case"-infinity":t.splice(u,1,new a([e.Number,"-infinity",l[2],l[3],{value:-1/0,type:n.Number}]));break;case"nan":t.splice(u,1,new a([e.Number,"NaN",l[2],l[3],{value:Number.NaN,type:n.Number}]));break;default:if(r.has(c)){const e=r.get(c);t.splice(u,1,new a(e))}}}return t}function isNumeric(n){return n[0]===e.Dimension||(n[0]===e.Percentage||n[0]===e.Number)}function isDimensionOrNumber(n){return n[0]===e.Dimension||n[0]===e.Number}function arrayOfSameNumeric(n){if(0===n.length)return!0;const t=n[0];if(!isNumeric(t))return!1;if(1===n.length)return!0;if(t[0]===e.Dimension){const e=t[4].unit.toLowerCase();for(let r=1;r<n.length;r++){const u=n[r];if(t[0]!==u[0])return!1;if(e!==u[4].unit.toLowerCase())return!1}return!0}for(let e=1;e<n.length;e++){const r=n[e];if(t[0]!==r[0])return!1}return!0}function twoOfSameNumeric(n,t){return!!isNumeric(n)&&(n[0]===e.Dimension?n[0]===t[0]&&n[4].unit.toLowerCase()===t[4].unit.toLowerCase():n[0]===t[0])}function unary(e){if(1!==e.length)return-1;return isNumeric(e[0].value)?e[0]:-1}function resultToCalculation(n,t,r){return t[0]===e.Dimension?dimensionToCalculation(n,t[4].unit,r):t[0]===e.Percentage?percentageToCalculation(n,r):t[0]===e.Number?numberToCalculation(n,r):-1}function dimensionToCalculation(t,r,u){const i=t.tokens();return{inputs:[new a([e.Dimension,u.toString()+r,i[0][2],i[i.length-1][3],{value:u,type:Number.isInteger(u)?n.Integer:n.Number,unit:r}])],operation:unary}}function percentageToCalculation(n,t){const r=n.tokens();return{inputs:[new a([e.Percentage,t.toString()+"%",r[0][2],r[r.length-1][3],{value:t}])],operation:unary}}function numberToCalculation(t,r){const u=t.tokens();return{inputs:[new a([e.Number,r.toString(),u[0][2],u[u.length-1][3],{value:r,type:Number.isInteger(r)?n.Integer:n.Number}])],operation:unary}}function solveACos(n,t){const r=t.value;if(r[0]!==e.Number)return-1;return dimensionToCalculation(n,"rad",Math.acos(r[4].value))}function solveASin(n,t){const r=t.value;if(r[0]!==e.Number)return-1;return dimensionToCalculation(n,"rad",Math.asin(r[4].value))}function solveATan(n,t){const r=t.value;if(r[0]!==e.Number)return-1;return dimensionToCalculation(n,"rad",Math.atan(r[4].value))}function solveATan2(e,n,t){const r=n.value;if(!isDimensionOrNumber(r))return-1;const u=convertUnit(r,t.value);if(!twoOfSameNumeric(r,u))return-1;return dimensionToCalculation(e,"rad",Math.atan2(r[4].value,u[4].value))}function solveAbs(e,n){const t=n.value;if(!isDimensionOrNumber(t))return-1;return resultToCalculation(e,t,Math.abs(t[4].value))}function solveClamp(e,n,t,r){if(!i(n)||!i(t)||!i(r))return-1;const u=n.value;if(!isNumeric(u))return-1;const a=convertUnit(u,t.value);if(!twoOfSameNumeric(u,a))return-1;const o=convertUnit(u,r.value);if(!twoOfSameNumeric(u,o))return-1;return resultToCalculation(e,u,Math.max(u[4].value,Math.min(a[4].value,o[4].value)))}function solveCos(n,t){const r=t.value;if(!isDimensionOrNumber(r))return-1;if(r[0]===e.Dimension)switch(r[4].unit.toLowerCase()){case"rad":break;case"deg":r[4].value=g.get("rad")(r[4].value);break;case"grad":r[4].value=b.get("rad")(r[4].value);break;case"turn":r[4].value=k.get("rad")(r[4].value);break;default:return-1}return numberToCalculation(n,Math.cos(r[4].value))}function solveExp(n,t){const r=t.value;if(r[0]!==e.Number)return-1;return numberToCalculation(n,Math.exp(r[4].value))}function solveHypot(e,n){const t=n[0];if(!t||!i(t))return-1;if(1!==new Set(n.map((e=>e.type))).size)return-1;const r=t.value;if(!isNumeric(r))return-1;const u=n.map((e=>convertUnit(r,e.value)));if(!arrayOfSameNumeric(u))return-1;const a=u.map((e=>e[4].value)),o=Math.hypot(...a);return resultToCalculation(e,r,o)}function solveMax(e,n){const t=n[0];if(!t||!i(t))return-1;if(1!==new Set(n.map((e=>e.type))).size)return-1;const r=t.value;if(!isNumeric(r))return-1;const u=n.map((e=>convertUnit(r,e.value)));if(!arrayOfSameNumeric(u))return-1;const a=u.map((e=>e[4].value)),o=Math.max(...a);return resultToCalculation(e,r,o)}function solveMin(e,n){const t=n[0];if(!t||!i(t))return-1;if(1!==new Set(n.map((e=>e.type))).size)return-1;const r=t.value;if(!isNumeric(r))return-1;const u=n.map((e=>convertUnit(r,e.value)));if(!arrayOfSameNumeric(u))return-1;const a=u.map((e=>e[4].value)),o=Math.min(...a);return resultToCalculation(e,r,o)}function solveMod(e,n,t){const r=n.value;if(!isNumeric(r))return-1;const u=convertUnit(r,t.value);if(!twoOfSameNumeric(r,u))return-1;let i;return i=0===u[4].value?Number.NaN:Number.isFinite(r[4].value)&&(Number.isFinite(u[4].value)||(u[4].value!==Number.POSITIVE_INFINITY||r[4].value!==Number.NEGATIVE_INFINITY&&!Object.is(0*r[4].value,-0))&&(u[4].value!==Number.NEGATIVE_INFINITY||r[4].value!==Number.POSITIVE_INFINITY&&!Object.is(0*r[4].value,0)))?Number.isFinite(u[4].value)?(r[4].value%u[4].value+u[4].value)%u[4].value:r[4].value:Number.NaN,resultToCalculation(e,r,i)}function solvePow(n,t,r){const u=t.value,i=r.value;if(u[0]!==e.Number)return-1;if(!twoOfSameNumeric(u,i))return-1;return numberToCalculation(n,Math.pow(u[4].value,i[4].value))}function solveRem(e,n,t){const r=n.value;if(!isNumeric(r))return-1;const u=convertUnit(r,t.value);if(!twoOfSameNumeric(r,u))return-1;let i;return i=0===u[4].value?Number.NaN:Number.isFinite(r[4].value)?Number.isFinite(u[4].value)?r[4].value%u[4].value:r[4].value:Number.NaN,resultToCalculation(e,r,i)}function solveRound(e,n,t,r){const u=t.value;if(!isNumeric(u))return-1;const i=convertUnit(u,r.value);if(!twoOfSameNumeric(u,i))return-1;let a;if(0===i[4].value)a=Number.NaN;else if(Number.isFinite(u[4].value)||Number.isFinite(i[4].value))if(!Number.isFinite(u[4].value)&&Number.isFinite(i[4].value))a=u[4].value;else if(Number.isFinite(u[4].value)&&!Number.isFinite(i[4].value))switch(n){case"down":a=u[4].value<0?-1/0:Object.is(-0,0*u[4].value)?-0:0;break;case"up":a=u[4].value>0?1/0:Object.is(0,0*u[4].value)?0:-0;break;default:a=Object.is(0,0*u[4].value)?0:-0}else if(Number.isFinite(i[4].value))switch(n){case"down":a=Math.floor(u[4].value/i[4].value)*i[4].value;break;case"up":a=Math.ceil(u[4].value/i[4].value)*i[4].value;break;case"to-zero":a=Math.trunc(u[4].value/i[4].value)*i[4].value;break;default:{let e=Math.floor(u[4].value/i[4].value)*i[4].value,n=Math.ceil(u[4].value/i[4].value)*i[4].value;if(e>n){const t=e;e=n,n=t}const t=Math.abs(u[4].value-e),r=Math.abs(u[4].value-n);a=t===r?n:t<r?e:n;break}}else a=u[4].value;else a=Number.NaN;return resultToCalculation(e,u,a)}function solveSign(e,n){const t=n.value;if(!isDimensionOrNumber(t))return-1;return numberToCalculation(e,Math.sign(t[4].value))}function solveSin(n,t){const r=t.value;if(!isDimensionOrNumber(r))return-1;if(r[0]===e.Dimension)switch(r[4].unit.toLowerCase()){case"rad":break;case"deg":r[4].value=g.get("rad")(r[4].value);break;case"grad":r[4].value=b.get("rad")(r[4].value);break;case"turn":r[4].value=k.get("rad")(r[4].value);break;default:return-1}return numberToCalculation(n,Math.sin(r[4].value))}function solveSqrt(n,t){const r=t.value;if(r[0]!==e.Number)return-1;return numberToCalculation(n,Math.sqrt(r[4].value))}function solveTan(n,t){const r=t.value;if(!isDimensionOrNumber(r))return-1;const u=r[4].value;let i=0;if(r[0]===e.Dimension)switch(r[4].unit.toLowerCase()){case"rad":i=D.get("deg")(u);break;case"deg":i=u,r[4].value=g.get("rad")(u);break;case"grad":i=b.get("deg")(u),r[4].value=b.get("rad")(u);break;case"turn":i=k.get("deg")(u),r[4].value=k.get("rad")(u);break;default:return-1}const a=i/90;let o;return o=i%90==0&&a%2!=0?a>0?1/0:-1/0:Math.tan(r[4].value),numberToCalculation(n,o)}function subtraction(t){if(2!==t.length)return-1;const r=t[0].value;let u=t[1].value;if(r[0]===e.Number&&u[0]===e.Number){const t=r[4].value-u[4].value;return new a([e.Number,t.toString(),r[2],u[3],{value:t,type:r[4].type===n.Integer&&u[4].type===n.Integer?n.Integer:n.Number}])}if(r[0]===e.Percentage&&u[0]===e.Percentage){const n=r[4].value-u[4].value;return new a([e.Percentage,n.toString()+"%",r[2],u[3],{value:n}])}if(r[0]===e.Dimension&&u[0]===e.Dimension&&(u=convertUnit(r,u),r[4].unit.toLowerCase()===u[4].unit.toLowerCase())){const t=r[4].value-u[4].value;return new a([e.Dimension,t.toString()+r[4].unit,r[2],u[3],{value:t,type:r[4].type===n.Integer&&u[4].type===n.Integer?n.Integer:n.Number,unit:r[4].unit}])}return-1}function solveLog(n,t){if(1===t.length){const r=t[0];if(!r||!i(r))return-1;const u=r.value;if(u[0]!==e.Number)return-1;return numberToCalculation(n,Math.log(u[4].value))}if(2===t.length){const r=t[0];if(!r||!i(r))return-1;const u=r.value;if(u[0]!==e.Number)return-1;const a=t[1];if(!a||!i(a))return-1;const o=a.value;if(o[0]!==e.Number)return-1;return numberToCalculation(n,Math.log(u[4].value)/Math.log(o[4].value))}return-1}const x=new Map([["abs",function abs(e,n){return singleNodeSolver(e,n,solveAbs)}],["acos",function acos(e,n){return singleNodeSolver(e,n,solveACos)}],["asin",function asin(e,n){return singleNodeSolver(e,n,solveASin)}],["atan",function atan(e,n){return singleNodeSolver(e,n,solveATan)}],["atan2",function atan2(e,n){return twoCommaSeparatedNodesSolver(e,n,solveATan2)}],["calc",calc$1],["clamp",function clamp(n,t){const r=resolveGlobalsAndConstants([...n.value.filter((e=>!o(e)&&!l(e)))],t),u=[],a=[],c=[];{let n=u;for(let t=0;t<r.length;t++){const o=r[t];if(i(o)&&o.value[0]===e.Comma){if(n===c)return-1;if(n===a){n=c;continue}if(n===u){n=a;continue}return-1}n.push(o)}}const s=solve(calc$1(new v([e.Function,"calc(",-1,-1,{value:"calc"}],[e.CloseParen,")",-1,-1,void 0],u),t));if(-1===s)return-1;const m=solve(calc$1(new v([e.Function,"calc(",-1,-1,{value:"calc"}],[e.CloseParen,")",-1,-1,void 0],a),t));if(-1===m)return-1;const f=solve(calc$1(new v([e.Function,"calc(",-1,-1,{value:"calc"}],[e.CloseParen,")",-1,-1,void 0],c),t));if(-1===f)return-1;return solveClamp(n,s,m,f)}],["cos",function cos(e,n){return singleNodeSolver(e,n,solveCos)}],["exp",function exp(e,n){return singleNodeSolver(e,n,solveExp)}],["hypot",function hypot(e,n){return variadicNodesSolver(e,n,solveHypot)}],["log",function log(e,n){return variadicNodesSolver(e,n,solveLog)}],["max",function max(e,n){return variadicNodesSolver(e,n,solveMax)}],["min",function min(e,n){return variadicNodesSolver(e,n,solveMin)}],["mod",function mod(e,n){return twoCommaSeparatedNodesSolver(e,n,solveMod)}],["pow",function pow(e,n){return twoCommaSeparatedNodesSolver(e,n,solvePow)}],["rem",function rem(e,n){return twoCommaSeparatedNodesSolver(e,n,solveRem)}],["round",function round(n,t){const r=resolveGlobalsAndConstants([...n.value.filter((e=>!o(e)&&!l(e)))],t);let u="";const a=[],c=[];{let n=a;for(let t=0;t<r.length;t++){const o=r[t];if(!u&&0===a.length&&0===c.length&&i(o)&&o.value[0]===e.Ident){const e=o.value;if(O.has(e[4].value.toLowerCase())){u=e[4].value.toLowerCase();continue}}if(i(o)&&o.value[0]===e.Comma){if(n===c)return-1;if(n===a&&u&&0===a.length)continue;if(n===a){n=c;continue}return-1}n.push(o)}}const s=solve(calc$1(new v([e.Function,"calc(",-1,-1,{value:"calc"}],[e.CloseParen,")",-1,-1,void 0],a),t));if(-1===s)return-1;const m=solve(calc$1(new v([e.Function,"calc(",-1,-1,{value:"calc"}],[e.CloseParen,")",-1,-1,void 0],c),t));if(-1===m)return-1;u||(u="nearest");return solveRound(n,u,s,m)}],["sign",function sign(e,n){return singleNodeSolver(e,n,solveSign)}],["sin",function sin(e,n){return singleNodeSolver(e,n,solveSin)}],["sqrt",function sqrt(e,n){return singleNodeSolver(e,n,solveSqrt)}],["tan",function tan(e,n){return singleNodeSolver(e,n,solveTan)}]]);function calc$1(n,t){const r=resolveGlobalsAndConstants([...n.value.filter((e=>!o(e)&&!l(e)))],t);if(1===r.length&&i(r[0]))return{inputs:[r[0]],operation:unary};let u=0;for(;u<r.length;){const n=r[u];if(c(n)&&n.startToken[0]===e.OpenParen){const e=calc$1(n,t);if(-1===e)return-1;r.splice(u,1,e)}else if(s(n)){const e=x.get(n.getName().toLowerCase());if(!e)return-1;{const i=e(n,t);if(-1===i)return-1;r.splice(u,1,i)}}else u++}if(u=0,1===r.length&&isCalculation(r[0]))return r[0];for(;u<r.length;){const n=r[u];if(!n||!i(n)&&!isCalculation(n)){u++;continue}const t=r[u+1];if(!t||!i(t)){u++;continue}const a=t.value;if(a[0]!==e.Delim||"*"!==a[4].value&&"/"!==a[4].value){u++;continue}const o=r[u+2];if(!o||!i(o)&&!isCalculation(o))return-1;"*"!==a[4].value?"/"!==a[4].value?u++:r.splice(u,3,{inputs:[n,o],operation:division}):r.splice(u,3,{inputs:[n,o],operation:multiplication})}if(u=0,1===r.length&&isCalculation(r[0]))return r[0];for(;u<r.length;){const n=r[u];if(!n||!i(n)&&!isCalculation(n)){u++;continue}const t=r[u+1];if(!t||!i(t)){u++;continue}const a=t.value;if(a[0]!==e.Delim||"+"!==a[4].value&&"-"!==a[4].value){u++;continue}const o=r[u+2];if(!o||!i(o)&&!isCalculation(o))return-1;"+"!==a[4].value?"-"!==a[4].value?u++:r.splice(u,3,{inputs:[n,o],operation:subtraction}):r.splice(u,3,{inputs:[n,o],operation:addition})}return 1===r.length&&isCalculation(r[0])?r[0]:-1}function singleNodeSolver(n,t,r){const u=resolveGlobalsAndConstants([...n.value.filter((e=>!o(e)&&!l(e)))],t),i=solve(calc$1(new v([e.Function,"calc(",-1,-1,{value:"calc"}],[e.CloseParen,")",-1,-1,void 0],u),t));return-1===i?-1:r(n,i)}function twoCommaSeparatedNodesSolver(n,t,r){const u=resolveGlobalsAndConstants([...n.value.filter((e=>!o(e)&&!l(e)))],t),a=[],c=[];{let n=a;for(let t=0;t<u.length;t++){const r=u[t];if(i(r)&&r.value[0]===e.Comma){if(n===c)return-1;if(n===a){n=c;continue}return-1}n.push(r)}}const s=solve(calc$1(new v([e.Function,"calc(",-1,-1,{value:"calc"}],[e.CloseParen,")",-1,-1,void 0],a),t));if(-1===s)return-1;const m=solve(calc$1(new v([e.Function,"calc(",-1,-1,{value:"calc"}],[e.CloseParen,")",-1,-1,void 0],c),t));return-1===m?-1:r(n,s,m)}function variadicNodesSolver(n,t,r){const u=resolveGlobalsAndConstants([...n.value.filter((e=>!o(e)&&!l(e)))],t),a=[];{const n=[];let r=[];for(let t=0;t<u.length;t++){const a=u[t];i(a)&&a.value[0]===e.Comma?(n.push(r),r=[]):r.push(a)}n.push(r);for(let r=0;r<n.length;r++){if(0===n[r].length)return-1;const u=solve(calc$1(new v([e.Function,"calc(",-1,-1,{value:"calc"}],[e.CloseParen,")",-1,-1,void 0],n[r]),t));if(-1===u)return-1;a.push(u)}}return r(n,a)}const O=new Set(["nearest","up","down","to-zero"]);function tokenizeGlobals(n){const u=new Map;if(!n)return u;for(const[i,a]of n)if(t(a))u.set(i,a);else if("string"!=typeof a);else{const n=r({css:a}),t=n.nextToken();if(n.nextToken(),!n.endOfFile())continue;if(!t)continue;if(t[0]!==e.Number&&t[0]!==e.Dimension&&t[0]!==e.Percentage)continue;u.set(i,t)}return u}function patchNaN(t){if(-1===t)return-1;if(s(t))return t;const r=t.value;return r[0]!==e.Number&&r[0]!==e.Percentage&&r[0]!==e.Dimension?t:Number.isNaN(r[4].value)?r[0]===e.Number?new v([e.Function,"calc(",r[2],r[3],{value:"calc"}],[e.CloseParen,")",r[2],r[3],void 0],[new a([e.Ident,"NaN",r[2],r[3],{value:"NaN"}])]):r[0]===e.Dimension?new v([e.Function,"calc(",r[2],r[3],{value:"calc"}],[e.CloseParen,")",r[2],r[3],void 0],[new a([e.Ident,"NaN",r[2],r[3],{value:"NaN"}]),new m([[e.Whitespace," ",r[2],r[3],void 0]]),new a([e.Delim,"*",r[2],r[3],{value:"*"}]),new m([[e.Whitespace," ",r[2],r[3],void 0]]),new a([e.Dimension,"1"+r[4].unit,r[2],r[3],{value:1,type:n.Integer,unit:r[4].unit}])]):r[0]===e.Percentage?new v([e.Function,"calc(",r[2],r[3],{value:"calc"}],[e.CloseParen,")",r[2],r[3],void 0],[new a([e.Ident,"NaN",r[2],r[3],{value:"NaN"}]),new m([[e.Whitespace," ",r[2],r[3],void 0]]),new a([e.Delim,"*",r[2],r[3],{value:"*"}]),new m([[e.Whitespace," ",r[2],r[3],void 0]]),new a([e.Percentage,"1%",r[2],r[3],{value:1}])]):-1:t}function patchInfinity(t){if(-1===t)return-1;if(s(t))return t;const r=t.value;if(r[0]!==e.Number&&r[0]!==e.Percentage&&r[0]!==e.Dimension)return t;if(Number.isFinite(r[4].value))return t;let u="";return Number.NEGATIVE_INFINITY===r[4].value&&(u="-"),r[0]===e.Number?new v([e.Function,"calc(",r[2],r[3],{value:"calc"}],[e.CloseParen,")",r[2],r[3],void 0],[new a([e.Ident,u+"infinity",r[2],r[3],{value:u+"infinity"}])]):r[0]===e.Dimension?new v([e.Function,"calc(",r[2],r[3],{value:"calc"}],[e.CloseParen,")",r[2],r[3],void 0],[new a([e.Ident,u+"infinity",r[2],r[3],{value:u+"infinity"}]),new m([[e.Whitespace," ",r[2],r[3],void 0]]),new a([e.Delim,"*",r[2],r[3],{value:"*"}]),new m([[e.Whitespace," ",r[2],r[3],void 0]]),new a([e.Dimension,"1"+r[4].unit,r[2],r[3],{value:1,type:n.Integer,unit:r[4].unit}])]):r[0]===e.Percentage?new v([e.Function,"calc(",r[2],r[3],{value:"calc"}],[e.CloseParen,")",r[2],r[3],void 0],[new a([e.Ident,u+"infinity",r[2],r[3],{value:u+"infinity"}]),new m([[e.Whitespace," ",r[2],r[3],void 0]]),new a([e.Delim,"*",r[2],r[3],{value:"*"}]),new m([[e.Whitespace," ",r[2],r[3],void 0]]),new a([e.Percentage,"1%",r[2],r[3],{value:1}])]):-1}function patchMinusZero(n){if(-1===n)return-1;if(s(n))return n;const t=n.value;return t[0]!==e.Number&&t[0]!==e.Percentage&&t[0]!==e.Dimension?n:Object.is(-0,t[4].value)?("-0"===t[1]||(t[1]="-0"),n):n}function patchPrecision(n,t=13){if(-1===n)return-1;if(s(n))return n;const r=n.value;if(r[0]!==e.Number&&r[0]!==e.Percentage&&r[0]!==e.Dimension)return n;if(Number.isInteger(r[4].value))return n;const u=Number(r[4].value.toFixed(t)).toString();return r[0]===e.Number?r[1]=u:r[0]===e.Percentage?r[1]=u+"%":r[0]===e.Dimension&&(r[1]=u+r[4].unit),n}function patchCanonicalUnit(n){return-1===n?-1:(s(n)||n.value[0]!==e.Dimension||(n.value=toCanonicalUnit(n.value)),n)}function patchCalcResult(e,n){let t=e;return t=patchNaN(e),t=patchInfinity(t),null!=n&&n.toCanonicalUnits&&(t=patchCanonicalUnit(t)),t=patchPrecision(t,null==n?void 0:n.precision),t=patchMinusZero(t),t}function calc(e,n){const t=r({css:e}),i=[];for(;!t.endOfFile();)i.push(t.nextToken());i.push(t.nextToken());return calcFromComponentValues(f(i,{}),n).map((e=>e.map((e=>u(...e.tokens()))).join(""))).join(",")}function calcFromComponentValues(e,n){const t=tokenizeGlobals(null==n?void 0:n.globals);for(let r=0;r<e.length;r++){const u=e[r];for(let e=0;e<u.length;e++){const r=u[e];if(s(r)){const i=x.get(r.getName().toLowerCase());if(i){const a=patchCalcResult(solve(i(r,t)),n);if(-1!==a){u.splice(e,1,a);continue}}}(c(r)||s(r))&&r.walk(((e,r)=>{if("number"!=typeof r)return;const u=e.node;if(s(u)){const i=x.get(u.getName().toLowerCase());if(!i)return;const a=patchCalcResult(solve(i(u,t)),n);if(-1!==a)return void e.parent.value.splice(r,1,a)}}))}}return e}export{calc,calcFromComponentValues};
