"use strict";var t,e=require("postcss"),n=require("path"),s=require("fs");function parseArguments(e,n,s){const i=e.map((t=>t.trim())).filter((t=>!!t)),o={stdin:!1,stdout:!1,output:void 0,outputDir:void 0,inputs:[],inlineMap:!0,externalMap:!1,replace:!1,pluginOptions:{},debug:!1};let r,a=!1;for(let e=0;e<i.length;e++){const n=i[e];switch(n){case"-o":case"--output":o.output=i[e+1],e++,a=!0;break;case"-m":case"--map":o.externalMap=!0,o.inlineMap=!1,a=!0;break;case"--no-map":o.externalMap=!1,o.inlineMap=!1,a=!0;break;case"-r":case"--replace":o.replace=!0,a=!0;break;case"--debug":o.debug=!0,a=!0;break;case"-d":case"--dir":o.outputDir=i[e+1],e++,a=!0;break;case"-p":case"--plugin-options":r=i[e+1],e++,a=!0;break;default:if(0===n.indexOf("-"))return console.warn(`[error] unknown argument : ${n}\n`),s(),t.InvalidArguments;if(!a){o.inputs.push(n);break}return s(),t.InvalidArguments}}if(o.replace&&(o.output=void 0,o.outputDir=void 0),o.outputDir&&(o.output=void 0),o.inputs.length>1&&o.output)return console.warn('[error] omit "--output" when processing multiple inputs\n'),s(),t.InvalidArguments;0===o.inputs.length&&(o.stdin=!0),o.output||o.outputDir||o.replace||(o.stdout=!0),o.stdout&&(o.externalMap=!1);let p={};if(r)try{p=JSON.parse(r)}catch{return console.warn("[error] plugin options must be valid JSON\n"),s(),t.InvalidArguments}for(const e in p){const i=p[e];if(!n.includes(e))return console.warn(`[error] unknown plugin option: ${e}\n`),s(),t.InvalidArguments;o.pluginOptions[e]=i}return o}async function getStdin(){return new Promise((t=>{let e="",n=!1;if(setTimeout((()=>{n=!0,t("")}),1e4),process.stdin.isTTY){if(n)return;t(e)}else process.stdin.setEncoding("utf8"),process.stdin.on("readable",(()=>{let t="";for(;t=process.stdin.read();)e+=t??""})),process.stdin.on("end",(()=>{n||t(e)}))}))}async function stdinToStdout(t,n,s){let i="";try{const o=await getStdin();o||(s(),process.exit(1));const r=await e([t]).process(o,{from:"stdin",to:"stdout",map:!!n.inlineMap&&{inline:!0}});r.warnings().forEach((t=>{console.warn(t.toString())})),i=r.css}catch(t){t instanceof Error?console.error(n.debug?t:t.message):console.error(t),process.exit(1)}process.stdout.write(i+(n.inlineMap?"\n":"")),process.exit(0)}async function stdinToFs(t,i,o){let r=i.output;!r&&i.outputDir&&(r=n.join(i.outputDir,"output.css")),r||process.exit(0);try{const n=await getStdin();n||(o(),process.exit(1));const a=await e([t]).process(n,{from:"stdin",to:r,map:!(!i.inlineMap&&!i.externalMap)&&{inline:i.inlineMap}});a.warnings().forEach((t=>{console.warn(t.toString())})),i.externalMap&&a.map?await Promise.all([await s.promises.writeFile(r,a.css+(i.inlineMap?"\n":"")),await s.promises.writeFile(`${r}.map`,a.map.toString())]):await s.promises.writeFile(r,a.css+(i.inlineMap?"\n":""))}catch(t){t instanceof Error?console.error(i.debug?t:t.message):console.error(t),process.exit(1)}console.log(`CSS was written to "${n.normalize(r)}"`),process.exit(0)}async function fsToStdout(t,n){let i=[];try{i=await Promise.all(n.inputs.map((async n=>{const i=await s.promises.readFile(n),o=await e([t]).process(i,{from:n,to:"stdout",map:!1});return o.warnings().forEach((t=>{console.warn(t.toString())})),o.css})))}catch(t){t instanceof Error?console.error(n.debug?t:t.message):console.error(t),process.exit(1)}for(const t of i)process.stdout.write(t);process.exit(0)}async function fsToFs(t,i){try{await Promise.all(i.inputs.map((async o=>{let r=i.output;i.outputDir&&(r=n.join(i.outputDir,n.basename(o))),i.replace&&(r=o),r||process.exit(0);const a=await s.promises.readFile(o),p=await e([t]).process(a,{from:o,to:r,map:!(!i.inlineMap&&!i.externalMap)&&{inline:i.inlineMap}});p.warnings().forEach((t=>{console.warn(t.toString())})),i.externalMap&&p.map?await Promise.all([await s.promises.writeFile(r,p.css+(i.inlineMap?"\n":"")),await s.promises.writeFile(`${r}.map`,p.map.toString())]):await s.promises.writeFile(r,p.css+(i.inlineMap?"\n":"")),console.log(`CSS was written to "${n.normalize(r)}"`)})))}catch(t){t instanceof Error?console.error(i.debug?t:t.message):console.error(t),process.exit(1)}process.exit(0)}!function(t){t.InvalidArguments="INVALID_ARGUMENTS"}(t||(t={})),exports.cli=async function cli(e,n,s,i=!0){const o=parseArguments(process.argv.slice(i?2:3),n,s);o===t.InvalidArguments&&process.exit(1);const r=e(o.pluginOptions);o.stdin&&o.stdout?await stdinToStdout(r,o,s):o.stdin?await stdinToFs(r,o,s):o.stdout?await fsToStdout(r,o):await fsToFs(r,o)},exports.helpTextLogger=function helpTextLogger(t,e,n,s=null){let i=[];if(s){const t=Math.max(...Object.keys(s).map((t=>t.length))),e=new Array(t).fill(" ").join("");e.length&&(i=["\nPlugin Options:",...Object.keys(s).map((t=>`  ${(t+e).slice(0,e.length)}  ${typeof s[t]}`))],i.push(`\n  ${JSON.stringify(s,null,2).split("\n").join("\n  ")}`))}const o=[`${e}\n`,`  ${n}\n`,"Usage:",`  ${t} [input.css] [OPTIONS] [-o|--output output.css]`,`  ${t} <input.css>... [OPTIONS] --dir <output-directory>`,`  ${t} <input.css>... [OPTIONS] --replace`,"\nOptions:","  -o, --output          Output file","  -d, --dir             Output directory","  -r, --replace         Replace (overwrite) the input file","  -m, --map             Create an external sourcemap","  --no-map              Disable the default inline sourcemaps","  -p, --plugin-options  Stringified JSON object with plugin options"];return i.length>0&&o.push(...i),()=>{console.warn(o.join("\n"))}},exports.parseArguments=parseArguments;
