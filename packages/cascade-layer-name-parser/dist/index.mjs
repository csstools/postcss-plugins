import{isTokenIdent as e,TokenType as t,isTokenDelim as n,stringify as r,ParseError as a,isTokenComment as s,isTokenWhitespace as o,tokenizer as l}from"@csstools/css-tokenizer";import{parseCommaSeparatedListOfComponentValues as i,isTokenNode as c,isCommentNode as m,isWhitespaceNode as u}from"@csstools/css-parser-algorithms";class LayerName{parts;constructor(e){this.parts=e}tokens(){return[...this.parts]}slice(t,n){const r=[];for(let t=0;t<this.parts.length;t++)e(this.parts[t])&&r.push(t);const a=r.slice(t,n);return new LayerName(this.parts.slice(a[0],a[a.length-1]+1))}concat(r){const a=[t.Delim,".",-1,-1,{value:"."}];return new LayerName([...this.parts.filter((t=>e(t)||n(t))),a,...r.parts.filter((t=>e(t)||n(t)))])}segments(){return this.parts.filter((t=>e(t))).map((e=>e[4].value))}name(){return this.parts.filter((t=>e(t)||n(t))).map((e=>e[1])).join("")}equal(e){const t=this.segments(),n=e.segments();if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++){if(t[e]!==n[e])return!1}return!0}toString(){return r(...this.parts)}toJSON(){return{parts:this.parts,segments:this.segments(),name:this.name()}}}function addLayerToModel(e,t){t.forEach((t=>{const n=t.segments();e:for(let r=0;r<n.length;r++){const n=t.slice(0,r+1),a=n.segments();let s=-1,o=0;for(let t=0;t<e.length;t++){const n=e[t].segments();let r=0;t:for(let e=0;e<n.length;e++){const t=n[e],s=a[e];if(s===t&&e+1===a.length)continue e;if(s!==t){if(s!==t)break t}else r++}r>=o&&(s=t,o=r)}-1===s?e.push(n):e.splice(s+1,0,n)}}))}function parseFromTokens(t,r){const l=i(t,{onParseError:r?.onParseError}),p=r?.onParseError??(()=>{}),f=["6.4.2. Layer Naming and Nesting","Layer name syntax","<layer-name> = <ident> [ '.' <ident> ]*"],h=t[0][2],d=t[t.length-1][3],y=[];for(let t=0;t<l.length;t++){const r=l[t];for(let e=0;e<r.length;e++){const t=r[e];if(!c(t)&&!m(t)&&!u(t))return p(new a(`Invalid cascade layer name. Invalid layer name part "${t.toString()}"`,h,d,f)),[]}const i=r.flatMap((e=>e.tokens()));let g=!1,w=!1,v=null;for(let t=0;t<i.length;t++){const r=i[t];if(!(s(r)||o(r)||e(r)||n(r)&&"."===r[4].value))return p(new a(`Invalid cascade layer name. Invalid character "${r[1]}"`,h,d,f)),[];if(!g&&n(r))return p(new a("Invalid cascade layer name. Layer names can not start with a dot.",h,d,f)),[];if(g){if(o(r)){w=!0;continue}if(w&&s(r))continue;if(w)return p(new a("Invalid cascade layer name. Encountered unexpected whitespace between layer name parts.",h,d,f)),[];if(e(v)&&e(r))return p(new a("Invalid cascade layer name. Layer name parts must be separated by dots.",h,d,f)),[];if(n(v)&&n(r))return p(new a("Invalid cascade layer name. Layer name parts must not be empty.",h,d,f)),[]}e(r)&&(g=!0),(e(r)||n(r))&&(v=r)}if(!v)return p(new a("Invalid cascade layer name. Empty layer name.",h,d,f)),[];if(n(v))return p(new a("Invalid cascade layer name. Layer name must not end with a dot.",h,d,f)),[];y.push(new LayerName(i))}return y}function parse(e,t){const n=l({css:e},{onParseError:t?.onParseError}),r=[];for(;!n.endOfFile();)r.push(n.nextToken());return r.push(n.nextToken()),parseFromTokens(r,t)}export{LayerName,addLayerToModel,parse,parseFromTokens};
