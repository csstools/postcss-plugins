"use strict";var e=require("@csstools/css-parser-algorithms"),t=require("@csstools/css-tokenizer"),n=require("path"),r=require("module"),s=require("fs/promises"),o=require("@csstools/postcss-rebase-url");function isWarning(e){return"warning"===e.type}function isCharsetStatement(e){return"charset"===e.type}function isImportStatement(e){return"import"===e.type}const i=/^data:text\/css(?:;(base64|plain))?,/i,a=/^data:text\/css;base64,/i,u=/^data:text\/css;plain,/i;function isValidDataURL(e){return!!e&&i.test(e)}const l=/^charset$/i,p=/^import$/i,c=/^url$/i,d=/^layer$/i,m=/^supports$/i;function parseAtImport(n){const r=e.parseListOfComponentValues(t.tokenize({css:n}));let s="",o="";const i=[],a=[],u=[];e:for(let n=0;n<r.length;n++){const l=r[n];if(e.isWhitespaceNode(l)||e.isCommentNode(l))continue;if(e.isTokenNode(l)&&(l.value[0]===t.TokenType.String||l.value[0]===t.TokenType.URL)){if(s)return!1;s=l.value[4].value,o=l.value[1];continue}if(e.isFunctionNode(l)&&c.test(l.getName())){if(s)return!1;for(let n=0;n<l.value.length;n++){const r=l.value[n];if(!e.isWhitespaceNode(r)&&!e.isCommentNode(r)){if(e.isTokenNode(r)&&r.value[0]===t.TokenType.String){s=r.value[4].value,o=e.stringify([[l]]);continue e}return!1}}}if(!s)return!1;if(e.isTokenNode(l)&&l.value[0]===t.TokenType.Ident&&d.test(l.value[4].value)){if(i.length>0||u.length>0)return!1;i.push("");continue}if(e.isFunctionNode(l)&&d.test(l.getName())){if(i.length>0||u.length>0)return!1;i.push(e.stringify([trim(l.value)]));continue}if(e.isFunctionNode(l)&&m.test(l.getName())){if(u.length>0)return!1;u.push(e.stringify([trim(l.value)]));continue}const p=trim(r.slice(n)).flatMap((e=>e.tokens())),f=e.parseCommaSeparatedListOfComponentValues(p).map((t=>e.stringify([trim(t)])));a.push(...f);break}return s=stripHash(s),!!s&&{uri:s,fullUri:o,layer:i,media:a,supports:u}}function trim(t){let n=0,r=t.length;for(let r=0;r<t.length;r++){const s=t[r];if(!e.isWhitespaceNode(s)&&!e.isCommentNode(s)){n=r;break}}for(let n=t.length-1;n>=0;n--){const s=t[n];if(!e.isWhitespaceNode(s)&&!e.isCommentNode(s)){r=n+1;break}}return t.slice(n,r)}function stripHash(e){if(e.startsWith("#"))return"";try{const t=new URL(e,"http://example.com");return t.hash?e.slice(0,e.length-t.hash.length):e}catch{return e}}function parseStatements(e,t,n,r,s){const o=[];if("document"===t.type)return t.each((t=>{o.push(...parseStatements(e,t,n,r,s))})),o;let i=[];return t.each((t=>{let a;"atrule"===t.type&&(p.test(t.name)?a=parseImport(e,t,n,r,s):l.test(t.name)&&(a=parseCharset(e,t,n,r,s))),a?(i.length&&(o.push({type:"nodes",nodes:i,conditions:[...r],from:s,importingNode:n}),i=[]),o.push(a)):i.push(t)})),i.length&&o.push({type:"nodes",nodes:i,conditions:[...r],from:s,importingNode:n}),o}function parseCharset(e,t,n,r,s){return t.prev()?e.warn("@charset must precede all other statements",{node:t}):{type:"charset",node:t,conditions:[...r],from:s,importingNode:n}}function parseImport(e,t,n,r,s){let o=t.prev(),i=!1;for(;o;){if("comment"!==o.type){if("atrule"===o.type&&p.test(o.name)){i=!0;break}break}o=o.prev()}if(!i)for(;o;){if(!("comment"===o.type||"atrule"===o.type&&l.test(o.name)||"atrule"===o.type&&d.test(o.name)&&!o.nodes))return e.warn("@import must precede all other statements (besides @charset or empty @layer)",{node:t});o=o.prev()}if(t.nodes)return e.warn("It looks like you didn't end your @import statement correctly. Child nodes are attached to it.",{node:t});const a={type:"import",uri:"",fullUri:"",node:t,conditions:[...r],from:s,importingNode:n},u=parseAtImport(t.params);if(!u)return e.warn(`Invalid @import statement in '${t.toString()}'`,{node:t});const{layer:c,media:m,supports:f,uri:h,fullUri:g}=u;return a.uri=h,a.fullUri=g,(m.length>0||c.length>0||f.length>0)&&a.conditions.push({layer:c,media:m,supports:f}),a}function resolveId(e,t,r,s){let o="";if(r.startsWith("node_modules:"))try{o=t.resolve(r.slice(13))}catch(t){throw e.error(`Failed to find '${r}'`)}else o=n.resolve(s,r);return o}function createRequire(e,t){var s;let o;if(null==(s=e.source)||null==(s=s.input)||!s.file)return t.warn("The current PostCSS AST Node is lacking a source file reference. This is most likely a bug in a PostCSS plugin.",{node:e}),[];o=e.source.input.file;const i=n.dirname(o);return[r.createRequire(i),o,i]}async function loadContent(e){return isValidDataURL(e)?(t=e,a.test(t)?Buffer.from(t.slice(21),"base64").toString():u.test(t)?decodeURIComponent(t.slice(20)):decodeURIComponent(t.slice(14))):s.readFile(e,"utf-8");var t}const noopPlugin=()=>({postcssPlugin:"noop-plugin",Once(){}});async function parseStyles(e,t,n,r,s,o){const i=parseStatements(e,t,n,r,s);{let t,n,r;const s=[];for(const a of i)isImportStatement(a)&&isProcessableURL(a.uri)&&(t&&n&&r||([t,n,r]=createRequire(a.node,e),t&&n&&r))&&s.push(resolveImportId(e,a,o,t,n,r));await Promise.all(s)}let a=null;const u=[],l=[];return i.forEach((e=>{isCharsetStatement(e)?a=handleCharset(e,a):isImportStatement(e)?e.children?e.children.forEach((e=>{isImportStatement(e)?u.push(e):isCharsetStatement(e)?a=handleCharset(e,a):l.push(e)})):u.push(e):"nodes"===e.type&&l.push(e)})),a?[a,...u.concat(l)]:u.concat(l)}async function resolveImportId(e,t,n,r,s,o){if(isValidDataURL(t.uri))return void(t.children=await loadImportContent(e,t,t.uri,n));if(isValidDataURL(t.from[t.from.length-1]))return t.children=[],void e.warn(`Unable to import '${t.uri}' from a stylesheet that is embedded in a data url`,{node:t.node});const i=resolveId(t.node,r,t.uri,o);e.messages.push({type:"dependency",plugin:"postcss-bundler",file:i,parent:s});const a=await loadImportContent(e,t,i,n);t.children=a??[]}async function loadImportContent(e,t,n,r){var s,o;const{conditions:i,from:a,node:u}=t;if(a.includes(n))return;let p;try{p=await loadContent(n)}catch{throw u.error(`Failed to find '${t.uri}'`)}const c=await r([noopPlugin()]).process(p,{from:n,parser:(null==(s=e.opts.syntax)?void 0:s.parse)??e.opts.parser??void 0}),d=c.root;return e.messages=e.messages.concat(c.messages),"atrule"===(null==(o=d.first)?void 0:o.type)&&l.test(d.first.name)?d.first.after(r.comment({text:`${t.uri}`,source:u.source})):d.prepend(r.comment({text:`${t.uri}`,source:u.source})),parseStyles(e,d,u,i,[...a,n],r)}function isProcessableURL(e){if(/^(?:[a-z]+:)?\/\//i.test(e))return!1;try{if(new URL(e,"https://example.com").search)return!1}catch{}return!0}function handleCharset(e,t=null){if(!t)return e;var n,r;if(e.node.params.toLowerCase()!==t.node.params.toLowerCase())throw e.node.error(`Incompatible @charset statements:\n  ${e.node.params} specified in ${null==(n=e.node.source)?void 0:n.input.file}\n  ${t.node.params} specified in ${null==(r=t.node.source)?void 0:r.input.file}`);return t}function formatImportPrelude(e,t,n){const r=[];if(e.length){const t=e.join(".");let n="layer";t&&(n=`layer(${t})`),r.push(n)}return 1===n.length?r.push(`supports(${n[0]})`):n.length>0&&r.push(`supports(${n.map((e=>`(${e})`)).join(" and ")})`),t.length&&r.push(t.join(", ")),r.join(" ")}function applyConditions(e,t){e.forEach(((n,r)=>{if(isWarning(n))return;if(!n.conditions.length||isCharsetStatement(n))return;if(isImportStatement(n)){if(1===n.conditions.length)n.node.params=`${n.fullUri} ${formatImportPrelude(n.conditions[0].layer,n.conditions[0].media,n.conditions[0].supports)}`;else{const e=n.conditions.slice().reverse(),t=e.pop();let r=`${n.fullUri} ${formatImportPrelude(t.layer,t.media,t.supports)}`;for(const t of e)r=`'data:text/css;base64,${Buffer.from(`@import ${r}`).toString("base64")}' ${formatImportPrelude(t.layer,t.media,t.supports)}`;n.node.params=r}return}const{nodes:s}=n;if(!s.length)return;const{parent:o}=s[0];if(!o)return;const i=[];for(const e of n.conditions){if(e.media.length>0){var a;const r=t({name:"media",params:e.media.join(", "),source:(null==(a=n.importingNode)?void 0:a.source)??o.source});i.push(r)}if(e.supports.length>0){var u;const r=t({name:"supports",params:1===e.supports.length?`(${e.supports[0]})`:e.supports.map((e=>`(${e})`)).join(" and "),source:(null==(u=n.importingNode)?void 0:u.source)??o.source});i.push(r)}if(e.layer.length>0){var l;const r=t({name:"layer",params:e.layer.join("."),source:(null==(l=n.importingNode)?void 0:l.source)??o.source});i.push(r)}}const p=i[0];if(!p)return;for(let e=0;e<i.length-1;e++)i[e].append(i[e+1]);const c=i[i.length-1];o.insertBefore(s[0],p),s.forEach((e=>{e.parent=void 0})),s[0].raws.before=s[0].raws.before||"\n",c.append(s),e[r]={type:"nodes",nodes:[p],conditions:n.conditions,from:n.from,importingNode:n.importingNode}}))}function applyStyles(e,t){t.nodes=[],e.forEach((e=>{isCharsetStatement(e)||isImportStatement(e)?(e.node.parent=void 0,t.append(e.node)):"nodes"===e.type&&e.nodes.forEach((e=>{e.parent=void 0,t.append(e)}))}))}noopPlugin.postcss=!0;const creator$1=()=>({postcssPlugin:"postcss-bundler",async Once(e,{result:t,atRule:n,postcss:r}){const s=await parseStyles(t,e,null,[],[],r);applyConditions(s,n),applyStyles(s,e)}});creator$1.postcss=!0;const creator=()=>({postcssPlugin:"postcss-bundler",plugins:[creator$1(),o()]});creator.postcss=!0,module.exports=creator;
