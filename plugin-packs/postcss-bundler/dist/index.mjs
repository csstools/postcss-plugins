import{parseListOfComponentValues as e,isWhitespaceNode as t,isCommentNode as r,isTokenNode as n,isFunctionNode as s,stringify as o,parseCommaSeparatedListOfComponentValues as i}from"@csstools/css-parser-algorithms";import{tokenize as a,TokenType as l}from"@csstools/css-tokenizer";import p from"path";import u from"module";import c from"fs/promises";import d from"@csstools/postcss-rebase-url";function isWarning(e){return"warning"===e.type}function isCharsetStatement(e){return"charset"===e.type}function isImportStatement(e){return"import"===e.type}const m=/^data:text\/css(?:;(base64|plain))?,/i,f=/^data:text\/css;base64,/i,h=/^data:text\/css;plain,/i;function isValidDataURL(e){return!!e&&m.test(e)}const g=/^charset$/i,y=/^import$/i,v=/^url$/i,I=/^layer$/i,S=/^supports$/i;function parseAtImport(p){const u=e(a({css:p}));let c="",d="";const m=[],f=[],h=[];e:for(let e=0;e<u.length;e++){const a=u[e];if(t(a)||r(a))continue;if(n(a)&&(a.value[0]===l.String||a.value[0]===l.URL)){if(c)return!1;c=a.value[4].value,d=a.value[1];continue}if(s(a)&&v.test(a.getName())){if(c)return!1;for(let e=0;e<a.value.length;e++){const s=a.value[e];if(!t(s)&&!r(s)){if(n(s)&&s.value[0]===l.String){c=s.value[4].value,d=o([[a]]);continue e}return!1}}}if(n(a)&&a.value[0]===l.Ident&&I.test(a.value[4].value)){if(m.length>0||h.length>0)return!1;m.push("");continue}if(s(a)&&I.test(a.getName())){if(m.length>0||h.length>0)return!1;m.push(o([trim(a.value)]));continue}if(s(a)&&S.test(a.getName())){if(h.length>0)return!1;h.push(o([trim(a.value)]));continue}const p=trim(u.slice(e)).flatMap((e=>e.tokens())),g=i(p).map((e=>o([trim(e)])));f.push(...g);break}return c=stripHash(c),!!c&&{uri:c,fullUri:d,layer:m,media:f,supports:h}}function trim(e){let n=0,s=e.length;for(let s=0;s<e.length;s++){const o=e[s];if(!t(o)&&!r(o)){n=s;break}}for(let n=e.length-1;n>=0;n--){const o=e[n];if(!t(o)&&!r(o)){s=n+1;break}}return e.slice(n,s)}function stripHash(e){if(e.startsWith("#"))return"";try{const t=new URL(e,"http://example.com");return t.hash?e.slice(0,e.length-t.hash.length):e}catch{return e}}function parseStatements(e,t,r,n,s){const o=[];if("document"===t.type)return t.each((t=>{o.push(...parseStatements(e,t,r,n,s))})),o;let i=[];return t.each((t=>{let a;"atrule"===t.type&&(y.test(t.name)?a=parseImport(e,t,r,n,s):g.test(t.name)&&(a=parseCharset(e,t,r,n,s))),a?(i.length&&(o.push({type:"nodes",nodes:i,conditions:[...n],from:s,importingNode:r}),i=[]),o.push(a)):i.push(t)})),i.length&&o.push({type:"nodes",nodes:i,conditions:[...n],from:s,importingNode:r}),o}function parseCharset(e,t,r,n,s){return t.prev()?e.warn("@charset must precede all other statements",{node:t}):{type:"charset",node:t,conditions:[...n],from:s,importingNode:r}}function parseImport(e,t,r,n,s){let o=t.prev();for(;o;)if("comment"!==o.type){if("atrule"!==o.type||!y.test(o.name))break;o=o.prev()}else o=o.prev();for(;o;)if("comment"!==o.type)if("atrule"===o.type&&g.test(o.name))o=o.prev();else{if("atrule"!==o.type||!I.test(o.name)||o.nodes)return e.warn("@import must precede all other statements (besides @charset or empty @layer)",{node:t});o=o.prev()}else o=o.prev();if(t.nodes)return e.warn("It looks like you didn't end your @import statement correctly. Child nodes are attached to it.",{node:t});const i={type:"import",uri:"",fullUri:"",node:t,conditions:[...n],from:s,importingNode:r},a=parseAtImport(t.params);if(!a)return e.warn(`Invalid @import statement in '${t.toString()}'`,{node:t});const{layer:l,media:p,supports:u,uri:c,fullUri:d}=a;return i.uri=c,i.fullUri=d,(p.length>0||l.length>0||u.length>0)&&i.conditions.push({layer:l,media:p,supports:u}),i}function resolveId(e,t,r,n){let s="";if(r.startsWith("node_modules:"))try{s=t.resolve(r.slice(13))}catch(t){throw e.error(`Failed to find '${r}'`)}else s=p.resolve(n,r);return s}function createRequire(e,t){var r;let n;if(null==(r=e.source)||null==(r=r.input)||!r.file)return t.warn("The current PostCSS AST Node is lacking a source file reference. This is most likely a bug in a PostCSS plugin.",{node:e}),[];n=e.source.input.file;const s=p.dirname(n);return[u.createRequire(s),n,s]}async function loadContent(e){return isValidDataURL(e)?(t=e,f.test(t)?Buffer.from(t.slice(21),"base64").toString():h.test(t)?decodeURIComponent(t.slice(20)):decodeURIComponent(t.slice(14))):c.readFile(e,"utf-8");var t}const noopPlugin=()=>({postcssPlugin:"noop-plugin",Once(){}});async function parseStyles(e,t,r,n,s,o){const i=parseStatements(e,t,r,n,s);{let t,r,n;const s=[];for(const a of i)isImportStatement(a)&&isProcessableURL(a.uri)&&(t&&r&&n||([t,r,n]=createRequire(a.node,e),t&&r&&n))&&s.push(resolveImportId(e,a,o,t,r,n));await Promise.all(s)}let a=null;const l=[],p=[];return i.forEach((e=>{isCharsetStatement(e)?a=handleCharset(e,a):isImportStatement(e)?e.children?e.children.forEach((e=>{isImportStatement(e)?l.push(e):isCharsetStatement(e)?a=handleCharset(e,a):p.push(e)})):l.push(e):"nodes"===e.type&&p.push(e)})),a?[a,...l.concat(p)]:l.concat(p)}async function resolveImportId(e,t,r,n,s,o){if(isValidDataURL(t.uri))return void(t.children=await loadImportContent(e,t,t.uri,r));if(isValidDataURL(t.from[t.from.length-1]))return t.children=[],void e.warn(`Unable to import '${t.uri}' from a stylesheet that is embedded in a data url`,{node:t.node});const i=resolveId(t.node,n,t.uri,o);e.messages.push({type:"dependency",plugin:"postcss-bundler",file:i,parent:s});const a=await loadImportContent(e,t,i,r);t.children=a??[]}async function loadImportContent(e,t,r,n){var s,o;const{conditions:i,from:a,node:l}=t;if(a.includes(r))return;let p;try{p=await loadContent(r)}catch{throw l.error(`Failed to find '${t.uri}'`)}const u=await n([noopPlugin()]).process(p,{from:r,parser:(null==(s=e.opts.syntax)?void 0:s.parse)??e.opts.parser??void 0}),c=u.root;return e.messages=e.messages.concat(u.messages),"atrule"===(null==(o=c.first)?void 0:o.type)&&g.test(c.first.name)?c.first.after(n.comment({text:`${t.uri}`,source:l.source})):c.prepend(n.comment({text:`${t.uri}`,source:l.source})),parseStyles(e,c,l,i,[...a,r],n)}function isProcessableURL(e){if(/^(?:[a-z]+:)?\/\//i.test(e))return!1;try{if(new URL(e,"https://example.com").search)return!1}catch{}return!0}function handleCharset(e,t=null){if(!t)return e;var r,n;if(e.node.params.toLowerCase()!==t.node.params.toLowerCase())throw e.node.error(`Incompatible @charset statements:\n  ${e.node.params} specified in ${null==(r=e.node.source)?void 0:r.input.file}\n  ${t.node.params} specified in ${null==(n=t.node.source)?void 0:n.input.file}`);return t}function formatImportPrelude(e,t,r){const n=[];if(e.length){const t=e.join(".");let r="layer";t&&(r=`layer(${t})`),n.push(r)}return 1===r.length?n.push(`supports(${r[0]})`):r.length>0&&n.push(`supports(${r.map((e=>`(${e})`)).join(" and ")})`),t.length&&n.push(t.join(", ")),n.join(" ")}function applyConditions(e,t){e.forEach(((r,n)=>{if(isWarning(r))return;if(!r.conditions.length||isCharsetStatement(r))return;if(isImportStatement(r)){if(1===r.conditions.length)r.node.params=`${r.fullUri} ${formatImportPrelude(r.conditions[0].layer,r.conditions[0].media,r.conditions[0].supports)}`;else if(r.conditions.length>1){const e=r.conditions.slice().reverse(),t=e.pop();let n=`${r.fullUri} ${formatImportPrelude(t.layer,t.media,t.supports)}`;for(const t of e)n=`'data:text/css;base64,${Buffer.from(`@import ${n}`).toString("base64")}' ${formatImportPrelude(t.layer,t.media,t.supports)}`;r.node.params=n}return}const{nodes:s}=r;if(!s.length)return;const{parent:o}=s[0];if(!o)return;const i=[];for(const e of r.conditions){if(e.media.length>0){var a;const n=t({name:"media",params:e.media.join(", "),source:(null==(a=r.importingNode)?void 0:a.source)??o.source});i.push(n)}if(e.supports.length>0){var l;const n=t({name:"supports",params:1===e.supports.length?`(${e.supports[0]})`:e.supports.map((e=>`(${e})`)).join(" and "),source:(null==(l=r.importingNode)?void 0:l.source)??o.source});i.push(n)}if(e.layer.length>0){var p;const n=t({name:"layer",params:e.layer.join("."),source:(null==(p=r.importingNode)?void 0:p.source)??o.source});i.push(n)}}const u=i[0];if(!u)return;for(let e=0;e<i.length-1;e++)i[e].append(i[e+1]);const c=i[i.length-1];o.insertBefore(s[0],u),s.forEach((e=>{e.parent=void 0})),s[0].raws.before=s[0].raws.before||"\n",c.append(s),e[n]={type:"nodes",nodes:[u],conditions:r.conditions,from:r.from,importingNode:r.importingNode}}))}function applyStyles(e,t){t.nodes=[],e.forEach((e=>{isCharsetStatement(e)||isImportStatement(e)?(e.node.parent=void 0,t.append(e.node)):"nodes"===e.type&&e.nodes.forEach((e=>{e.parent=void 0,t.append(e)}))}))}noopPlugin.postcss=!0;const creator$1=()=>({postcssPlugin:"postcss-bundler",async Once(e,{result:t,atRule:r,postcss:n}){const s=await parseStyles(t,e,null,[],[],n);applyConditions(s,r),applyStyles(s,e)}});creator$1.postcss=!0;const creator=()=>({postcssPlugin:"postcss-bundler",plugins:[creator$1(),d()]});creator.postcss=!0;export{creator as default};
